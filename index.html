<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏™‡∏≠‡∏ô‡πÅ‡∏ó‡∏ô V.3.0 (Cloud & Report)</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&family=Kanit:wght@300;400;500;600;700&display=swap');

        /* --- Base Style from V.2.3 --- */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Kanit', sans-serif;
            background: linear-gradient(135deg, #1e293b 0%, #334155 25%, #475569 50%, #64748b 75%, #94a3b8 100%);
            min-height: 100vh;
            padding: 20px;
            color: #1f2937;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 24px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
            overflow: hidden;
            min-height: 80vh;
        }

        .header {
            background: linear-gradient(135deg, rgba(30, 64, 175, 0.9) 0%, rgba(79, 70, 229, 0.9) 50%, rgba(124, 58, 237, 0.9) 100%);
            color: white; padding: 30px; text-align: center; border-bottom: 2px solid rgba(255, 255, 255, 0.2);
        }
        .header h1 { font-size: 2.2rem; font-weight: 600; text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3); margin-bottom: 5px; }

        /* --- Nav Menu (New) --- */
        .nav-menu { display: flex; justify-content: center; gap: 15px; margin-bottom: 20px; padding-top: 20px;}
        .nav-btn { background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3); padding: 10px 20px; border-radius: 30px; cursor: pointer; transition: 0.3s; font-family: 'Kanit'; font-size: 1rem; backdrop-filter: blur(5px); }
        .nav-btn.active, .nav-btn:hover { background: #4f46e5; border-color: #4f46e5; box-shadow: 0 0 15px rgba(79, 70, 229, 0.4); }

        .page-section { display: none; padding: 30px; }
        .page-section.active { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- Inputs --- */
        .input-group { margin-bottom: 20px; }
        .input-group label { display: block; margin-bottom: 8px; font-weight: 500; color: #1f2937; }
        select { width: 100%; padding: 14px; border-radius: 12px; border: 1px solid #ccc; font-family: 'Kanit'; font-size: 1rem; }

        /* --- Teacher Selection (Checkboxes from V.2.3) --- */
        .selected-teachers-display { padding: 10px; background: rgba(255,255,255,0.9); border: 1px solid #ddd; border-radius: 12px; min-height: 45px; display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 10px; }
        .teacher-tag { background: linear-gradient(135deg, #3b82f6, #6366f1); color: white; padding: 4px 10px; border-radius: 20px; font-size: 0.85rem; display: flex; align-items: center; gap: 6px; }
        .teacher-checkboxes { background: white; border: 1px solid #ddd; border-radius: 12px; max-height: 250px; overflow-y: auto; }
        .teacher-checkbox-item { padding: 10px 15px; border-bottom: 1px solid #eee; display: flex; align-items: center; gap: 10px; cursor: pointer; }
        .teacher-checkbox-item:hover { background: #f8fafc; }
        .teacher-checkbox-item input { width: 18px; height: 18px; accent-color: #3b82f6; }

        /* --- Results & Radio Selection (New) --- */
        .sub-card { background: white; border-radius: 15px; padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); border-left: 5px solid #ef4444; }
        .period-row { display: flex; align-items: flex-start; padding: 15px; border-bottom: 1px solid #f1f5f9; gap: 15px; flex-wrap: wrap; }
        .period-badge { background: #3b82f6; color: white; padding: 6px 12px; border-radius: 8px; font-weight: bold; min-width: 80px; text-align: center; }
        
        .teacher-option { display: flex; align-items: center; gap: 10px; padding: 10px; border: 2px solid #e2e8f0; border-radius: 10px; cursor: pointer; transition: 0.2s; margin-bottom: 5px; width: 100%; background: #f8fafc; }
        .teacher-option:hover { border-color: #06b6d4; background: #fff; }
        .teacher-option.selected { border-color: #4f46e5; background: #eef2ff; }
        .teacher-option input[type="radio"] { width: 18px; height: 18px; accent-color: #4f46e5; }

        /* --- Buttons --- */
        .process-btn { background: linear-gradient(135deg, #059669 0%, #047857 100%); color: white; padding: 15px; border: none; border-radius: 12px; font-size: 1.1rem; width: 100%; cursor: pointer; box-shadow: 0 5px 15px rgba(5, 150, 105, 0.3); font-family: 'Kanit'; transition: 0.3s; }
        .process-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(5, 150, 105, 0.4); }
        
        .save-btn { background: #2563eb; color: white; padding: 12px 25px; border: none; border-radius: 10px; cursor: pointer; font-size: 1rem; font-family: 'Kanit'; display: flex; align-items: center; gap: 8px; margin-top: 20px; float: right; }
        .save-btn:hover { background: #1d4ed8; }

        /* --- Dashboard --- */
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 20px; }
        .stat-card { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }

        /* --- Print CSS --- */
        @media print {
            body * { visibility: hidden; }
            #printArea, #printArea * { visibility: visible; }
            #printArea { position: absolute; left: 0; top: 0; width: 100%; padding: 40px; background: white; color: black; font-family: 'Sarabun', sans-serif !important; }
            .no-print { display: none !important; }
            table { width: 100%; border-collapse: collapse; margin-bottom: 20px; font-size: 14pt; }
            th, td { border: 1px solid black; padding: 10px; text-align: left; }
            th { background-color: #f3f3f3 !important; text-align: center; }
            .signature-box { margin-top: 60px; display: flex; justify-content: space-between; page-break-inside: avoid; }
            .sign-spot { text-align: center; width: 40%; }
            h2, h3, p { color: black !important; text-shadow: none !important; }
        }
    </style>
</head>
<body>

    <div class="nav-menu no-print">
        <button class="nav-btn active" id="btnAlloc"><i class="fas fa-calendar-check"></i> ‡∏à‡∏±‡∏î‡∏™‡∏≠‡∏ô‡πÅ‡∏ó‡∏ô</button>
        <button class="nav-btn" id="btnDash"><i class="fas fa-chart-pie"></i> ‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î (Cloud)</button>
    </div>

    <div class="container">
        
        <div id="allocation" class="page-section active">
            <div class="header" style="border-radius: 15px;">
                <h1>‡∏£‡∏∞‡∏ö‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏à‡∏±‡∏î‡∏™‡∏≠‡∏ô‡πÅ‡∏ó‡∏ô V.3.0</h1>
                <p class="subtitle">Cloud Database & Print Report System</p>
                <p class="developer-credit">‡∏û‡∏±‡∏í‡∏ô‡∏≤‡πÇ‡∏î‡∏¢ ‡∏Ñ‡∏£‡∏π‡∏ô‡∏ô‡∏ó‡∏û‡∏±‡∏ó‡∏ò‡πå ‡∏´‡∏¥‡∏£‡∏±‡∏ç‡πÄ‡∏£‡∏∑‡∏≠‡∏á</p>
            </div>

            <div style="margin-top: 20px; background: rgba(255,255,255,0.8); padding: 25px; border-radius: 15px;">
                <div class="input-group">
                    <label>üìÖ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô (‡∏à.-‡∏®.)</label>
                    <select id="daySelect">
                        <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô --</option>
                        <option value="‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå">‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå</option>
                        <option value="‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£">‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£</option>
                        <option value="‡∏û‡∏∏‡∏ò">‡∏û‡∏∏‡∏ò</option>
                        <option value="‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ">‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ</option>
                        <option value="‡∏®‡∏∏‡∏Å‡∏£‡πå">‡∏®‡∏∏‡∏Å‡∏£‡πå</option>
                    </select>
                </div>

                <div class="input-group">
                    <label>ü§ï ‡∏Ñ‡∏£‡∏π‡∏ó‡∏µ‡πà‡∏•‡∏≤/‡πÑ‡∏õ‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£ (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 6 ‡∏Ñ‡∏ô)</label>
                    <div class="selected-teachers-display" id="selectedTeachersDisplay">
                        <div style="color: rgba(0, 0, 0, 0.5);">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏£‡∏π</div>
                    </div>
                    <div class="teacher-checkboxes" id="teacherCheckboxes">
                        </div>
                </div>

                <button class="process-btn" id="btnProcess">
                    üîç ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÅ‡∏•‡∏∞‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡∏™‡∏≠‡∏ô‡πÅ‡∏ó‡∏ô
                </button>
            </div>

            <div id="resultArea" style="margin-top: 30px; display: none;">
                <h2 style="color: #374151; margin-bottom: 20px;"><i class="fas fa-clipboard-list"></i> ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏£‡∏π‡∏™‡∏≠‡∏ô‡πÅ‡∏ó‡∏ô</h2>
                <form id="substitutionForm">
                    <div id="substitutionCards"></div>
                </form>
                
                <div style="overflow: hidden; padding-bottom: 20px;">
                    <button class="save-btn" id="btnSavePrint">
                        <i class="fas fa-save"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô
                    </button>
                </div>
            </div>
        </div>

        <div id="dashboard" class="page-section">
            <div class="header" style="border-radius: 15px; background: linear-gradient(135deg, #059669 0%, #10b981 100%);">
                <h1>üìä ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏à‡∏≤‡∏Å‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Cloud)</h1>
                <p>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Real-time ‡∏à‡∏≤‡∏Å Firebase</p>
            </div>

            <div class="dashboard-grid">
                <div class="stat-card">
                    <h3>‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏£‡∏≤‡∏¢‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏≤‡∏£‡∏∞‡∏Ø (‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏≤‡∏ö)</h3>
                    <canvas id="deptChart"></canvas>
                </div>
                <div class="stat-card">
                    <h3>Top 5 ‡∏Ñ‡∏£‡∏π‡∏™‡∏≠‡∏ô‡πÅ‡∏ó‡∏ô (‡∏†‡∏≤‡∏£‡∏∞‡∏á‡∏≤‡∏ô)</h3>
                    <canvas id="teacherChart"></canvas>
                </div>
            </div>
            <div style="text-align: center; margin-top: 20px;">
                <button class="nav-btn" id="btnRefresh" style="background: #059669;">üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
            </div>
        </div>

    </div>

    <div id="printArea" style="display: none;"></div>

    <script type="module">
        // ------------------------------------------------------------------
        // 1. FIREBASE SETUP
        // ------------------------------------------------------------------
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCF7qDDxp6NXk3y7wLiySasqoviGyCKNNw",
            authDomain: "sornthan-fc0f1.firebaseapp.com",
            projectId: "sornthan-fc0f1",
            storageBucket: "sornthan-fc0f1.firebasestorage.app",
            messagingSenderId: "915683105444",
            appId: "1:915683105444:web:c1add040ea1afb344ae431"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // ------------------------------------------------------------------
        // 2. TEACHERS DATA (FROM V.2.3)
        // ------------------------------------------------------------------
        const teachersData = [
            { name: "‡∏ô‡∏≤‡∏¢‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤ ‡πÉ‡∏´‡∏°‡πà‡∏Ñ‡∏≤‡∏°‡∏¥", department: "5. ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏≤‡∏£‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡∏™‡∏±‡∏á‡∏Ñ‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤ ‡∏®‡∏≤‡∏™‡∏ô‡∏≤‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏í‡∏ô‡∏ò‡∏£‡∏£‡∏°", schedule: { "‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå": [1, 5, 6, 7], "‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£": [3, 5, 6], "‡∏û‡∏∏‡∏ò": [1, 2, 3, 5, 6], "‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ": [1, 3, 4, 5, 6], "‡∏®‡∏∏‡∏Å‡∏£‡πå": [2, 4, 7] } },
            { name: "‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß‡∏ì‡∏¥‡∏ä‡∏≤‡∏£‡∏µ‡∏¢‡πå ‡∏Ñ‡∏≥‡∏®‡∏£‡∏µ‡∏ó‡∏≤", department: "2. ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏≤‡∏£‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡πÅ‡∏•‡∏∞‡πÄ‡∏ó‡∏Ñ‡πÇ‡∏ô‡πÇ‡∏•‡∏¢‡∏µ", schedule: { "‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå": [2, 4], "‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£": [3, 4, 6], "‡∏û‡∏∏‡∏ò": [3, 4, 5, 6], "‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ": [5, 6], "‡∏®‡∏∏‡∏Å‡∏£‡πå": [4, 5, 6] } },
            { name: "‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß‡∏Å‡∏≤‡∏ô‡∏ï‡πå‡∏°‡∏ì‡∏µ ‡πÅ‡∏Å‡πâ‡∏ß‡∏û‡∏ß‡∏á", department: "2. ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏≤‡∏£‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡πÅ‡∏•‡∏∞‡πÄ‡∏ó‡∏Ñ‡πÇ‡∏ô‡πÇ‡∏•‡∏¢‡∏µ", schedule: { "‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå": [1, 2, 3, 4, 6], "‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£": [1, 2, 4], "‡∏û‡∏∏‡∏ò": [], "‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ": [5], "‡∏®‡∏∏‡∏Å‡∏£‡πå": [1, 2] } },
            { name: "‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß‡∏¢‡∏∏‡∏û‡∏≤ ‡∏ó‡∏≠‡∏á‡∏Ñ‡∏≥", department: "2. ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏≤‡∏£‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡πÅ‡∏•‡∏∞‡πÄ‡∏ó‡∏Ñ‡πÇ‡∏ô‡πÇ‡∏•‡∏¢‡∏µ", schedule: { "‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå": [3, 4, 5, 7], "‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£": [5], "‡∏û‡∏∏‡∏ò": [1, 2], "‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ": [1, 2, 3, 4], "‡∏®‡∏∏‡∏Å‡∏£‡πå": [2, 3, 5, 6, 7] } },
            { name: "‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß‡∏£‡∏±‡∏ï‡∏ô‡∏≤ ‡∏™‡∏µ‡∏ü‡πâ‡∏≤", department: "1. ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏≤‡∏£‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå", schedule: { "‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå": [2, 5], "‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£": [2, 3, 4, 5], "‡∏û‡∏∏‡∏ò": [2, 4, 5], "‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ": [1, 2, 3], "‡∏®‡∏∏‡∏Å‡∏£‡πå": [1, 2, 4, 5] } },
            { name: "‡∏ô‡∏≤‡∏¢‡∏ò‡∏ô‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå ‡∏û‡∏£‡∏´‡∏°‡∏ó‡∏≠‡∏á", department: "5. ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏≤‡∏£‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡∏™‡∏±‡∏á‡∏Ñ‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤ ‡∏®‡∏≤‡∏™‡∏ô‡∏≤‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏í‡∏ô‡∏ò‡∏£‡∏£‡∏°", schedule: { "‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå": [3, 6, 7], "‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£": [4, 6], "‡∏û‡∏∏‡∏ò": [2, 3, 4, 5, 6], "‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ": [4, 6], "‡∏®‡∏∏‡∏Å‡∏£‡πå": [4, 5, 6, 7] } },
            { name: "‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß‡∏ß‡∏¥‡πÑ‡∏•‡∏à‡∏¥‡∏ï‡∏£ ‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå‡πÅ‡∏à‡πâ‡∏á", department: "4. ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏≤‡∏£‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡∏†‡∏≤‡∏©‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®", schedule: { "‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå": [1, 5, 7], "‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£": [1, 4, 5], "‡∏û‡∏∏‡∏ò": [1, 3, 4, 5, 6], "‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ": [1, 5, 6], "‡∏®‡∏∏‡∏Å‡∏£‡πå": [3, 6, 7] } },
            { name: "‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß‡∏™‡∏∏‡∏û‡∏±‡∏í‡∏ï‡∏≤ ‡∏®‡∏£‡∏µ‡πÄ‡∏°‡∏∑‡∏≠‡∏á", department: "1. ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏≤‡∏£‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå", schedule: { "‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå": [1, 4, 6], "‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£": [2, 3, 4], "‡∏û‡∏∏‡∏ò": [1, 3, 4, 5, 6], "‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ": [3, 4], "‡∏®‡∏∏‡∏Å‡∏£‡πå": [1, 2, 3, 4] } },
            { name: "‡∏ô‡∏≤‡∏¢‡πÄ‡∏î‡∏ä‡∏≤ ‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏à‡∏£‡∏¥‡∏ç", department: "2. ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏≤‡∏£‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡πÅ‡∏•‡∏∞‡πÄ‡∏ó‡∏Ñ‡πÇ‡∏ô‡πÇ‡∏•‡∏¢‡∏µ", schedule: { "‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå": [3, 4], "‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£": [2, 3, 4, 5], "‡∏û‡∏∏‡∏ò": [1, 2, 3, 4], "‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ": [1, 2, 3, 4], "‡∏®‡∏∏‡∏Å‡∏£‡πå": [1] } },
            { name: "‡∏ô‡∏≤‡∏¢‡∏≠‡∏≤‡∏à‡∏´‡∏≤‡∏ç ‡∏ß‡∏¥‡∏£‡∏¥‡∏¢‡πÇ‡∏Å‡∏®‡∏•", department: "6. ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏≤‡∏£‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡∏™‡∏∏‡∏Ç‡∏®‡∏∂‡∏Å‡∏©‡∏≤ ‡∏û‡∏•‡∏®‡∏∂‡∏Å‡∏©‡∏≤", schedule: { "‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå": [3, 4, 5, 6, 7], "‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£": [2, 3, 4, 5, 6], "‡∏û‡∏∏‡∏ò": [4], "‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ": [2, 5, 6], "‡∏®‡∏∏‡∏Å‡∏£‡πå": [4] } },
            { name: "‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß‡∏õ‡∏£‡∏¥‡∏°‡∏õ‡∏†‡∏≤‡∏û‡∏£ ‡∏ö‡∏≤‡∏≠‡∏¥‡∏ô‡∏ó‡∏£‡πå", department: "4. ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏≤‡∏£‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡∏†‡∏≤‡∏©‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®", schedule: { "‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå": [1], "‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£": [3, 4, 5, 6], "‡∏û‡∏∏‡∏ò": [1, 6], "‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ": [1, 4, 5, 6], "‡∏®‡∏∏‡∏Å‡∏£‡πå": [3] } },
            { name: "‡∏ô‡∏≤‡∏¢‡πÑ‡∏Å‡∏£‡∏™‡∏£ ‡∏à‡∏±‡∏ô‡∏ó‡∏ß‡∏µ", department: "7. ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏≤‡∏£‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡∏®‡∏¥‡∏•‡∏õ‡∏®‡∏∂‡∏Å‡∏©‡∏≤", schedule: { "‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå": [1, 2, 4], "‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£": [2, 3, 4, 6], "‡∏û‡∏∏‡∏ò": [3, 4, 5, 6], "‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ": [2, 3, 5], "‡∏®‡∏∏‡∏Å‡∏£‡πå": [1, 2, 4, 5, 6, 7] } },
            { name: "‡∏ô‡∏≤‡∏¢‡∏ï‡πâ‡∏ô‡∏Å‡∏•‡πâ‡∏≤ ‡πÄ‡∏û‡∏ä‡∏£‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô", department: "8. ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏≤‡∏£‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô‡∏≠‡∏≤‡∏ä‡∏µ‡∏û", schedule: { "‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå": [2, 3, 4], "‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£": [3, 4], "‡∏û‡∏∏‡∏ò": [3, 4, 5, 6], "‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ": [], "‡∏®‡∏∏‡∏Å‡∏£‡πå": [4] } },
            { name: "‡∏ô‡∏≤‡∏¢‡∏ô‡∏ô‡∏ó‡∏û‡∏±‡∏ó‡∏ò‡πå ‡∏´‡∏¥‡∏£‡∏±‡∏ç‡πÄ‡∏£‡∏∑‡∏≠‡∏á", department: "3. ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏≤‡∏£‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢", schedule: { "‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå": [2, 4, 5, 6], "‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£": [2, 3], "‡∏û‡∏∏‡∏ò": [2, 3, 5, 6], "‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ": [2, 6], "‡∏®‡∏∏‡∏Å‡∏£‡πå": [1, 3, 4] } }
        ];

        // ------------------------------------------------------------------
        // 3. UI & LOGIC
        // ------------------------------------------------------------------
        let selectedTeachers = [];
        const MAX_SELECTION = 6;
        let chartDeptInstance = null;
        let chartTeacherInstance = null;

        // Expose functions to window because of module scope
        window.toggleTeacherSelection = toggleTeacherSelection;
        window.removeTeacher = removeTeacher;

        // Event Listeners
        document.getElementById('btnAlloc').onclick = () => switchTab('allocation');
        document.getElementById('btnDash').onclick = () => switchTab('dashboard');
        document.getElementById('btnProcess').onclick = processSubstitution;
        document.getElementById('btnSavePrint').onclick = confirmAndPrint;
        document.getElementById('btnRefresh').onclick = renderDashboard;

        loadTeachers();

        function switchTab(tabId) {
            document.querySelectorAll('.page-section').forEach(el => el.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            
            document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));
            if(tabId === 'allocation') document.getElementById('btnAlloc').classList.add('active');
            if(tabId === 'dashboard') {
                document.getElementById('btnDash').classList.add('active');
                renderDashboard();
            }
        }

        // --- Teacher Selection Logic (From V.2.3) ---
        function loadTeachers() {
            const checkboxContainer = document.getElementById('teacherCheckboxes');
            checkboxContainer.innerHTML = '';
            teachersData.forEach((teacher, index) => {
                const item = document.createElement('div');
                item.className = 'teacher-checkbox-item';
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `teacher-${index}`;
                checkbox.value = teacher.name;
                checkbox.onchange = () => toggleTeacherSelection(teacher.name, checkbox);
                
                const label = document.createElement('label');
                label.htmlFor = `teacher-${index}`;
                label.textContent = teacher.name;
                
                item.appendChild(checkbox);
                item.appendChild(label);
                checkboxContainer.appendChild(item);
            });
        }

        function toggleTeacherSelection(teacherName, checkbox) {
            const index = selectedTeachers.indexOf(teacherName);
            if (index === -1) {
                if (selectedTeachers.length >= MAX_SELECTION) {
                    checkbox.checked = false;
                    alert('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 6 ‡∏Ñ‡∏ô');
                    return;
                }
                selectedTeachers.push(teacherName);
            } else {
                selectedTeachers.splice(index, 1);
            }
            updateSelectedDisplay();
        }

        function removeTeacher(teacherName) {
            const index = selectedTeachers.indexOf(teacherName);
            if (index !== -1) {
                selectedTeachers.splice(index, 1);
                updateSelectedDisplay();
                const checkboxes = document.querySelectorAll('input[type="checkbox"]');
                checkboxes.forEach(cb => {
                    if (cb.value === teacherName) cb.checked = false;
                });
            }
        }

        function updateSelectedDisplay() {
            const display = document.getElementById('selectedTeachersDisplay');
            if (selectedTeachers.length === 0) {
                display.innerHTML = '<div style="color: rgba(0, 0, 0, 0.5);">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏£‡∏π</div>';
            } else {
                const tagsHtml = selectedTeachers.map(teacher => 
                    `<div class="teacher-tag">${teacher} <button onclick="removeTeacher('${teacher}')" style="background:none;border:none;color:white;cursor:pointer;margin-left:5px;">√ó</button></div>`
                ).join('');
                display.innerHTML = tagsHtml;
            }
        }

        // --- Processing Logic (Modified for Radio Selection) ---
        function processSubstitution() {
            const day = document.getElementById('daySelect').value;
            if(!day || selectedTeachers.length === 0) {
                Swal.fire('‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡∏Ñ‡∏£‡∏π‡∏ó‡∏µ‡πà‡∏•‡∏≤', 'warning');
                return;
            }

            const container = document.getElementById('substitutionCards');
            container.innerHTML = '';
            
            selectedTeachers.forEach(absentName => {
                const absentTeacher = teachersData.find(t => t.name === absentName);
                const absentPeriods = absentTeacher.schedule[day] || [];
                
                if(absentPeriods.length === 0) return;

                let html = `<div class="sub-card">
                    <h3 style="color:#dc2626; margin-bottom:15px; border-bottom:1px solid #eee; padding-bottom:10px;">
                        <i class="fas fa-user-injured"></i> ${absentName} (‡∏•‡∏≤)
                    </h3>`;

                absentPeriods.sort((a,b)=>a-b).forEach(period => {
                    const available = findAvailableTeachers(day, period, selectedTeachers);
                    
                    html += `<div class="period-row">
                        <div class="period-badge">‡∏Ñ‡∏≤‡∏ö‡∏ó‡∏µ‡πà ${period}</div>
                        <div style="flex-grow:1;">`;
                        
                    if(available.length === 0) {
                        html += `<div style="color:red; font-weight:bold;">‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏£‡∏π‡∏ß‡πà‡∏≤‡∏á‡πÉ‡∏ô‡∏Ñ‡∏≤‡∏ö‡∏ô‡∏µ‡πâ</div>`;
                    } else {
                        available.forEach(t => {
                            // Unique ID for Radio
                            const safeName = absentName.replace(/\s+/g, '');
                            const safeSub = t.name.replace(/\s+/g, '');
                            const inputId = `p_${safeName}_${period}_${safeSub}`;
                            const inputName = `sub_${safeName}_${period}`; 
                            
                            // Highlight recommended (Same Dept)
                            const isRec = t.department === absentTeacher.department;
                            
                            html += `
                                <label class="teacher-option" onclick="this.querySelector('input').checked=true; updateRadioStyle(this)">
                                    <input type="radio" name="${inputName}" id="${inputId}" value="${t.name}" data-dept="${t.department}">
                                    <div style="margin-left:8px;">
                                        <strong>${t.name}</strong> 
                                        <div style="font-size:0.8rem; color:#666;">${getShortDept(t.department)}</div>
                                        ${isRec ? '<span style="color:green; font-size:0.75rem; font-weight:bold;">(‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏≤‡∏£‡∏∞‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô)</span>' : ''}
                                    </div>
                                </label>
                            `;
                        });
                    }
                    html += `</div></div>`;
                });
                html += `</div>`;
                container.innerHTML += html;
            });

            // Make result visible
            document.getElementById('resultArea').style.display = 'block';
            setTimeout(() => document.getElementById('resultArea').scrollIntoView({behavior: 'smooth'}), 100);
        }

        // Helper for Radio Style
        window.updateRadioStyle = function(label) {
            const allLabels = label.parentElement.querySelectorAll('.teacher-option');
            allLabels.forEach(l => l.classList.remove('selected'));
            label.classList.add('selected');
        }

        function findAvailableTeachers(day, period, excludeNames) {
            return teachersData
                .filter(t => !excludeNames.includes(t.name))
                .filter(t => !(t.schedule[day] || []).includes(period))
                .map(t => {
                    let score = 0;
                    // Mock Score Logic
                    return { ...t, score };
                })
                .sort((a, b) => b.score - a.score) // Random sort based on score
                .slice(0, 5);
        }

        function getShortDept(fullDept) {
            if(fullDept.includes('.')) return fullDept.split('.')[1].trim();
            return fullDept;
        }

        // --- Save & Print ---
        async function confirmAndPrint() {
            const dataToSave = [];
            const day = document.getElementById('daySelect').value;

            // Gather Data from Radios
            const cards = document.querySelectorAll('.sub-card');
            cards.forEach(card => {
                const absentHeader = card.querySelector('h3').innerText;
                const absentName = absentHeader.split(' (')[0].trim();

                const rows = card.querySelectorAll('.period-row');
                rows.forEach(row => {
                    const periodText = row.querySelector('.period-badge').innerText;
                    const period = periodText.replace('‡∏Ñ‡∏≤‡∏ö‡∏ó‡∏µ‡πà ', '');
                    
                    const selectedInput = row.querySelector('input[type="radio"]:checked');
                    if(selectedInput) {
                        dataToSave.push({
                            absent_teacher: absentName,
                            sub_teacher: selectedInput.value,
                            period: parseInt(period),
                            department: selectedInput.dataset.dept,
                            date_day: day
                        });
                    }
                });
            });

            if(dataToSave.length === 0) {
                Swal.fire('‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡∏™‡∏≠‡∏ô‡πÅ‡∏ó‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏ó‡πà‡∏≤‡∏ô', 'warning');
                return;
            }

            Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...', didOpen: () => Swal.showLoading() });

            try {
                // Save to Firestore
                await addDoc(collection(db, "substitutions"), {
                    created_at: serverTimestamp(),
                    day: day,
                    records: dataToSave
                });

                Swal.close();
                // Generate & Print
                generatePrintView(day, dataToSave);
                window.print();

            } catch (e) {
                console.error(e);
                Swal.fire('Error', e.message, 'error');
            }
        }

        function generatePrintView(day, data) {
            const printDiv = document.getElementById('printArea');
            // Group by Sub Teacher to make it cleaner? Or just simple list. Let's do simple list first.
            let printHTML = `
                <div style="text-align:center; margin-bottom:20px;">
                    <h2 style="margin:0;">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏™‡∏≠‡∏ô‡πÅ‡∏ó‡∏ô</h2>
                    <p style="margin:5px;">‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô.......................................................</p>
                    <p>‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô ${day} ‡∏ó‡∏µ‡πà ...... ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ............. ‡∏û.‡∏®. .......</p>
                </div>
                <h3>‡∏™‡∏£‡∏∏‡∏õ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏à‡∏±‡∏î‡∏™‡∏≠‡∏ô‡πÅ‡∏ó‡∏ô</h3>
                <table>
                    <thead>
                        <tr>
                            <th style="width:10%;">‡∏Ñ‡∏≤‡∏ö‡∏ó‡∏µ‡πà</th>
                            <th style="width:30%;">‡∏Ñ‡∏£‡∏π‡∏ó‡∏µ‡πà‡∏•‡∏≤</th>
                            <th style="width:30%;">‡∏Ñ‡∏£‡∏π‡∏ú‡∏π‡πâ‡∏™‡∏≠‡∏ô‡πÅ‡∏ó‡∏ô</th>
                            <th style="width:30%;">‡∏•‡∏á‡∏ô‡∏≤‡∏°‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏≤‡∏ö</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            data.sort((a,b) => a.period - b.period);
            data.forEach(item => {
                printHTML += `
                    <tr>
                        <td style="text-align:center;">${item.period}</td>
                        <td>${item.absent_teacher}</td>
                        <td>${item.sub_teacher}</td>
                        <td></td>
                    </tr>
                `;
            });

            printHTML += `</tbody></table>
                <div class="signature-box">
                    <div class="sign-spot"><p>‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠ ....................................... ‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏ó‡∏≥</p><p>(‡∏Ñ‡∏£‡∏π‡∏ô‡∏ô‡∏ó‡∏û‡∏±‡∏ó‡∏ò‡πå ‡∏´‡∏¥‡∏£‡∏±‡∏ç‡πÄ‡∏£‡∏∑‡∏≠‡∏á)</p></div>
                    <div class="sign-spot"><p>‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠ ....................................... ‡∏ú‡∏π‡πâ‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Å‡∏≤‡∏£</p><p>(.......................................)</p></div>
                </div>`;
            
            printDiv.innerHTML = printHTML;
        }

        // --- Dashboard Logic ---
        async function renderDashboard() {
            try {
                const q = query(collection(db, "substitutions"), orderBy("created_at", "desc"));
                const querySnapshot = await getDocs(q);
                
                let deptStats = {};
                let teacherStats = {};

                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    (data.records || []).forEach(rec => {
                        const dept = getShortDept(rec.department || '‡∏≠‡∏∑‡πà‡∏ô‡πÜ');
                        deptStats[dept] = (deptStats[dept] || 0) + 1;

                        const tName = rec.sub_teacher;
                        teacherStats[tName] = (teacherStats[tName] || 0) + 1;
                    });
                });

                updateDeptChart(deptStats);
                updateTeacherChart(teacherStats);

            } catch (error) {
                console.error("Dash Error:", error);
            }
        }

        function updateDeptChart(dataObj) {
            const ctx = document.getElementById('deptChart').getContext('2d');
            if(chartDeptInstance) chartDeptInstance.destroy();
            chartDeptInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(dataObj),
                    datasets: [{ data: Object.values(dataObj), backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF'] }]
                }
            });
        }

        function updateTeacherChart(dataObj) {
            const sorted = Object.entries(dataObj).sort((a, b) => b[1] - a[1]).slice(0, 5);
            const ctx = document.getElementById('teacherChart').getContext('2d');
            if(chartTeacherInstance) chartTeacherInstance.destroy();
            chartTeacherInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sorted.map(i => i[0]),
                    datasets: [{ label: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏≤‡∏ö', data: sorted.map(i => i[1]), backgroundColor: '#36A2EB' }]
                }
            });
        }
    </script>
</body>
</html>
