<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏™‡∏≠‡∏ô‡πÅ‡∏ó‡∏ô V.4.0 (Official Report)</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

    <style>
        /* Import Font: Sarabun (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£) ‡πÅ‡∏•‡∏∞ Kanit (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö) */
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&family=Kanit:wght@300;400;500;600;700&display=swap');

        /* --- Global Styles --- */
        :root { --primary: #1e40af; --bg-gradient: linear-gradient(135deg, #f0f9ff 0%, #cbebff 100%); }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Kanit', sans-serif; background: var(--bg-gradient); min-height: 100vh; padding: 20px; color: #334155; }

        /* --- App Container --- */
        .app-container { max-width: 1200px; margin: 0 auto; background: white; border-radius: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.1); overflow: hidden; min-height: 80vh; }
        .header { background: linear-gradient(90deg, #1e3a8a, #3b82f6); padding: 25px; color: white; text-align: center; }
        .header h1 { font-size: 1.8rem; margin-bottom: 5px; }

        /* --- Navigation --- */
        .nav-bar { display: flex; justify-content: center; gap: 10px; padding: 15px; background: #f8fafc; border-bottom: 1px solid #e2e8f0; }
        .nav-btn { padding: 10px 20px; border: none; background: white; border-radius: 50px; cursor: pointer; color: #64748b; font-family: 'Kanit'; transition: 0.2s; border: 1px solid #e2e8f0; font-weight: 500; }
        .nav-btn.active, .nav-btn:hover { background: #1e40af; color: white; border-color: #1e40af; box-shadow: 0 4px 12px rgba(30, 64, 175, 0.2); }

        /* --- Content Sections --- */
        .page-section { display: none; padding: 30px; animation: fadeIn 0.4s ease; }
        .page-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- Forms --- */
        .control-panel { background: #f1f5f9; padding: 25px; border-radius: 15px; margin-bottom: 30px; }
        select { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #cbd5e1; font-family: 'Kanit'; font-size: 1rem; margin-top: 5px; }
        label { font-weight: 600; color: #475569; }

        /* --- Checkboxes & Radio --- */
        .teacher-checkboxes { background: white; border: 1px solid #cbd5e1; border-radius: 10px; padding: 15px; max-height: 200px; overflow-y: auto; display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px; margin-top: 5px; }
        .checkbox-item { display: flex; align-items: center; gap: 8px; font-size: 0.95rem; }
        .selected-list { margin-top: 10px; min-height: 30px; display: flex; flex-wrap: wrap; gap: 8px; }
        .tag { background: #e0f2fe; color: #0369a1; padding: 4px 12px; border-radius: 20px; font-size: 0.85rem; display: flex; align-items: center; gap: 6px; }

        /* --- Match Cards --- */
        .match-card { background: white; border: 1px solid #e2e8f0; border-radius: 12px; margin-bottom: 20px; overflow: hidden; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }
        .match-header { background: #fef2f2; padding: 15px; color: #991b1b; font-weight: bold; border-left: 5px solid #ef4444; display: flex; justify-content: space-between; align-items: center; }
        .period-row { display: flex; padding: 15px; border-bottom: 1px solid #f1f5f9; align-items: flex-start; gap: 15px; }
        .period-badge { background: #3b82f6; color: white; padding: 5px 12px; border-radius: 6px; font-weight: bold; min-width: 70px; text-align: center; }
        .teacher-option { width: 100%; display: flex; align-items: center; gap: 12px; padding: 10px; border: 1px solid #e2e8f0; border-radius: 8px; margin-bottom: 5px; cursor: pointer; transition: 0.2s; }
        .teacher-option:hover { background: #f8fafc; border-color: #94a3b8; }
        .teacher-option.selected { background: #eff6ff; border-color: #2563eb; ring: 1px solid #2563eb; }
        .sub-dept { font-size: 0.8rem; color: #64748b; }
        .schedule-hint { font-size: 0.75rem; color: #dc2626; margin-top: 2px; }

        /* --- Buttons --- */
        .btn-main { width: 100%; padding: 15px; background: #0f766e; color: white; border: none; border-radius: 10px; font-size: 1.1rem; cursor: pointer; font-family: 'Kanit'; transition: 0.2s; margin-top: 20px; }
        .btn-main:hover { background: #0d9488; }
        .btn-print { float: right; background: #2563eb; color: white; padding: 12px 25px; border: none; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 8px; }

        /* --- MODAL (PREVIEW) STYLE --- */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); backdrop-filter: blur(5px); }
        .modal-content { background-color: #525659; margin: 2% auto; padding: 0; width: 210mm; height: 95vh; overflow-y: auto; border-radius: 5px; position: relative; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .paper-preview { background: white; width: 210mm; min-height: 297mm; margin: 20px auto; padding: 25mm 20mm; box-shadow: 0 0 15px rgba(0,0,0,0.3); font-family: 'Sarabun', sans-serif; position: relative; }
        .modal-actions { position: sticky; top: 0; background: #323639; padding: 15px; display: flex; justify-content: flex-end; gap: 10px; z-index: 100; color: white; align-items: center; }

        /* --- OFFICIAL DOCUMENT STYLE (A4) --- */
        .doc-header { text-align: center; margin-bottom: 25px; position: relative; }
        .doc-garuda { width: 60px; height: auto; margin-bottom: 10px; } /* Placeholder for Garuda */
        .doc-title { font-size: 29pt; font-weight: bold; margin-bottom: 0px; line-height: 1; }
        .doc-meta { font-size: 16pt; margin-bottom: 10px; line-height: 1.4; }
        .doc-meta b { font-weight: bold; }
        .doc-subject { margin-top: 10px; }
        .doc-table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 16pt; }
        .doc-table th { border: 1px solid black; padding: 8px; text-align: center; background-color: #f0f0f0; font-weight: bold; }
        .doc-table td { border: 1px solid black; padding: 8px; vertical-align: top; }
        .doc-signature { margin-top: 60px; display: flex; justify-content: space-between; font-size: 16pt; }
        .sign-block { text-align: center; width: 45%; }
        .dotted-line { border-bottom: 1px dotted black; display: inline-block; width: 180px; margin: 0 5px; }
        
        /* --- PRINT MEDIA QUERY (CRITICAL FOR BLANK PAGE FIX) --- */
        @media print {
            body { background: white; padding: 0; margin: 0; }
            .app-container, .modal-actions { display: none !important; }
            .modal { position: static; background: white; width: 100%; height: auto; display: block !important; overflow: visible; }
            .modal-content { margin: 0; width: 100%; box-shadow: none; background: white; height: auto; overflow: visible; }
            .paper-preview { margin: 0; box-shadow: none; padding: 0; width: 100%; }
            /* Force show content inside modal */
            #previewContent { display: block !important; }
        }
    </style>
</head>
<body>

    <div class="app-container">
        <div class="header">
            <h1>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏™‡∏≠‡∏ô‡πÅ‡∏ó‡∏ô V.4.0</h1>
            <p style="opacity: 0.8; font-size: 0.9rem;">Official Document Edition</p>
        </div>

        <div class="nav-bar">
            <button class="nav-btn active" onclick="switchTab('allocation')"><i class="fas fa-edit"></i> ‡∏à‡∏±‡∏î‡∏™‡∏≠‡∏ô‡πÅ‡∏ó‡∏ô</button>
            <button class="nav-btn" onclick="switchTab('history')"><i class="fas fa-history"></i> ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</button>
        </div>

        <div id="allocation" class="page-section active">
            <div class="control-panel">
                <div style="margin-bottom: 15px;">
                    <label><i class="far fa-calendar-alt"></i> ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏≠‡∏ô)</label>
                    <select id="daySelect">
                        <option value="">-- ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô --</option>
                        <option value="‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå">‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå</option>
                        <option value="‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£">‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£</option>
                        <option value="‡∏û‡∏∏‡∏ò">‡∏û‡∏∏‡∏ò</option>
                        <option value="‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ">‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ</option>
                        <option value="‡∏®‡∏∏‡∏Å‡∏£‡πå">‡∏®‡∏∏‡∏Å‡∏£‡πå</option>
                    </select>
                </div>
                
                <div>
                    <label><i class="fas fa-user-minus"></i> ‡∏Ñ‡∏£‡∏π‡∏ó‡∏µ‡πà‡∏•‡∏≤/‡πÑ‡∏õ‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£</label>
                    <div class="selected-list" id="selectedDisplay"></div>
                    <div class="teacher-checkboxes" id="teacherList"></div>
                </div>

                <button class="btn-main" onclick="processData()">
                    <i class="fas fa-search"></i> ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÅ‡∏•‡∏∞‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà
                </button>
            </div>

            <div id="resultSection" style="display: none;">
                <h3 style="margin-bottom: 15px; color: #334155;">‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡∏™‡∏≠‡∏ô‡πÅ‡∏ó‡∏ô</h3>
                <div id="matchContainer"></div>
                <div style="margin-top: 20px; overflow: hidden;">
                    <button class="btn-print" onclick="openPreviewModal()">
                        <i class="fas fa-print"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô
                    </button>
                </div>
            </div>
        </div>

        <div id="history" class="page-section">
            <h3 style="margin-bottom: 15px;">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</h3>
            <button onclick="loadHistory()" style="padding: 5px 10px; cursor: pointer;">üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>
            <div id="historyList" style="margin-top: 15px;"></div>
        </div>
    </div>

    <div id="previewModal" class="modal">
        <div class="modal-content">
            <div class="modal-actions">
                <span style="margin-right: auto; font-size: 0.9rem;">‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Å‡πà‡∏≠‡∏ô‡∏û‡∏¥‡∏°‡∏û‡πå (A4)</span>
                <button onclick="window.print()" style="background:#22c55e; color:white; border:none; padding:8px 15px; border-radius:4px; cursor:pointer;">üñ®Ô∏è ‡∏™‡∏±‡πà‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå</button>
                <button onclick="closeModal()" style="background:#ef4444; color:white; border:none; padding:8px 15px; border-radius:4px; cursor:pointer;">‡∏õ‡∏¥‡∏î</button>
            </div>
            
            <div class="paper-preview" id="paperContent">
                </div>
        </div>
    </div>

    <script>
        // --- CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyCF7qDDxp6NXk3y7wLiySasqoviGyCKNNw",
            authDomain: "sornthan-fc0f1.firebaseapp.com",
            projectId: "sornthan-fc0f1",
            storageBucket: "sornthan-fc0f1.firebasestorage.app",
            messagingSenderId: "915683105444",
            appId: "1:915683105444:web:c1add040ea1afb344ae431"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // --- DATA (V.2.3) ---
        const teachersData = [
            { name: "‡∏ô‡∏≤‡∏¢‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤ ‡πÉ‡∏´‡∏°‡πà‡∏Ñ‡∏≤‡∏°‡∏¥", department: "‡∏™‡∏±‡∏á‡∏Ñ‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏Ø", schedule: { "‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå": [1, 5, 6, 7], "‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£": [3, 5, 6], "‡∏û‡∏∏‡∏ò": [1, 2, 3, 5, 6], "‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ": [1, 3, 4, 5, 6], "‡∏®‡∏∏‡∏Å‡∏£‡πå": [2, 4, 7] } },
            { name: "‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß‡∏ì‡∏¥‡∏ä‡∏≤‡∏£‡∏µ‡∏¢‡πå ‡∏Ñ‡∏≥‡∏®‡∏£‡∏µ‡∏ó‡∏≤", department: "‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡∏Ø", schedule: { "‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå": [2, 4], "‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£": [3, 4, 6], "‡∏û‡∏∏‡∏ò": [3, 4, 5, 6], "‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ": [5, 6], "‡∏®‡∏∏‡∏Å‡∏£‡πå": [4, 5, 6] } },
            { name: "‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß‡∏Å‡∏≤‡∏ô‡∏ï‡πå‡∏°‡∏ì‡∏µ ‡πÅ‡∏Å‡πâ‡∏ß‡∏û‡∏ß‡∏á", department: "‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡∏Ø", schedule: { "‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå": [1, 2, 3, 4, 6], "‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£": [1, 2, 4], "‡∏û‡∏∏‡∏ò": [], "‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ": [5], "‡∏®‡∏∏‡∏Å‡∏£‡πå": [1, 2] } },
            { name: "‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß‡∏¢‡∏∏‡∏û‡∏≤ ‡∏ó‡∏≠‡∏á‡∏Ñ‡∏≥", department: "‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡∏Ø", schedule: { "‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå": [3, 4, 5, 7], "‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£": [5], "‡∏û‡∏∏‡∏ò": [1, 2], "‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ": [1, 2, 3, 4], "‡∏®‡∏∏‡∏Å‡∏£‡πå": [2, 3, 5, 6, 7] } },
            { name: "‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß‡∏£‡∏±‡∏ï‡∏ô‡∏≤ ‡∏™‡∏µ‡∏ü‡πâ‡∏≤", department: "‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå", schedule: { "‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå": [2, 5], "‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£": [2, 3, 4, 5], "‡∏û‡∏∏‡∏ò": [2, 4, 5], "‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ": [1, 2, 3], "‡∏®‡∏∏‡∏Å‡∏£‡πå": [1, 2, 4, 5] } },
            { name: "‡∏ô‡∏≤‡∏¢‡∏ò‡∏ô‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå ‡∏û‡∏£‡∏´‡∏°‡∏ó‡∏≠‡∏á", department: "‡∏™‡∏±‡∏á‡∏Ñ‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏Ø", schedule: { "‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå": [3, 6, 7], "‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£": [4, 6], "‡∏û‡∏∏‡∏ò": [2, 3, 4, 5, 6], "‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ": [4, 6], "‡∏®‡∏∏‡∏Å‡∏£‡πå": [4, 5, 6, 7] } },
            { name: "‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß‡∏ß‡∏¥‡πÑ‡∏•‡∏à‡∏¥‡∏ï‡∏£ ‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå‡πÅ‡∏à‡πâ‡∏á", department: "‡∏†‡∏≤‡∏©‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®", schedule: { "‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå": [1, 5, 7], "‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£": [1, 4, 5], "‡∏û‡∏∏‡∏ò": [1, 3, 4, 5, 6], "‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ": [1, 5, 6], "‡∏®‡∏∏‡∏Å‡∏£‡πå": [3, 6, 7] } },
            { name: "‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß‡∏™‡∏∏‡∏û‡∏±‡∏í‡∏ï‡∏≤ ‡∏®‡∏£‡∏µ‡πÄ‡∏°‡∏∑‡∏≠‡∏á", department: "‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå", schedule: { "‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå": [1, 4, 6], "‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£": [2, 3, 4], "‡∏û‡∏∏‡∏ò": [1, 3, 4, 5, 6], "‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ": [3, 4], "‡∏®‡∏∏‡∏Å‡∏£‡πå": [1, 2, 3, 4] } },
            { name: "‡∏ô‡∏≤‡∏¢‡πÄ‡∏î‡∏ä‡∏≤ ‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏à‡∏£‡∏¥‡∏ç", department: "‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡∏Ø", schedule: { "‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå": [3, 4], "‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£": [2, 3, 4, 5], "‡∏û‡∏∏‡∏ò": [1, 2, 3, 4], "‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ": [1, 2, 3, 4], "‡∏®‡∏∏‡∏Å‡∏£‡πå": [1] } },
            { name: "‡∏ô‡∏≤‡∏¢‡∏≠‡∏≤‡∏à‡∏´‡∏≤‡∏ç ‡∏ß‡∏¥‡∏£‡∏¥‡∏¢‡πÇ‡∏Å‡∏®‡∏•", department: "‡∏™‡∏∏‡∏Ç‡∏®‡∏∂‡∏Å‡∏©‡∏≤ ‡∏û‡∏•‡∏®‡∏∂‡∏Å‡∏©‡∏≤", schedule: { "‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå": [3, 4, 5, 6, 7], "‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£": [2, 3, 4, 5, 6], "‡∏û‡∏∏‡∏ò": [4], "‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ": [2, 5, 6], "‡∏®‡∏∏‡∏Å‡∏£‡πå": [4] } },
            { name: "‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß‡∏õ‡∏£‡∏¥‡∏°‡∏õ‡∏†‡∏≤‡∏û‡∏£ ‡∏ö‡∏≤‡∏≠‡∏¥‡∏ô‡∏ó‡∏£‡πå", department: "‡∏†‡∏≤‡∏©‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®", schedule: { "‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå": [1], "‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£": [3, 4, 5, 6], "‡∏û‡∏∏‡∏ò": [1, 6], "‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ": [1, 4, 5, 6], "‡∏®‡∏∏‡∏Å‡∏£‡πå": [3] } },
            { name: "‡∏ô‡∏≤‡∏¢‡πÑ‡∏Å‡∏£‡∏™‡∏£ ‡∏à‡∏±‡∏ô‡∏ó‡∏ß‡∏µ", department: "‡∏®‡∏¥‡∏•‡∏õ‡∏®‡∏∂‡∏Å‡∏©‡∏≤", schedule: { "‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå": [1, 2, 4], "‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£": [2, 3, 4, 6], "‡∏û‡∏∏‡∏ò": [3, 4, 5, 6], "‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ": [2, 3, 5], "‡∏®‡∏∏‡∏Å‡∏£‡πå": [1, 2, 4, 5, 6, 7] } },
            { name: "‡∏ô‡∏≤‡∏¢‡∏ï‡πâ‡∏ô‡∏Å‡∏•‡πâ‡∏≤ ‡πÄ‡∏û‡∏ä‡∏£‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô", department: "‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô‡∏≠‡∏≤‡∏ä‡∏µ‡∏û", schedule: { "‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå": [2, 3, 4], "‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£": [3, 4], "‡∏û‡∏∏‡∏ò": [3, 4, 5, 6], "‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ": [], "‡∏®‡∏∏‡∏Å‡∏£‡πå": [4] } },
            { name: "‡∏ô‡∏≤‡∏¢‡∏ô‡∏ô‡∏ó‡∏û‡∏±‡∏ó‡∏ò‡πå ‡∏´‡∏¥‡∏£‡∏±‡∏ç‡πÄ‡∏£‡∏∑‡∏≠‡∏á", department: "‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢", schedule: { "‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå": [2, 4, 5, 6], "‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£": [2, 3], "‡∏û‡∏∏‡∏ò": [2, 3, 5, 6], "‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ": [2, 6], "‡∏®‡∏∏‡∏Å‡∏£‡πå": [1, 3, 4] } }
        ];

        // --- STATE ---
        let selectedTeachers = [];
        let currentDay = '';

        // --- INIT ---
        window.onload = () => {
            renderTeacherList();
        };

        function switchTab(id) {
            document.querySelectorAll('.page-section').forEach(el => el.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            event.currentTarget.classList.add('active');
            if(id === 'history') loadHistory();
        }

        // --- CORE LOGIC ---
        function renderTeacherList() {
            const list = document.getElementById('teacherList');
            list.innerHTML = '';
            teachersData.forEach((t, i) => {
                const div = document.createElement('div');
                div.className = 'checkbox-item';
                div.innerHTML = `
                    <input type="checkbox" id="t_${i}" value="${t.name}" onchange="toggleSelect('${t.name}', this)">
                    <label for="t_${i}" style="font-weight:normal; cursor:pointer;">${t.name}</label>
                `;
                list.appendChild(div);
            });
        }

        function toggleSelect(name, cb) {
            if(cb.checked) {
                if(selectedTeachers.length >= 6) {
                    cb.checked = false;
                    Swal.fire('‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏à‡∏≥‡∏ô‡∏ß‡∏ô', '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏£‡∏π‡∏•‡∏≤‡πÑ‡∏î‡πâ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 6 ‡∏ó‡πà‡∏≤‡∏ô', 'warning');
                    return;
                }
                selectedTeachers.push(name);
            } else {
                selectedTeachers = selectedTeachers.filter(t => t !== name);
            }
            renderSelectedTags();
        }

        function renderSelectedTags() {
            const container = document.getElementById('selectedDisplay');
            container.innerHTML = selectedTeachers.map(name => `
                <div class="tag">${name}</div>
            `).join('');
        }

        function processData() {
            currentDay = document.getElementById('daySelect').value;
            if(!currentDay || selectedTeachers.length === 0) {
                Swal.fire('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡∏Ñ‡∏£‡∏π‡∏ó‡∏µ‡πà‡∏•‡∏≤', 'warning');
                return;
            }

            const container = document.getElementById('matchContainer');
            container.innerHTML = '';

            selectedTeachers.forEach(absentName => {
                const absentTeacher = teachersData.find(t => t.name === absentName);
                const absentPeriods = absentTeacher.schedule[currentDay] || [];
                
                if(absentPeriods.length === 0) return;

                let html = `<div class="match-card">
                    <div class="match-header">
                        <span><i class="fas fa-user-times"></i> ${absentName}</span>
                        <span style="font-size:0.9rem; opacity:0.8;">‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢/‡∏Å‡∏¥‡∏à</span>
                    </div>`;

                absentPeriods.sort((a,b)=>a-b).forEach(period => {
                    const candidates = findCandidates(currentDay, period, selectedTeachers);
                    
                    html += `<div class="period-row">
                        <div class="period-badge">‡∏Ñ‡∏≤‡∏ö ${period}</div>
                        <div style="flex-grow:1;">`;

                    if(candidates.length === 0) {
                        html += `<div style="color:#ef4444; font-size:0.9rem;">‚ùå ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏£‡∏π‡∏ß‡πà‡∏≤‡∏á‡πÉ‡∏ô‡∏Ñ‡∏≤‡∏ö‡∏ô‡∏µ‡πâ</div>`;
                    } else {
                        candidates.forEach(t => {
                            const inputName = `sub_${absentName.replace(/\s/g,'')}_${period}`;
                            const isSameDept = t.department === absentTeacher.department;
                            
                            // Check schedule to show warning
                            const teacherSched = t.schedule[currentDay] || [];
                            const hasClass = teacherSched.length > 0;
                            const schedText = hasClass ? `‡∏™‡∏≠‡∏ô‡∏Ñ‡∏≤‡∏ö: ${teacherSched.join(', ')}` : `‡∏ß‡πà‡∏≤‡∏á‡∏ï‡∏•‡∏≠‡∏î‡∏ß‡∏±‡∏ô`;
                            
                            html += `
                                <label class="teacher-option" onclick="selectRadio(this)">
                                    <input type="radio" name="${inputName}" value="${t.name}" data-dept="${t.department}">
                                    <div>
                                        <div style="font-weight:600; font-size:0.95rem;">${t.name} ${isSameDept ? '‚≠ê' : ''}</div>
                                        <div class="sub-dept">${t.department} | ${schedText}</div>
                                    </div>
                                </label>
                            `;
                        });
                    }
                    html += `</div></div>`;
                });
                html += `</div>`;
                container.innerHTML += html;
            });

            document.getElementById('resultSection').style.display = 'block';
            setTimeout(() => document.getElementById('resultSection').scrollIntoView({behavior:'smooth'}), 100);
        }

        function findCandidates(day, period, exclude) {
            return teachersData
                .filter(t => !exclude.includes(t.name) && !(t.schedule[day] || []).includes(period))
                .sort((a,b) => (a.schedule[day]||[]).length - (b.schedule[day]||[]).length) // Sort by lightest load
                .slice(0, 5);
        }

        function selectRadio(label) {
            label.parentElement.querySelectorAll('.teacher-option').forEach(el => el.classList.remove('selected'));
            label.classList.add('selected');
            label.querySelector('input').checked = true;
        }

        // --- PREVIEW & PRINT LOGIC ---
        function openPreviewModal() {
            // 1. Gather Data
            const dataToPrint = [];
            const cards = document.querySelectorAll('.match-card');
            
            cards.forEach(card => {
                const absentName = card.querySelector('.match-header span').innerText.trim();
                card.querySelectorAll('.period-row').forEach(row => {
                    const period = row.querySelector('.period-badge').innerText.replace('‡∏Ñ‡∏≤‡∏ö ','');
                    const checked = row.querySelector('input:checked');
                    if(checked) {
                        dataToPrint.push({
                            absent: absentName,
                            period: period,
                            sub: checked.value,
                            dept: checked.dataset.dept
                        });
                    }
                });
            });

            if(dataToPrint.length === 0) {
                Swal.fire('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡∏™‡∏≠‡∏ô‡πÅ‡∏ó‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£', 'warning');
                return;
            }

            // 2. Generate Official HTML
            const date = new Date();
            const thaiDate = `${date.getDate()} ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ${getThaiMonth(date.getMonth())} ‡∏û.‡∏®. ${date.getFullYear() + 543}`;
            
            // Sort data
            dataToPrint.sort((a,b) => parseInt(a.period) - parseInt(b.period));

            let tableRows = '';
            dataToPrint.forEach(item => {
                tableRows += `
                    <tr>
                        <td style="text-align:center;">${item.period}</td>
                        <td>${item.absent}</td>
                        <td>${item.sub} (${item.dept})</td>
                        <td></td>
                    </tr>
                `;
            });

            const html = `
                <div class="doc-header">
                     <div style="font-size:20pt; font-weight:bold;">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°</div>
                </div>
                <div class="doc-meta">
                    <b>‡∏™‡πà‡∏ß‡∏ô‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£</b> ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏ß‡∏¥‡∏ä‡∏≤‡∏Å‡∏≤‡∏£ ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô...........................................................................<br>
                    <b>‡∏ó‡∏µ‡πà</b> .................................................. <b>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</b> ${thaiDate}<br>
                    <b>‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á</b> ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Ñ‡∏£‡∏π‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏≠‡∏ô‡πÅ‡∏ó‡∏ô ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô${currentDay}
                </div>
                <div style="border-bottom: 1px solid black; margin-bottom: 15px;"></div>
                <div class="doc-meta">
                    <b>‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</b> ‡∏ú‡∏π‡πâ‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô....................................................
                </div>
                <p style="font-size:16pt; text-indent: 2.5cm; margin-top:5px;">
                    ‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏ß‡∏¥‡∏ä‡∏≤‡∏Å‡∏≤‡∏£ ‡πÑ‡∏î‡πâ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Ñ‡∏£‡∏π‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏≠‡∏ô‡πÅ‡∏ó‡∏ô‡∏Ñ‡∏£‡∏π‡∏ó‡∏µ‡πà‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢/‡∏•‡∏≤‡∏Å‡∏¥‡∏à/‡πÑ‡∏õ‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£ ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô${currentDay} ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ô‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡πÑ‡∏õ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á ‡∏î‡∏±‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏ô‡∏µ‡πâ
                </p>
                
                <table class="doc-table">
                    <thead>
                        <tr>
                            <th style="width:10%;">‡∏Ñ‡∏≤‡∏ö‡∏ó‡∏µ‡πà</th>
                            <th style="width:30%;">‡∏Ñ‡∏£‡∏π‡∏ó‡∏µ‡πà‡∏•‡∏≤</th>
                            <th style="width:35%;">‡∏Ñ‡∏£‡∏π‡∏ú‡∏π‡πâ‡∏™‡∏≠‡∏ô‡πÅ‡∏ó‡∏ô</th>
                            <th style="width:25%;">‡∏•‡∏á‡∏ô‡∏≤‡∏°‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏≤‡∏ö</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${tableRows}
                    </tbody>
                </table>

                <div class="doc-signature">
                    <div class="sign-block">
                        <br><br>
                        ‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠.......................................................‡∏ú‡∏π‡πâ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô<br>
                        (‡∏Ñ‡∏£‡∏π‡∏ô‡∏ô‡∏ó‡∏û‡∏±‡∏ó‡∏ò‡πå ‡∏´‡∏¥‡∏£‡∏±‡∏ç‡πÄ‡∏£‡∏∑‡∏≠‡∏á)<br>
                        ‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏≠‡∏ô‡πÅ‡∏ó‡∏ô
                    </div>
                    <div class="sign-block">
                        <br>
                        ‡∏ó‡∏£‡∏≤‡∏ö<br><br>
                        ‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠.......................................................<br>
                        (.......................................................)<br>
                        ‡∏ú‡∏π‡πâ‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
                    </div>
                </div>
            `;

            // 3. Inject to Modal & Show
            document.getElementById('paperContent').innerHTML = html;
            document.getElementById('previewModal').style.display = 'block';

            // 4. Save to Firebase implicitly
            saveToFirebase(dataToPrint);
        }

        function closeModal() {
            document.getElementById('previewModal').style.display = 'none';
        }

        function saveToFirebase(data) {
            db.collection("substitutions").add({
                created_at: firebase.firestore.FieldValue.serverTimestamp(),
                day: currentDay,
                records: data
            }).then(() => {
                console.log("Auto-saved to Firestore");
            });
        }

        function getThaiMonth(monthIndex) {
            const months = ["‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°", "‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå", "‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°", "‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô", "‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°", "‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô", "‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°", "‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°", "‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô", "‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°", "‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô", "‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°"];
            return months[monthIndex];
        }

        // --- HISTORY ---
        function loadHistory() {
            const list = document.getElementById('historyList');
            list.innerHTML = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...';
            db.collection("substitutions").orderBy("created_at", "desc").limit(10).get().then(snap => {
                if(snap.empty) {
                    list.innerHTML = '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥'; return;
                }
                list.innerHTML = '';
                snap.forEach(doc => {
                    const data = doc.data();
                    const div = document.createElement('div');
                    div.style.background = '#f8fafc';
                    div.style.padding = '15px';
                    div.style.marginBottom = '10px';
                    div.style.borderRadius = '8px';
                    div.style.border = '1px solid #e2e8f0';
                    div.innerHTML = `
                        <strong>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${data.day}</strong> <span style="font-size:0.85rem; color:#64748b;">(‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏°‡∏∑‡πà‡∏≠: ${new Date(data.created_at.seconds * 1000).toLocaleString('th-TH')})</span>
                        <div style="margin-top:5px; font-size:0.9rem;">
                            ${data.records.map(r => `‡∏Ñ‡∏≤‡∏ö ${r.period}: ${r.sub} (‡πÅ‡∏ó‡∏ô ${r.absent})`).join('<br>')}
                        </div>
                    `;
                    list.appendChild(div);
                });
            });
        }
    </script>
</body>
</html>
