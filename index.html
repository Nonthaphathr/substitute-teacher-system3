<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏™‡∏≠‡∏ô‡πÅ‡∏ó‡∏ô V.3.5 (Offline Compatible)</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&family=Kanit:wght@300;400;500;600;700&display=swap');

        /* --- Base Style --- */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Kanit', sans-serif; background: linear-gradient(135deg, #1e293b 0%, #334155 25%, #475569 50%, #64748b 75%, #94a3b8 100%); min-height: 100vh; padding: 20px; color: #1f2937; }
        .container { max-width: 1200px; margin: 0 auto; background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(20px); border: 2px solid rgba(255, 255, 255, 0.3); border-radius: 24px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15); overflow: hidden; min-height: 80vh; }
        .header { background: linear-gradient(135deg, rgba(30, 64, 175, 0.9) 0%, rgba(79, 70, 229, 0.9) 50%, rgba(124, 58, 237, 0.9) 100%); color: white; padding: 30px; text-align: center; border-bottom: 2px solid rgba(255, 255, 255, 0.2); }
        
        /* --- Nav Menu --- */
        .nav-menu { display: flex; justify-content: center; gap: 15px; margin-bottom: 20px; padding-top: 20px; flex-wrap: wrap;}
        .nav-btn { background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3); padding: 10px 20px; border-radius: 30px; cursor: pointer; transition: 0.3s; font-family: 'Kanit'; backdrop-filter: blur(5px); }
        .nav-btn.active, .nav-btn:hover { background: #4f46e5; border-color: #4f46e5; box-shadow: 0 0 15px rgba(79, 70, 229, 0.4); }
        
        .page-section { display: none; padding: 30px; }
        .page-section.active { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- UI Elements --- */
        .input-group label { display: block; margin-bottom: 8px; font-weight: 500; }
        select { width: 100%; padding: 14px; border-radius: 12px; border: 1px solid #ccc; font-family: 'Kanit'; font-size: 1rem; }
        .selected-teachers-display { padding: 10px; background: rgba(255,255,255,0.9); border: 1px solid #ddd; border-radius: 12px; min-height: 45px; display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 10px; }
        .teacher-tag { background: linear-gradient(135deg, #3b82f6, #6366f1); color: white; padding: 4px 10px; border-radius: 20px; font-size: 0.85rem; display: flex; align-items: center; gap: 6px; }
        .teacher-checkboxes { background: white; border: 1px solid #ddd; border-radius: 12px; max-height: 250px; overflow-y: auto; }
        .teacher-checkbox-item { padding: 10px 15px; border-bottom: 1px solid #eee; display: flex; align-items: center; gap: 10px; cursor: pointer; }
        .sub-card { background: white; border-radius: 15px; padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); border-left: 5px solid #ef4444; }
        .period-row { display: flex; align-items: flex-start; padding: 15px; border-bottom: 1px solid #f1f5f9; gap: 15px; flex-wrap: wrap; }
        .period-badge { background: #3b82f6; color: white; padding: 6px 12px; border-radius: 8px; font-weight: bold; min-width: 80px; text-align: center; }
        .teacher-option { display: flex; align-items: center; gap: 10px; padding: 10px; border: 2px solid #e2e8f0; border-radius: 10px; cursor: pointer; transition: 0.2s; margin-bottom: 5px; width: 100%; background: #f8fafc; }
        .teacher-option:hover { border-color: #06b6d4; background: #fff; }
        .teacher-option.selected { border-color: #4f46e5; background: #eef2ff; }
        .teacher-option input[type="radio"] { width: 18px; height: 18px; accent-color: #4f46e5; }
        .schedule-hint { font-size: 0.8rem; color: #64748b; margin-top: 2px; }
        .process-btn { background: linear-gradient(135deg, #059669 0%, #047857 100%); color: white; padding: 15px; border: none; border-radius: 12px; font-size: 1.1rem; width: 100%; cursor: pointer; font-family: 'Kanit'; transition: 0.3s; }
        .process-btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(5, 150, 105, 0.3); }
        .save-btn { background: #2563eb; color: white; padding: 12px 25px; border: none; border-radius: 10px; cursor: pointer; float: right; display: flex; align-items: center; gap: 8px; font-family: 'Kanit'; }
        .history-table { width: 100%; border-collapse: collapse; margin-top: 15px; background: white; border-radius: 10px; overflow: hidden; }
        .history-table th, .history-table td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #ddd; }
        .history-table th { background-color: #f1f5f9; color: #1f2937; font-weight: 600; }
        .btn-action { padding: 5px 10px; border-radius: 5px; border: none; cursor: pointer; font-family: 'Kanit'; font-size: 0.85rem; margin-right: 5px; }
        .btn-del { background: #fee2e2; color: #dc2626; } .btn-del:hover { background: #fecaca; }
        .btn-print { background: #e0e7ff; color: #4338ca; } .btn-print:hover { background: #c7d2fe; }

        @media print {
            body { background: white !important; color: black !important; -webkit-print-color-adjust: exact; }
            .container { box-shadow: none; border: none; background: white; margin: 0; padding: 0; min-height: auto; }
            .nav-menu, .header, .input-section, .dashboard-grid, .nav-btn, .process-btn, .save-btn, #resultArea, #teacherCheckboxes, #selectedTeachersDisplay, .subtitle, .developer-credit, .page-section:not(#allocation) { display: none !important; }
            #allocation { padding: 0 !important; display: block !important; }
            #allocation > *:not(#printArea) { display: none !important; }
            #printArea { display: block !important; position: absolute; top: 0; left: 0; width: 100%; background: white; font-family: 'Sarabun', sans-serif !important; z-index: 9999; }
            table { width: 100%; border-collapse: collapse; margin-bottom: 20px; font-size: 14pt; color: black; }
            th, td { border: 1px solid black; padding: 10px; text-align: left; color: black; }
            th { background-color: #f3f3f3 !important; text-align: center; font-weight: bold; }
            .signature-box { margin-top: 50px; display: flex; justify-content: space-between; page-break-inside: avoid; }
            .sign-spot { text-align: center; width: 45%; }
            h2, h3, p { color: black !important; margin: 5px 0; }
        }
    </style>
</head>
<body>

    <div class="nav-menu no-print">
        <button class="nav-btn active" id="btnAlloc"><i class="fas fa-calendar-check"></i> ‡∏à‡∏±‡∏î‡∏™‡∏≠‡∏ô‡πÅ‡∏ó‡∏ô</button>
        <button class="nav-btn" id="btnHistory"><i class="fas fa-history"></i> ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥/‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</button>
        <button class="nav-btn" id="btnDash"><i class="fas fa-chart-pie"></i> ‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î</button>
    </div>

    <div class="container">
        
        <div id="allocation" class="page-section active">
            <div class="header" style="border-radius: 15px;">
                <h1>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏™‡∏≠‡∏ô‡πÅ‡∏ó‡∏ô V.3.5</h1>
                <p class="subtitle">Cloud Database & Smart Schedule</p>
                <p class="developer-credit">‡∏û‡∏±‡∏í‡∏ô‡∏≤‡πÇ‡∏î‡∏¢ ‡∏Ñ‡∏£‡∏π‡∏ô‡∏ô‡∏ó‡∏û‡∏±‡∏ó‡∏ò‡πå ‡∏´‡∏¥‡∏£‡∏±‡∏ç‡πÄ‡∏£‡∏∑‡∏≠‡∏á</p>
            </div>

            <div style="margin-top: 20px; background: rgba(255,255,255,0.8); padding: 25px; border-radius: 15px;" class="no-print">
                <div class="input-group">
                    <label>üìÖ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô (‡∏à.-‡∏®.)</label>
                    <select id="daySelect">
                        <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô --</option>
                        <option value="‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå">‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå</option>
                        <option value="‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£">‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£</option>
                        <option value="‡∏û‡∏∏‡∏ò">‡∏û‡∏∏‡∏ò</option>
                        <option value="‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ">‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ</option>
                        <option value="‡∏®‡∏∏‡∏Å‡∏£‡πå">‡∏®‡∏∏‡∏Å‡∏£‡πå</option>
                    </select>
                </div>

                <div class="input-group">
                    <label>ü§ï ‡∏Ñ‡∏£‡∏π‡∏ó‡∏µ‡πà‡∏•‡∏≤/‡πÑ‡∏õ‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£</label>
                    <div class="selected-teachers-display" id="selectedTeachersDisplay">
                        <div style="color: rgba(0, 0, 0, 0.5);">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏£‡∏π</div>
                    </div>
                    <div class="teacher-checkboxes" id="teacherCheckboxes"></div>
                </div>

                <button class="process-btn" id="btnProcess">
                    üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ú‡∏π‡πâ‡∏™‡∏≠‡∏ô‡πÅ‡∏ó‡∏ô
                </button>
            </div>

            <div id="resultArea" style="margin-top: 30px; display: none;" class="no-print">
                <h2 style="color: #374151; margin-bottom: 20px;"><i class="fas fa-clipboard-list"></i> ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏£‡∏π‡∏™‡∏≠‡∏ô‡πÅ‡∏ó‡∏ô</h2>
                <form id="substitutionForm">
                    <div id="substitutionCards"></div>
                </form>
                <div style="overflow: hidden; padding-bottom: 20px;">
                    <button class="save-btn" id="btnSavePrint">
                        <i class="fas fa-save"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡∏û‡∏¥‡∏°‡∏û‡πå
                    </button>
                </div>
            </div>

            <div id="printArea" style="display: none;"></div>
        </div>

        <div id="history" class="page-section">
            <div class="header" style="border-radius: 15px; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
                <h1>üìã ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏™‡∏≠‡∏ô‡πÅ‡∏ó‡∏ô</h1>
                <p>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏•‡∏ö ‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ã‡πâ‡∏≥</p>
            </div>
            <div style="margin-top: 20px; overflow-x: auto;">
                <button class="nav-btn" id="btnRefreshHistory" style="background:#d97706; margin-bottom:10px;">üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>
                <table class="history-table">
                    <thead>
                        <tr>
                            <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                            <th>‡∏Ñ‡∏£‡∏π‡∏ó‡∏µ‡πà‡∏•‡∏≤</th>
                            <th>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</th>
                            <th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                        </tr>
                    </thead>
                    <tbody id="historyTableBody">
                        <tr><td colspan="4" style="text-align:center;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div id="dashboard" class="page-section">
            <div class="header" style="border-radius: 15px; background: linear-gradient(135deg, #059669 0%, #10b981 100%);">
                <h1>üìä ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°</h1>
            </div>
            <div class="dashboard-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 20px;">
                <div class="sub-card">
                    <h3>‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏£‡∏≤‡∏¢‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏≤‡∏£‡∏∞‡∏Ø</h3>
                    <canvas id="deptChart"></canvas>
                </div>
                <div class="sub-card">
                    <h3>Top 5 ‡∏†‡∏≤‡∏£‡∏∞‡∏á‡∏≤‡∏ô‡∏™‡∏≠‡∏ô‡πÅ‡∏ó‡∏ô</h3>
                    <canvas id="teacherChart"></canvas>
                </div>
            </div>
        </div>

    </div>

    <script>
        // --- 1. CONFIG FIREBASE (COMPAT) ---
        const firebaseConfig = {
            apiKey: "AIzaSyCF7qDDxp6NXk3y7wLiySasqoviGyCKNNw",
            authDomain: "sornthan-fc0f1.firebaseapp.com",
            projectId: "sornthan-fc0f1",
            storageBucket: "sornthan-fc0f1.firebasestorage.app",
            messagingSenderId: "915683105444",
            appId: "1:915683105444:web:c1add040ea1afb344ae431"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // --- 2. DATA ---
        const teachersData = [
            { name: "‡∏ô‡∏≤‡∏¢‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤ ‡πÉ‡∏´‡∏°‡πà‡∏Ñ‡∏≤‡∏°‡∏¥", department: "5. ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏≤‡∏£‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡∏™‡∏±‡∏á‡∏Ñ‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤ ‡∏®‡∏≤‡∏™‡∏ô‡∏≤‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏í‡∏ô‡∏ò‡∏£‡∏£‡∏°", schedule: { "‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå": [1, 5, 6, 7], "‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£": [3, 5, 6], "‡∏û‡∏∏‡∏ò": [1, 2, 3, 5, 6], "‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ": [1, 3, 4, 5, 6], "‡∏®‡∏∏‡∏Å‡∏£‡πå": [2, 4, 7] } },
            { name: "‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß‡∏ì‡∏¥‡∏ä‡∏≤‡∏£‡∏µ‡∏¢‡πå ‡∏Ñ‡∏≥‡∏®‡∏£‡∏µ‡∏ó‡∏≤", department: "2. ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏≤‡∏£‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡πÅ‡∏•‡∏∞‡πÄ‡∏ó‡∏Ñ‡πÇ‡∏ô‡πÇ‡∏•‡∏¢‡∏µ", schedule: { "‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå": [2, 4], "‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£": [3, 4, 6], "‡∏û‡∏∏‡∏ò": [3, 4, 5, 6], "‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ": [5, 6], "‡∏®‡∏∏‡∏Å‡∏£‡πå": [4, 5, 6] } },
            { name: "‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß‡∏Å‡∏≤‡∏ô‡∏ï‡πå‡∏°‡∏ì‡∏µ ‡πÅ‡∏Å‡πâ‡∏ß‡∏û‡∏ß‡∏á", department: "2. ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏≤‡∏£‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡πÅ‡∏•‡∏∞‡πÄ‡∏ó‡∏Ñ‡πÇ‡∏ô‡πÇ‡∏•‡∏¢‡∏µ", schedule: { "‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå": [1, 2, 3, 4, 6], "‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£": [1, 2, 4], "‡∏û‡∏∏‡∏ò": [], "‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ": [5], "‡∏®‡∏∏‡∏Å‡∏£‡πå": [1, 2] } },
            { name: "‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß‡∏¢‡∏∏‡∏û‡∏≤ ‡∏ó‡∏≠‡∏á‡∏Ñ‡∏≥", department: "2. ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏≤‡∏£‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡πÅ‡∏•‡∏∞‡πÄ‡∏ó‡∏Ñ‡πÇ‡∏ô‡πÇ‡∏•‡∏¢‡∏µ", schedule: { "‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå": [3, 4, 5, 7], "‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£": [5], "‡∏û‡∏∏‡∏ò": [1, 2], "‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ": [1, 2, 3, 4], "‡∏®‡∏∏‡∏Å‡∏£‡πå": [2, 3, 5, 6, 7] } },
            { name: "‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß‡∏£‡∏±‡∏ï‡∏ô‡∏≤ ‡∏™‡∏µ‡∏ü‡πâ‡∏≤", department: "1. ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏≤‡∏£‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå", schedule: { "‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå": [2, 5], "‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£": [2, 3, 4, 5], "‡∏û‡∏∏‡∏ò": [2, 4, 5], "‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ": [1, 2, 3], "‡∏®‡∏∏‡∏Å‡∏£‡πå": [1, 2, 4, 5] } },
            { name: "‡∏ô‡∏≤‡∏¢‡∏ò‡∏ô‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå ‡∏û‡∏£‡∏´‡∏°‡∏ó‡∏≠‡∏á", department: "5. ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏≤‡∏£‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡∏™‡∏±‡∏á‡∏Ñ‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤ ‡∏®‡∏≤‡∏™‡∏ô‡∏≤‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏í‡∏ô‡∏ò‡∏£‡∏£‡∏°", schedule: { "‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå": [3, 6, 7], "‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£": [4, 6], "‡∏û‡∏∏‡∏ò": [2, 3, 4, 5, 6], "‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ": [4, 6], "‡∏®‡∏∏‡∏Å‡∏£‡πå": [4, 5, 6, 7] } },
            { name: "‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß‡∏ß‡∏¥‡πÑ‡∏•‡∏à‡∏¥‡∏ï‡∏£ ‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå‡πÅ‡∏à‡πâ‡∏á", department: "4. ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏≤‡∏£‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡∏†‡∏≤‡∏©‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®", schedule: { "‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå": [1, 5, 7], "‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£": [1, 4, 5], "‡∏û‡∏∏‡∏ò": [1, 3, 4, 5, 6], "‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ": [1, 5, 6], "‡∏®‡∏∏‡∏Å‡∏£‡πå": [3, 6, 7] } },
            { name: "‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß‡∏™‡∏∏‡∏û‡∏±‡∏í‡∏ï‡∏≤ ‡∏®‡∏£‡∏µ‡πÄ‡∏°‡∏∑‡∏≠‡∏á", department: "1. ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏≤‡∏£‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå", schedule: { "‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå": [1, 4, 6], "‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£": [2, 3, 4], "‡∏û‡∏∏‡∏ò": [1, 3, 4, 5, 6], "‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ": [3, 4], "‡∏®‡∏∏‡∏Å‡∏£‡πå": [1, 2, 3, 4] } },
            { name: "‡∏ô‡∏≤‡∏¢‡πÄ‡∏î‡∏ä‡∏≤ ‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏à‡∏£‡∏¥‡∏ç", department: "2. ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏≤‡∏£‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡πÅ‡∏•‡∏∞‡πÄ‡∏ó‡∏Ñ‡πÇ‡∏ô‡πÇ‡∏•‡∏¢‡∏µ", schedule: { "‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå": [3, 4], "‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£": [2, 3, 4, 5], "‡∏û‡∏∏‡∏ò": [1, 2, 3, 4], "‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ": [1, 2, 3, 4], "‡∏®‡∏∏‡∏Å‡∏£‡πå": [1] } },
            { name: "‡∏ô‡∏≤‡∏¢‡∏≠‡∏≤‡∏à‡∏´‡∏≤‡∏ç ‡∏ß‡∏¥‡∏£‡∏¥‡∏¢‡πÇ‡∏Å‡∏®‡∏•", department: "6. ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏≤‡∏£‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡∏™‡∏∏‡∏Ç‡∏®‡∏∂‡∏Å‡∏©‡∏≤ ‡∏û‡∏•‡∏®‡∏∂‡∏Å‡∏©‡∏≤", schedule: { "‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå": [3, 4, 5, 6, 7], "‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£": [2, 3, 4, 5, 6], "‡∏û‡∏∏‡∏ò": [4], "‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ": [2, 5, 6], "‡∏®‡∏∏‡∏Å‡∏£‡πå": [4] } },
            { name: "‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß‡∏õ‡∏£‡∏¥‡∏°‡∏õ‡∏†‡∏≤‡∏û‡∏£ ‡∏ö‡∏≤‡∏≠‡∏¥‡∏ô‡∏ó‡∏£‡πå", department: "4. ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏≤‡∏£‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡∏†‡∏≤‡∏©‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®", schedule: { "‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå": [1], "‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£": [3, 4, 5, 6], "‡∏û‡∏∏‡∏ò": [1, 6], "‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ": [1, 4, 5, 6], "‡∏®‡∏∏‡∏Å‡∏£‡πå": [3] } },
            { name: "‡∏ô‡∏≤‡∏¢‡πÑ‡∏Å‡∏£‡∏™‡∏£ ‡∏à‡∏±‡∏ô‡∏ó‡∏ß‡∏µ", department: "7. ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏≤‡∏£‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡∏®‡∏¥‡∏•‡∏õ‡∏®‡∏∂‡∏Å‡∏©‡∏≤", schedule: { "‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå": [1, 2, 4], "‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£": [2, 3, 4, 6], "‡∏û‡∏∏‡∏ò": [3, 4, 5, 6], "‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ": [2, 3, 5], "‡∏®‡∏∏‡∏Å‡∏£‡πå": [1, 2, 4, 5, 6, 7] } },
            { name: "‡∏ô‡∏≤‡∏¢‡∏ï‡πâ‡∏ô‡∏Å‡∏•‡πâ‡∏≤ ‡πÄ‡∏û‡∏ä‡∏£‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô", department: "8. ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏≤‡∏£‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô‡∏≠‡∏≤‡∏ä‡∏µ‡∏û", schedule: { "‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå": [2, 3, 4], "‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£": [3, 4], "‡∏û‡∏∏‡∏ò": [3, 4, 5, 6], "‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ": [], "‡∏®‡∏∏‡∏Å‡∏£‡πå": [4] } },
            { name: "‡∏ô‡∏≤‡∏¢‡∏ô‡∏ô‡∏ó‡∏û‡∏±‡∏ó‡∏ò‡πå ‡∏´‡∏¥‡∏£‡∏±‡∏ç‡πÄ‡∏£‡∏∑‡∏≠‡∏á", department: "3. ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏≤‡∏£‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢", schedule: { "‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå": [2, 4, 5, 6], "‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£": [2, 3], "‡∏û‡∏∏‡∏ò": [2, 3, 5, 6], "‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ": [2, 6], "‡∏®‡∏∏‡∏Å‡∏£‡πå": [1, 3, 4] } }
        ];

        // --- 3. LOGIC ---
        let selectedTeachers = [];
        const MAX_SELECTION = 6;
        let chartDeptInstance = null;
        let chartTeacherInstance = null;

        // Navigation
        function switchTab(tabId) {
            document.querySelectorAll('.page-section').forEach(el => el.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            
            document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));
            if(tabId === 'allocation') document.getElementById('btnAlloc').classList.add('active');
            if(tabId === 'history') {
                document.getElementById('btnHistory').classList.add('active');
                loadHistory();
            }
            if(tabId === 'dashboard') {
                document.getElementById('btnDash').classList.add('active');
                renderDashboard();
            }
        }

        document.getElementById('btnAlloc').onclick = () => switchTab('allocation');
        document.getElementById('btnHistory').onclick = () => switchTab('history');
        document.getElementById('btnDash').onclick = () => switchTab('dashboard');
        document.getElementById('btnProcess').onclick = processSubstitution;
        document.getElementById('btnSavePrint').onclick = confirmAndPrint;
        document.getElementById('btnRefreshHistory').onclick = loadHistory;

        // Init
        loadTeachers();

        function loadTeachers() {
            const container = document.getElementById('teacherCheckboxes');
            container.innerHTML = '';
            teachersData.forEach((teacher, index) => {
                const item = document.createElement('div');
                item.className = 'teacher-checkbox-item';
                item.innerHTML = `
                    <input type="checkbox" id="t-${index}" value="${teacher.name}" onchange="toggleTeacherSelection('${teacher.name}', this)">
                    <label for="t-${index}">${teacher.name}</label>
                `;
                container.appendChild(item);
            });
        }

        function toggleTeacherSelection(name, cb) {
            const idx = selectedTeachers.indexOf(name);
            if(idx === -1) {
                if(selectedTeachers.length >= MAX_SELECTION) {
                    cb.checked = false;
                    return Swal.fire('‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 6 ‡∏Ñ‡∏ô', 'warning');
                }
                selectedTeachers.push(name);
            } else {
                selectedTeachers.splice(idx, 1);
            }
            updateSelectedDisplay();
        }

        function removeTeacher(name) {
            const idx = selectedTeachers.indexOf(name);
            if(idx !== -1) {
                selectedTeachers.splice(idx, 1);
                updateSelectedDisplay();
                document.querySelectorAll(`input[value="${name}"]`).forEach(cb => cb.checked = false);
            }
        }

        function updateSelectedDisplay() {
            const display = document.getElementById('selectedTeachersDisplay');
            if(selectedTeachers.length === 0) display.innerHTML = '<div style="color:rgba(0,0,0,0.5)">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏£‡∏π</div>';
            else {
                display.innerHTML = selectedTeachers.map(t => 
                    `<div class="teacher-tag">${t} <button onclick="removeTeacher('${t}')" style="background:none;border:none;color:white;cursor:pointer;margin-left:5px;">√ó</button></div>`
                ).join('');
            }
        }

        function processSubstitution() {
            const day = document.getElementById('daySelect').value;
            if(!day || selectedTeachers.length === 0) return Swal.fire('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡∏Ñ‡∏£‡∏π‡∏ó‡∏µ‡πà‡∏•‡∏≤', 'warning');

            const container = document.getElementById('substitutionCards');
            container.innerHTML = '';

            selectedTeachers.forEach(absentName => {
                const absentTeacher = teachersData.find(t => t.name === absentName);
                const absentPeriods = absentTeacher.schedule[day] || [];
                
                if(absentPeriods.length === 0) return;

                let html = `<div class="sub-card">
                    <h3 style="color:#dc2626; margin-bottom:15px; border-bottom:1px solid #eee; padding-bottom:10px;">
                        ${absentName} (‡∏•‡∏≤)
                    </h3>`;

                absentPeriods.sort((a,b)=>a-b).forEach(period => {
                    const available = findAvailableTeachers(day, period, selectedTeachers);
                    
                    html += `<div class="period-row">
                        <div class="period-badge">‡∏Ñ‡∏≤‡∏ö ${period}</div>
                        <div style="flex:1;">`;
                    
                    if(available.length === 0) html += `<span style="color:red">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏£‡∏π‡∏ß‡πà‡∏≤‡∏á</span>`;
                    else {
                        available.forEach(t => {
                            const safeName = absentName.replace(/\s+/g, '');
                            const inputName = `sub_${safeName}_${period}`;
                            const teacherSchedule = t.schedule[day] || [];
                            const scheduleText = teacherSchedule.length > 0 ? teacherSchedule.join(', ') : '‡∏ß‡πà‡∏≤‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏ß‡∏±‡∏ô';
                            
                            html += `
                                <label class="teacher-option" onclick="this.querySelector('input').checked=true; updateRadioStyle(this)">
                                    <input type="radio" name="${inputName}" value="${t.name}" data-dept="${t.department}">
                                    <div>
                                        <strong>${t.name}</strong> <small style="color:#666">(${getShortDept(t.department)})</small>
                                        <div class="schedule-hint">üìÖ ‡∏ï‡∏¥‡∏î‡∏™‡∏≠‡∏ô‡∏Ñ‡∏≤‡∏ö: ${scheduleText}</div>
                                    </div>
                                </label>
                            `;
                        });
                    }
                    html += `</div></div>`;
                });
                html += `</div>`;
                container.innerHTML += html;
            });

            document.getElementById('resultArea').style.display = 'block';
            setTimeout(() => document.getElementById('resultArea').scrollIntoView({behavior: 'smooth'}), 100);
        }

        function updateRadioStyle(label) {
            label.parentElement.querySelectorAll('.teacher-option').forEach(l => l.classList.remove('selected'));
            label.classList.add('selected');
        }

        function findAvailableTeachers(day, period, exclude) {
            return teachersData
                .filter(t => !exclude.includes(t.name) && !(t.schedule[day] || []).includes(period))
                .map(t => ({...t, score: 0})) 
                .slice(0, 5); 
        }

        function getShortDept(d) { return d.includes('.') ? d.split('.')[1].trim() : d; }

        function confirmAndPrint() {
            const dataToSave = [];
            const day = document.getElementById('daySelect').value;
            
            document.querySelectorAll('.sub-card').forEach(card => {
                const absentName = card.querySelector('h3').innerText.split(' (')[0].trim();
                card.querySelectorAll('.period-row').forEach(row => {
                    const period = row.querySelector('.period-badge').innerText.replace('‡∏Ñ‡∏≤‡∏ö ', '');
                    const input = row.querySelector('input:checked');
                    if(input) {
                        dataToSave.push({
                            absent_teacher: absentName,
                            sub_teacher: input.value,
                            period: parseInt(period),
                            department: input.dataset.dept,
                            date_day: day
                        });
                    }
                });
            });

            if(dataToSave.length === 0) return Swal.fire('‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡∏™‡∏≠‡∏ô‡πÅ‡∏ó‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£', 'warning');

            Swal.fire({title:'‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...', didOpen:()=>Swal.showLoading()});
            
            // Firebase Compat Add
            db.collection("substitutions").add({
                created_at: firebase.firestore.FieldValue.serverTimestamp(),
                day: day,
                records: dataToSave
            }).then(() => {
                Swal.close();
                generatePrintView(day, dataToSave);
                window.print();
            }).catch((e) => {
                Swal.fire('Error', e.message, 'error');
            });
        }

        function generatePrintView(day, data) {
            const div = document.getElementById('printArea');
            let html = `
                <div style="text-align:center; margin-bottom:30px;">
                    <h2 style="font-size:20pt; margin:0;">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏™‡∏≠‡∏ô‡πÅ‡∏ó‡∏ô</h2>
                    <p style="font-size:16pt;">‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏ß‡∏¥‡∏ä‡∏≤‡∏Å‡∏≤‡∏£ ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô...................................</p>
                    <p style="font-size:16pt;">‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô ${day} ‡∏ó‡∏µ‡πà ...... ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ............. ‡∏û.‡∏®. .......</p>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th style="width:10%">‡∏Ñ‡∏≤‡∏ö‡∏ó‡∏µ‡πà</th>
                            <th style="width:30%">‡∏Ñ‡∏£‡∏π‡∏ó‡∏µ‡πà‡∏•‡∏≤</th>
                            <th style="width:30%">‡∏Ñ‡∏£‡∏π‡∏ú‡∏π‡πâ‡∏™‡∏≠‡∏ô‡πÅ‡∏ó‡∏ô</th>
                            <th style="width:30%">‡∏•‡∏á‡∏ô‡∏≤‡∏°‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏≤‡∏ö</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            data.sort((a,b) => a.period - b.period);
            data.forEach(item => {
                html += `
                    <tr>
                        <td style="text-align:center">${item.period}</td>
                        <td>${item.absent_teacher}</td>
                        <td>${item.sub_teacher}</td>
                        <td></td>
                    </tr>
                `;
            });
            html += `</tbody></table>
                <div class="signature-box">
                    <div class="sign-spot"><p>‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠ ....................................... ‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏ó‡∏≥</p><p>(‡∏Ñ‡∏£‡∏π‡∏ô‡∏ô‡∏ó‡∏û‡∏±‡∏ó‡∏ò‡πå ‡∏´‡∏¥‡∏£‡∏±‡∏ç‡πÄ‡∏£‡∏∑‡∏≠‡∏á)</p></div>
                    <div class="sign-spot"><p>‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠ ....................................... ‡∏ú‡∏π‡πâ‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Å‡∏≤‡∏£</p><p>(.......................................)</p></div>
                </div>`;
            div.innerHTML = html;
        }

        // History
        function loadHistory() {
            const tbody = document.getElementById('historyTableBody');
            tbody.innerHTML = '<tr><td colspan="4" style="text-align:center">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</td></tr>';
            
            db.collection("substitutions").orderBy("created_at", "desc").get().then((snap) => {
                if(snap.empty) {
                    tbody.innerHTML = '<tr><td colspan="4" style="text-align:center">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</td></tr>';
                    return;
                }
                tbody.innerHTML = '';
                snap.forEach(doc => {
                    const data = doc.data();
                    const records = data.records || [];
                    const detailText = records.map(r => `‡∏Ñ‡∏≤‡∏ö ${r.period}: ${r.sub_teacher} (‡πÅ‡∏ó‡∏ô ${r.absent_teacher})`).join('<br>');
                    const jsonStr = JSON.stringify(data).replace(/"/g, '&quot;');
                    
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${data.day}</td>
                        <td>${[...new Set(records.map(r=>r.absent_teacher))].join(', ')}</td>
                        <td style="font-size:0.9rem; color:#555;">${detailText}</td>
                        <td>
                            <button class="btn-action btn-print" onclick="reprintRecord('${jsonStr}')"><i class="fas fa-print"></i> ‡∏û‡∏¥‡∏°‡∏û‡πå</button>
                            <button class="btn-action btn-del" onclick="deleteRecord('${doc.id}')"><i class="fas fa-trash"></i> ‡∏•‡∏ö</button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            });
        }

        function deleteRecord(id) {
            Swal.fire({title:'‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö?', icon:'warning', showCancelButton:true}).then(r=>{
                if(r.isConfirmed) {
                    db.collection("substitutions").doc(id).delete().then(() => {
                        Swal.fire('‡∏•‡∏ö‡πÅ‡∏•‡πâ‡∏ß', '', 'success');
                        loadHistory();
                    });
                }
            });
        }

        function reprintRecord(jsonStr) {
            const data = JSON.parse(jsonStr);
            generatePrintView(data.day, data.records);
            window.print();
        }

        // Dashboard
        function renderDashboard() {
            db.collection("substitutions").get().then((snap) => {
                let deptStats = {}, teacherStats = {};
                snap.forEach(doc => {
                    (doc.data().records||[]).forEach(r => {
                        const dept = getShortDept(r.department||'Other');
                        deptStats[dept] = (deptStats[dept]||0)+1;
                        teacherStats[r.sub_teacher] = (teacherStats[r.sub_teacher]||0)+1;
                    });
                });
                
                if(chartDeptInstance) chartDeptInstance.destroy();
                chartDeptInstance = new Chart(document.getElementById('deptChart'), {
                    type: 'pie',
                    data: { labels: Object.keys(deptStats), datasets:[{data: Object.values(deptStats), backgroundColor:['#f87171','#60a5fa','#fbbf24','#34d399','#a78bfa']}] }
                });

                if(chartTeacherInstance) chartTeacherInstance.destroy();
                const top5 = Object.entries(teacherStats).sort((a,b)=>b[1]-a[1]).slice(0,5);
                chartTeacherInstance = new Chart(document.getElementById('teacherChart'), {
                    type: 'bar',
                    data: { labels: top5.map(i=>i[0]), datasets:[{label:'‡∏Ñ‡∏≤‡∏ö', data:top5.map(i=>i[1]), backgroundColor:'#60a5fa'}] }
                });
            });
        }
    </script>
</body>
</html>
