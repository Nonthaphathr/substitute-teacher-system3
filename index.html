<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏™‡∏≠‡∏ô‡πÅ‡∏ó‡∏ô V.5.0 (Ultimate)</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&family=Kanit:wght@300;400;500;600;700&display=swap');

        /* --- Global & Theme --- */
        :root { --primary: #4338ca; --secondary: #3b82f6; --bg: #f3f4f6; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Kanit', sans-serif; background: var(--bg); min-height: 100vh; padding: 20px; color: #1e293b; }

        .app-container { max-width: 1200px; margin: 0 auto; background: white; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); overflow: hidden; min-height: 85vh; display: flex; flex-direction: column; }
        
        /* Header */
        .header { background: linear-gradient(135deg, #4338ca, #6366f1); padding: 30px; color: white; text-align: center; position: relative; }
        .header h1 { font-size: 2rem; margin-bottom: 5px; text-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        .header p { opacity: 0.9; }

        /* Nav */
        .nav-bar { display: flex; justify-content: center; gap: 15px; padding: 15px; background: white; border-bottom: 1px solid #e5e7eb; }
        .nav-btn { padding: 10px 25px; border-radius: 50px; border: 1px solid #e5e7eb; background: white; color: #64748b; cursor: pointer; transition: 0.3s; font-family: 'Kanit'; font-size: 1rem; }
        .nav-btn:hover, .nav-btn.active { background: var(--primary); color: white; border-color: var(--primary); box-shadow: 0 4px 10px rgba(67, 56, 202, 0.3); }

        /* Sections */
        .page-section { display: none; padding: 30px; flex-grow: 1; animation: fadeIn 0.4s; }
        .page-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Controls */
        .control-panel { background: #f8fafc; padding: 25px; border-radius: 15px; border: 1px solid #e2e8f0; margin-bottom: 30px; }
        select { width: 100%; padding: 12px; border-radius: 10px; border: 1px solid #cbd5e1; font-family: 'Kanit'; font-size: 1rem; margin-top: 8px; }
        
        .teacher-checkboxes { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 10px; max-height: 250px; overflow-y: auto; background: white; padding: 15px; border: 1px solid #e2e8f0; border-radius: 10px; margin-top: 10px; }
        .checkbox-item { display: flex; align-items: center; gap: 8px; font-size: 0.95rem; }
        
        .tag-container { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; min-height: 30px; }
        .tag { background: #e0e7ff; color: #3730a3; padding: 4px 12px; border-radius: 20px; font-size: 0.85rem; }

        /* Cards */
        .match-card { background: white; border: 1px solid #e2e8f0; border-radius: 12px; overflow: hidden; margin-bottom: 20px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }
        .match-header { background: #fee2e2; color: #991b1b; padding: 15px 20px; font-weight: 600; display: flex; justify-content: space-between; border-left: 5px solid #ef4444; }
        
        .period-row { display: flex; padding: 15px 20px; border-bottom: 1px solid #f1f5f9; gap: 15px; align-items: flex-start; }
        .period-badge { background: var(--secondary); color: white; padding: 5px 12px; border-radius: 6px; font-weight: bold; min-width: 70px; text-align: center; height: fit-content; }
        
        /* Radio Options */
        .teacher-option { width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 8px; cursor: pointer; transition: 0.2s; display: flex; align-items: center; gap: 12px; position: relative; }
        .teacher-option:hover { background: #f8fafc; border-color: #94a3b8; }
        .teacher-option.selected { background: #eff6ff; border-color: var(--secondary); outline: 2px solid var(--secondary); }
        .load-badge { position: absolute; right: 10px; top: 10px; font-size: 0.75rem; padding: 2px 8px; border-radius: 10px; font-weight: bold; }
        .load-low { background: #dcfce7; color: #166534; }
        .load-med { background: #fef9c3; color: #854d0e; }
        .load-high { background: #fee2e2; color: #991b1b; }

        /* Buttons */
        .btn-process { width: 100%; padding: 15px; background: linear-gradient(135deg, #059669, #047857); color: white; border: none; border-radius: 12px; font-size: 1.1rem; cursor: pointer; font-family: 'Kanit'; font-weight: 500; margin-top: 20px; transition: 0.3s; }
        .btn-process:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(5, 150, 105, 0.3); }
        .btn-save { background: var(--primary); color: white; padding: 12px 30px; border: none; border-radius: 8px; cursor: pointer; font-family: 'Kanit'; display: flex; align-items: center; gap: 8px; float: right; }

        /* Dashboard */
        .dash-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px; }
        .dash-card { background: white; padding: 20px; border-radius: 15px; border: 1px solid #e2e8f0; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }

        /* Modal Preview */
        .modal { display: none; position: fixed; z-index: 999; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(5px); }
        .modal-content { background: #525659; width: 85%; height: 95%; margin: 20px auto; border-radius: 8px; display: flex; flex-direction: column; overflow: hidden; }
        .modal-toolbar { background: #333; padding: 15px; display: flex; justify-content: flex-end; gap: 10px; color: white; align-items: center; }
        .modal-body { flex-grow: 1; overflow-y: auto; padding: 40px; display: flex; flex-direction: column; align-items: center; gap: 20px; }
        
        /* A4 Paper Style (Exact PDF Replica) */
        .a4-page { width: 210mm; min-height: 297mm; background: white; padding: 25mm 20mm; box-shadow: 0 0 15px rgba(0,0,0,0.5); position: relative; font-family: 'Sarabun', sans-serif; color: black; box-sizing: border-box; }
        
        .doc-header { display: flex; align-items: flex-start; margin-bottom: 0px; }
        .garuda { width: 60px; height: auto; margin-right: 20px; } /* ‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î‡∏Ñ‡∏£‡∏∏‡∏ë */
        .doc-title { flex-grow: 1; text-align: center; padding-top: 15px; padding-right: 80px; } /* ‡∏î‡∏±‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏´‡πâ‡∏Å‡∏∂‡πà‡∏á‡∏Å‡∏•‡∏≤‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Å‡∏±‡∏ö‡∏Ñ‡∏£‡∏∏‡∏ë */
        .doc-title h2 { font-size: 29pt; font-weight: bold; margin: 0; line-height: 1; }
        
        .doc-info { margin-top: 5px; font-size: 16pt; line-height: 1.5; }
        .doc-info b { font-weight: bold; }
        
        .doc-body { margin-top: 10px; font-size: 16pt; text-indent: 2.5cm; line-height: 1.5; text-align: justify; }
        
        .doc-table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 15pt; }
        .doc-table th, .doc-table td { border: 1px solid black; padding: 6px; text-align: left; vertical-align: top; }
        .doc-table th { text-align: center; font-weight: bold; }
        
        .doc-footer { margin-top: 40px; font-size: 16pt; }
        .sign-col { width: 45%; text-align: center; float: left; }
        .sign-col.right { float: right; }
        .clearfix::after { content: ""; clear: both; display: table; }

        @media print {
            body { background: white; padding: 0; }
            .app-container, .modal { display: none; }
            .modal { display: block !important; position: static; background: white; width: 100%; height: auto; }
            .modal-content { margin: 0; width: 100%; height: auto; background: white; box-shadow: none; overflow: visible; }
            .modal-toolbar { display: none; }
            .modal-body { padding: 0; display: block; }
            .a4-page { box-shadow: none; margin: 0; page-break-after: always; width: 100%; }
            .a4-page:last-child { page-break-after: auto; }
        }
    </style>
</head>
<body>

    <div class="app-container">
        <div class="header">
            <h1>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏™‡∏≠‡∏ô‡πÅ‡∏ó‡∏ô V.5.0</h1>
            <p>Workload Monitor & Official Report Gen.</p>
        </div>

        <div class="nav-bar">
            <button class="nav-btn active" onclick="switchTab('allocation')">üìù ‡∏à‡∏±‡∏î‡∏™‡∏≠‡∏ô‡πÅ‡∏ó‡∏ô</button>
            <button class="nav-btn" onclick="switchTab('dashboard')">üìä ‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î</button>
            <button class="nav-btn" onclick="switchTab('history')">üïí ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</button>
        </div>

        <div id="allocation" class="page-section active">
            <div class="control-panel">
                <div style="margin-bottom: 15px;">
                    <label>üìÖ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô</label>
                    <select id="daySelect">
                        <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô --</option>
                        <option value="‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå">‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå</option>
                        <option value="‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£">‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£</option>
                        <option value="‡∏û‡∏∏‡∏ò">‡∏û‡∏∏‡∏ò</option>
                        <option value="‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ">‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ</option>
                        <option value="‡∏®‡∏∏‡∏Å‡∏£‡πå">‡∏®‡∏∏‡∏Å‡∏£‡πå</option>
                    </select>
                </div>
                <div>
                    <label>ü§ï ‡∏Ñ‡∏£‡∏π‡∏ó‡∏µ‡πà‡∏•‡∏≤/‡πÑ‡∏õ‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£</label>
                    <div class="tag-container" id="selectedTags"></div>
                    <div class="teacher-checkboxes" id="teacherList"></div>
                </div>
                <button class="btn-process" onclick="processData()">üîç ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÅ‡∏•‡∏∞‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏†‡∏≤‡∏£‡∏∞‡∏á‡∏≤‡∏ô</button>
            </div>

            <div id="resultSection" style="display: none;">
                <h3 style="margin-bottom: 20px; color: #334155;">üìã ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏£‡∏π‡∏™‡∏≠‡∏ô‡πÅ‡∏ó‡∏ô (‡πÅ‡∏™‡∏î‡∏á‡∏†‡∏≤‡∏£‡∏∞‡∏á‡∏≤‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ)</h3>
                <div id="matchContainer"></div>
                <div style="margin-top: 30px; overflow: hidden;">
                    <button class="btn-save" onclick="openPreviewModal()">
                        <i class="fas fa-print"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô
                    </button>
                </div>
            </div>
        </div>

        <div id="dashboard" class="page-section">
            <h3 style="margin-bottom: 20px;">‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏™‡∏≠‡∏ô‡πÅ‡∏ó‡∏ô (Cloud Data)</h3>
            <button class="nav-btn" onclick="renderDashboard()" style="margin-bottom:20px; font-size:0.9rem;">üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
            <div class="dash-grid">
                <div class="dash-card">
                    <h4>‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏≤‡∏°‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏≤‡∏£‡∏∞‡∏Ø</h4>
                    <canvas id="deptChart"></canvas>
                </div>
                <div class="dash-card">
                    <h4>Top 5 ‡∏Ñ‡∏£‡∏π‡∏™‡∏≠‡∏ô‡πÅ‡∏ó‡∏ô‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î</h4>
                    <canvas id="topTeacherChart"></canvas>
                </div>
            </div>
        </div>

        <div id="history" class="page-section">
            <h3 style="margin-bottom: 20px;">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</h3>
            <button class="nav-btn" onclick="loadHistory()" style="margin-bottom:20px; font-size:0.9rem;">üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>
            <div id="historyList"></div>
        </div>
    </div>

    <div id="previewModal" class="modal">
        <div class="modal-content">
            <div class="modal-toolbar">
                <span>‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ (‡πÅ‡∏¢‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡∏≤‡∏°‡∏ú‡∏π‡πâ‡∏™‡∏≠‡∏ô‡πÅ‡∏ó‡∏ô)</span>
                <button onclick="window.print()" class="nav-btn" style="background:#22c55e; color:white; border:none;">üñ®Ô∏è ‡∏û‡∏¥‡∏°‡∏û‡πå</button>
                <button onclick="document.getElementById('previewModal').style.display='none'" class="nav-btn" style="background:#ef4444; color:white; border:none;">‡∏õ‡∏¥‡∏î</button>
            </div>
            <div class="modal-body" id="previewBody">
                </div>
        </div>
    </div>

    <script>
        // --- 1. FIREBASE CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyCF7qDDxp6NXk3y7wLiySasqoviGyCKNNw",
            authDomain: "sornthan-fc0f1.firebaseapp.com",
            projectId: "sornthan-fc0f1",
            storageBucket: "sornthan-fc0f1.firebasestorage.app",
            messagingSenderId: "915683105444",
            appId: "1:915683105444:web:c1add040ea1afb344ae431"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // --- 2. TEACHER DATA ---
        const teachersData = [
            { name: "‡∏ô‡∏≤‡∏¢‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤ ‡πÉ‡∏´‡∏°‡πà‡∏Ñ‡∏≤‡∏°‡∏¥", department: "‡∏™‡∏±‡∏á‡∏Ñ‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏Ø", schedule: { "‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå": [1, 5, 6, 7], "‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£": [3, 5, 6], "‡∏û‡∏∏‡∏ò": [1, 2, 3, 5, 6], "‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ": [1, 3, 4, 5, 6], "‡∏®‡∏∏‡∏Å‡∏£‡πå": [2, 4, 7] } },
            { name: "‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß‡∏ì‡∏¥‡∏ä‡∏≤‡∏£‡∏µ‡∏¢‡πå ‡∏Ñ‡∏≥‡∏®‡∏£‡∏µ‡∏ó‡∏≤", department: "‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡∏Ø", schedule: { "‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå": [2, 4], "‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£": [3, 4, 6], "‡∏û‡∏∏‡∏ò": [3, 4, 5, 6], "‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ": [5, 6], "‡∏®‡∏∏‡∏Å‡∏£‡πå": [4, 5, 6] } },
            { name: "‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß‡∏Å‡∏≤‡∏ô‡∏ï‡πå‡∏°‡∏ì‡∏µ ‡πÅ‡∏Å‡πâ‡∏ß‡∏û‡∏ß‡∏á", department: "‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡∏Ø", schedule: { "‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå": [1, 2, 3, 4, 6], "‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£": [1, 2, 4], "‡∏û‡∏∏‡∏ò": [], "‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ": [5], "‡∏®‡∏∏‡∏Å‡∏£‡πå": [1, 2] } },
            { name: "‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß‡∏¢‡∏∏‡∏û‡∏≤ ‡∏ó‡∏≠‡∏á‡∏Ñ‡∏≥", department: "‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡∏Ø", schedule: { "‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå": [3, 4, 5, 7], "‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£": [5], "‡∏û‡∏∏‡∏ò": [1, 2], "‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ": [1, 2, 3, 4], "‡∏®‡∏∏‡∏Å‡∏£‡πå": [2, 3, 5, 6, 7] } },
            { name: "‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß‡∏£‡∏±‡∏ï‡∏ô‡∏≤ ‡∏™‡∏µ‡∏ü‡πâ‡∏≤", department: "‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå", schedule: { "‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå": [2, 5], "‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£": [2, 3, 4, 5], "‡∏û‡∏∏‡∏ò": [2, 4, 5], "‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ": [1, 2, 3], "‡∏®‡∏∏‡∏Å‡∏£‡πå": [1, 2, 4, 5] } },
            { name: "‡∏ô‡∏≤‡∏¢‡∏ò‡∏ô‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå ‡∏û‡∏£‡∏´‡∏°‡∏ó‡∏≠‡∏á", department: "‡∏™‡∏±‡∏á‡∏Ñ‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏Ø", schedule: { "‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå": [3, 6, 7], "‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£": [4, 6], "‡∏û‡∏∏‡∏ò": [2, 3, 4, 5, 6], "‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ": [4, 6], "‡∏®‡∏∏‡∏Å‡∏£‡πå": [4, 5, 6, 7] } },
            { name: "‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß‡∏ß‡∏¥‡πÑ‡∏•‡∏à‡∏¥‡∏ï‡∏£ ‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå‡πÅ‡∏à‡πâ‡∏á", department: "‡∏†‡∏≤‡∏©‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®", schedule: { "‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå": [1, 5, 7], "‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£": [1, 4, 5], "‡∏û‡∏∏‡∏ò": [1, 3, 4, 5, 6], "‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ": [1, 5, 6], "‡∏®‡∏∏‡∏Å‡∏£‡πå": [3, 6, 7] } },
            { name: "‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß‡∏™‡∏∏‡∏û‡∏±‡∏í‡∏ï‡∏≤ ‡∏®‡∏£‡∏µ‡πÄ‡∏°‡∏∑‡∏≠‡∏á", department: "‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå", schedule: { "‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå": [1, 4, 6], "‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£": [2, 3, 4], "‡∏û‡∏∏‡∏ò": [1, 3, 4, 5, 6], "‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ": [3, 4], "‡∏®‡∏∏‡∏Å‡∏£‡πå": [1, 2, 3, 4] } },
            { name: "‡∏ô‡∏≤‡∏¢‡πÄ‡∏î‡∏ä‡∏≤ ‡∏ß‡∏á‡∏®‡πå‡πÄ‡∏à‡∏£‡∏¥‡∏ç", department: "‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡∏Ø", schedule: { "‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå": [3, 4], "‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£": [2, 3, 4, 5], "‡∏û‡∏∏‡∏ò": [1, 2, 3, 4], "‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ": [1, 2, 3, 4], "‡∏®‡∏∏‡∏Å‡∏£‡πå": [1] } },
            { name: "‡∏ô‡∏≤‡∏¢‡∏≠‡∏≤‡∏à‡∏´‡∏≤‡∏ç ‡∏ß‡∏¥‡∏£‡∏¥‡∏¢‡πÇ‡∏Å‡∏®‡∏•", department: "‡∏™‡∏∏‡∏Ç‡∏®‡∏∂‡∏Å‡∏©‡∏≤ ‡∏û‡∏•‡∏®‡∏∂‡∏Å‡∏©‡∏≤", schedule: { "‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå": [3, 4, 5, 6, 7], "‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£": [2, 3, 4, 5, 6], "‡∏û‡∏∏‡∏ò": [4], "‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ": [2, 5, 6], "‡∏®‡∏∏‡∏Å‡∏£‡πå": [4] } },
            { name: "‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß‡∏õ‡∏£‡∏¥‡∏°‡∏õ‡∏†‡∏≤‡∏û‡∏£ ‡∏ö‡∏≤‡∏≠‡∏¥‡∏ô‡∏ó‡∏£‡πå", department: "‡∏†‡∏≤‡∏©‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®", schedule: { "‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå": [1], "‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£": [3, 4, 5, 6], "‡∏û‡∏∏‡∏ò": [1, 6], "‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ": [1, 4, 5, 6], "‡∏®‡∏∏‡∏Å‡∏£‡πå": [3] } },
            { name: "‡∏ô‡∏≤‡∏¢‡πÑ‡∏Å‡∏£‡∏™‡∏£ ‡∏à‡∏±‡∏ô‡∏ó‡∏ß‡∏µ", department: "‡∏®‡∏¥‡∏•‡∏õ‡∏®‡∏∂‡∏Å‡∏©‡∏≤", schedule: { "‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå": [1, 2, 4], "‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£": [2, 3, 4, 6], "‡∏û‡∏∏‡∏ò": [3, 4, 5, 6], "‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ": [2, 3, 5], "‡∏®‡∏∏‡∏Å‡∏£‡πå": [1, 2, 4, 5, 6, 7] } },
            { name: "‡∏ô‡∏≤‡∏¢‡∏ï‡πâ‡∏ô‡∏Å‡∏•‡πâ‡∏≤ ‡πÄ‡∏û‡∏ä‡∏£‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô", department: "‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô‡∏≠‡∏≤‡∏ä‡∏µ‡∏û", schedule: { "‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå": [2, 3, 4], "‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£": [3, 4], "‡∏û‡∏∏‡∏ò": [3, 4, 5, 6], "‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ": [], "‡∏®‡∏∏‡∏Å‡∏£‡πå": [4] } },
            { name: "‡∏ô‡∏≤‡∏¢‡∏ô‡∏ô‡∏ó‡∏û‡∏±‡∏ó‡∏ò‡πå ‡∏´‡∏¥‡∏£‡∏±‡∏ç‡πÄ‡∏£‡∏∑‡∏≠‡∏á", department: "‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢", schedule: { "‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå": [2, 4, 5, 6], "‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£": [2, 3], "‡∏û‡∏∏‡∏ò": [2, 3, 5, 6], "‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ": [2, 6], "‡∏®‡∏∏‡∏Å‡∏£‡πå": [1, 3, 4] } }
        ];

        // --- 3. STATE & UTILS ---
        let selectedTeachers = [];
        let currentDay = "";
        let teacherLoadMap = {}; // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡πà‡∏≤‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÉ‡∏Ñ‡∏£‡∏™‡∏≠‡∏ô‡πÑ‡∏õ‡∏Å‡∏µ‡πà‡∏Ñ‡∏≤‡∏ö‡πÅ‡∏•‡πâ‡∏ß
        let chartDept = null;
        let chartTeacher = null;

        window.onload = () => renderTeacherList();

        function switchTab(id) {
            document.querySelectorAll('.page-section').forEach(el => el.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            event.currentTarget.classList.add('active');
            
            if (id === 'dashboard') renderDashboard();
            if (id === 'history') loadHistory();
        }

        // --- 4. ALLOCATION LOGIC ---
        function renderTeacherList() {
            const container = document.getElementById('teacherList');
            container.innerHTML = teachersData.map((t, i) => `
                <div class="checkbox-item">
                    <input type="checkbox" id="t${i}" value="${t.name}" onchange="toggleTeacher('${t.name}', this)">
                    <label for="t${i}" style="cursor:pointer">${t.name}</label>
                </div>
            `).join('');
        }

        function toggleTeacher(name, cb) {
            if (cb.checked) {
                if (selectedTeachers.length >= 6) {
                    cb.checked = false;
                    return Swal.fire('‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 6 ‡∏ó‡πà‡∏≤‡∏ô', 'warning');
                }
                selectedTeachers.push(name);
            } else {
                selectedTeachers = selectedTeachers.filter(t => t !== name);
            }
            document.getElementById('selectedTags').innerHTML = selectedTeachers.map(t => `<div class="tag">${t}</div>`).join('');
        }

        async function processData() {
            currentDay = document.getElementById('daySelect').value;
            if (!currentDay || selectedTeachers.length === 0) return Swal.fire('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö', '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡∏Ñ‡∏£‡∏π‡∏ó‡∏µ‡πà‡∏•‡∏≤', 'warning');

            // 1. Fetch Today's Load from Firebase
            await fetchTeacherLoad();

            // 2. Render Cards
            const container = document.getElementById('matchContainer');
            container.innerHTML = '';

            selectedTeachers.forEach(absentName => {
                const absentObj = teachersData.find(t => t.name === absentName);
                const periods = absentObj.schedule[currentDay] || [];
                if (periods.length === 0) return;

                let html = `<div class="match-card">
                    <div class="match-header">
                        <span><i class="fas fa-user-slash"></i> ${absentName}</span>
                    </div>`;

                periods.sort((a,b)=>a-b).forEach(period => {
                    const candidates = getCandidates(currentDay, period, selectedTeachers);
                    html += `<div class="period-row">
                        <div class="period-badge">‡∏Ñ‡∏≤‡∏ö ${period}</div>
                        <div style="flex:1;">`;
                    
                    if(candidates.length === 0) html += `<div style="color:red">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏£‡∏π‡∏ß‡πà‡∏≤‡∏á</div>`;
                    else {
                        candidates.forEach(t => {
                            const inputName = `sub_${absentName.replace(/\s/g,'')}_${period}`;
                            const load = teacherLoadMap[t.name] || 0;
                            const loadClass = load === 0 ? 'load-low' : (load < 2 ? 'load-med' : 'load-high');
                            
                            html += `
                                <label class="teacher-option" onclick="selectRadio(this)">
                                    <input type="radio" name="${inputName}" value="${t.name}" data-dept="${t.department}">
                                    <div>
                                        <strong>${t.name}</strong> 
                                        <div style="font-size:0.8rem; color:#666;">${t.department}</div>
                                    </div>
                                    <div class="load-badge ${loadClass}">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏™‡∏≠‡∏ô‡πÅ‡∏•‡πâ‡∏ß: ${load} ‡∏Ñ‡∏≤‡∏ö</div>
                                </label>
                            `;
                        });
                    }
                    html += `</div></div>`;
                });
                html += `</div>`;
                container.innerHTML += html;
            });

            document.getElementById('resultSection').style.display = 'block';
            setTimeout(() => document.getElementById('resultSection').scrollIntoView({behavior:'smooth'}), 100);
        }

        async function fetchTeacherLoad() {
            teacherLoadMap = {};
            // Query Firebase where day == currentDay
            const snapshot = await db.collection('substitutions').where('day', '==', currentDay).get();
            snapshot.forEach(doc => {
                const data = doc.data();
                (data.records || []).forEach(r => {
                    teacherLoadMap[r.sub_teacher] = (teacherLoadMap[r.sub_teacher] || 0) + 1;
                });
            });
        }

        function getCandidates(day, period, exclude) {
            return teachersData
                .filter(t => !exclude.includes(t.name) && !(t.schedule[day] || []).includes(period))
                .sort((a,b) => (teacherLoadMap[a.name]||0) - (teacherLoadMap[b.name]||0)) // Sort by load
                .slice(0, 5);
        }

        function selectRadio(el) {
            el.parentElement.querySelectorAll('.teacher-option').forEach(e => e.classList.remove('selected'));
            el.classList.add('selected');
            el.querySelector('input').checked = true;
        }

        // --- 5. REPORT GENERATION (PDF STYLE) ---
        function openPreviewModal() {
            const dataToPrint = [];
            document.querySelectorAll('.match-card').forEach(card => {
                const absent = card.querySelector('.match-header span').innerText.trim();
                card.querySelectorAll('.period-row').forEach(row => {
                    const period = row.querySelector('.period-badge').innerText.replace('‡∏Ñ‡∏≤‡∏ö ','');
                    const checked = row.querySelector('input:checked');
                    if(checked) {
                        dataToPrint.push({
                            absent: absent,
                            period: period,
                            sub: checked.value,
                            dept: checked.dataset.dept
                        });
                    }
                });
            });

            if(dataToPrint.length === 0) return Swal.fire('‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡∏™‡∏≠‡∏ô‡πÅ‡∏ó‡∏ô', 'warning');

            // Group by Substitute Teacher
            const groupBySub = {};
            dataToPrint.forEach(item => {
                if(!groupBySub[item.sub]) groupBySub[item.sub] = [];
                groupBySub[item.sub].push(item);
            });

            const dateObj = new Date();
            const thaiDate = `${dateObj.getDate()} ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ${['‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°','‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå','‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°','‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô','‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°','‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô','‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°','‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°','‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô','‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°','‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô','‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°'][dateObj.getMonth()]} ‡∏û.‡∏®. ${dateObj.getFullYear()+543}`;
            
            let allPagesHtml = '';

            // Generate One Page Per Substitute
            for (const [subName, items] of Object.entries(groupBySub)) {
                // Find Dept of sub
                const subObj = teachersData.find(t => t.name === subName);
                const subDept = subObj ? subObj.department : "‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏≤‡∏£‡∏∞‡∏Ø...................";

                // Table Rows
                items.sort((a,b) => a.period - b.period);
                let rows = '';
                items.forEach((it, idx) => {
                    rows += `
                        <tr>
                            <td style="text-align:center;">${idx+1}</td>
                            <td>${it.absent}</td>
                            <td>‡πÑ‡∏õ‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£</td>
                            <td style="text-align:center;">${it.period}</td>
                            <td>-</td>
                            <td>-</td>
                            <td></td>
                        </tr>
                    `;
                });

                // Page Template (Exact PDF Replica)
                allPagesHtml += `
                <div class="a4-page">
                    <div class="doc-header">
                        <img src="https://nonthaphathr.github.io/uploadimg/kruda.png" class="garuda">
                        <div class="doc-title">
                            <h2>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°</h2>
                        </div>
                    </div>
                    
                    <div class="doc-info">
                        <b>‡∏™‡πà‡∏ß‡∏ô‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£</b> ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Å‡∏£‡∏∞‡∏î‡∏∏‡∏°‡∏ó‡∏≠‡∏á‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤ ‡∏ï‡∏≥‡∏ö‡∏•‡∏´‡∏ô‡∏≠‡∏á‡∏´‡∏±‡∏ß‡∏ä‡πâ‡∏≤‡∏á ‡∏≠‡∏≥‡πÄ‡∏†‡∏≠‡∏Å‡∏±‡∏ô‡∏ó‡∏£‡∏≤‡∏£‡∏°‡∏¢‡πå ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏®‡∏£‡∏µ‡∏™‡∏∞‡πÄ‡∏Å‡∏©<br>
                        <b>‡∏ó‡∏µ‡πà</b> ‡∏®‡∏Å 51008.08/......... <b>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</b> ${thaiDate}<br>
                        <b>‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á</b> ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ô‡πÅ‡∏ó‡∏ô
                    </div>
                    
                    <div style="border-bottom: 1px solid black; margin: 10px 0;"></div>
                    
                    <div class="doc-info">
                        <b>‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</b> ‡∏ú‡∏π‡πâ‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Å‡∏£‡∏∞‡∏î‡∏∏‡∏°‡∏ó‡∏≠‡∏á‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤
                    </div>

                    <div class="doc-body">
                        ‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Ç‡πâ‡∏≤‡∏û‡πÄ‡∏à‡πâ‡∏≤ ${subName} ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á ‡∏Ñ‡∏£‡∏π ${subDept} ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢‡πÉ‡∏´‡πâ‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£‡πÅ‡∏ó‡∏ô ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${thaiDate} ‡∏ï‡∏≤‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏£‡∏≤‡∏ö‡πÅ‡∏•‡πâ‡∏ß‡∏ô‡∏±‡πâ‡∏ô
                        <br>
                        ‡∏ö‡∏±‡∏î‡∏ô‡∏µ‡πâ ‡∏Ç‡πâ‡∏≤‡∏û‡πÄ‡∏à‡πâ‡∏≤‡πÑ‡∏î‡πâ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ô‡πÅ‡∏ó‡∏ô‡∏î‡∏±‡∏á‡∏Å‡∏•‡πà‡∏≤‡∏ß‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß ‡∏à‡∏∂‡∏á‡∏Ç‡∏≠‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ô‡πÅ‡∏ó‡∏ô ‡∏î‡∏±‡∏á‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏ô‡∏µ‡πâ
                    </div>

                    <table class="doc-table">
                        <thead>
                            <tr>
                                <th style="width:5%">‡∏ó‡∏µ‡πà</th>
                                <th style="width:25%">‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£‡πÅ‡∏ó‡∏ô</th>
                                <th style="width:20%">‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏</th>
                                <th style="width:10%">‡∏Ñ‡∏≤‡∏ö‡∏ó‡∏µ‡πà</th>
                                <th style="width:10%">‡∏£‡∏´‡∏±‡∏™‡∏ß‡∏¥‡∏ä‡∏≤</th>
                                <th style="width:10%">‡∏ä‡∏±‡πâ‡∏ô</th>
                                <th style="width:20%">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${rows}
                            <tr><td>&nbsp;</td><td></td><td></td><td></td><td></td><td></td><td></td></tr>
                            <tr><td>&nbsp;</td><td></td><td></td><td></td><td></td><td></td><td></td></tr>
                        </tbody>
                    </table>

                    <div class="doc-footer">
                        ‡∏à‡∏∂‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏°‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÇ‡∏õ‡∏£‡∏î‡∏ó‡∏£‡∏≤‡∏ö
                        <br><br>
                        <div class="clearfix">
                            <div class="sign-col">
                                ‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠................................................<br>
                                (${subName})<br>
                                ‡∏ú‡∏π‡πâ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô
                            </div>
                        </div>
                        <br><br>
                        <div class="clearfix">
                             <div class="sign-col">
                                ‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠................................................<br>
                                (‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß‡∏™‡∏∏‡∏û‡∏±‡∏í‡∏ï‡∏≤ ‡∏®‡∏£‡∏µ‡πÄ‡∏°‡∏∑‡∏≠‡∏á)<br>
                                ‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏ù‡πà‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤‡∏Å‡∏≤‡∏£
                            </div>
                            <div class="sign-col right">
                                ‡∏ó‡∏£‡∏≤‡∏ö<br><br>
                                ‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠................................................<br>
                                (‡∏ô‡∏≤‡∏á‡∏™‡∏∏‡∏ô‡∏¥‡∏™‡∏≤ ‡πÉ‡∏à‡πÉ‡∏´‡∏ç‡πà)<br>
                                ‡∏ú‡∏π‡πâ‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Å‡∏£‡∏∞‡∏î‡∏∏‡∏°‡∏ó‡∏≠‡∏á‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤
                            </div>
                        </div>
                    </div>
                </div>
                `;
            }

            document.getElementById('previewBody').innerHTML = allPagesHtml;
            document.getElementById('previewModal').style.display = 'block';

            // Auto Save
            db.collection("substitutions").add({
                created_at: firebase.firestore.FieldValue.serverTimestamp(),
                day: currentDay,
                records: dataToPrint
            });
        }

        // --- 6. DASHBOARD & HISTORY ---
        function renderDashboard() {
            db.collection("substitutions").get().then(snap => {
                let deptStats = {}, teacherStats = {};
                snap.forEach(doc => {
                    (doc.data().records||[]).forEach(r => {
                        const d = r.dept || '‡∏≠‡∏∑‡πà‡∏ô‡πÜ';
                        deptStats[d] = (deptStats[d]||0)+1;
                        teacherStats[r.sub] = (teacherStats[r.sub]||0)+1;
                    });
                });

                if(chartDept) chartDept.destroy();
                chartDept = new Chart(document.getElementById('deptChart'), {
                    type: 'doughnut',
                    data: { labels: Object.keys(deptStats), datasets:[{data: Object.values(deptStats), backgroundColor:['#f87171','#60a5fa','#fbbf24','#34d399','#a78bfa']}] }
                });

                if(chartTeacher) chartTeacher.destroy();
                const sorted = Object.entries(teacherStats).sort((a,b)=>b[1]-a[1]).slice(0,5);
                chartTeacher = new Chart(document.getElementById('topTeacherChart'), {
                    type: 'bar',
                    data: { labels: sorted.map(i=>i[0]), datasets:[{label:'‡∏Ñ‡∏≤‡∏ö', data:sorted.map(i=>i[1]), backgroundColor:'#6366f1'}] }
                });
            });
        }

        function loadHistory() {
            const list = document.getElementById('historyList');
            list.innerHTML = 'Loading...';
            db.collection("substitutions").orderBy("created_at", "desc").limit(10).get().then(snap => {
                list.innerHTML = '';
                snap.forEach(doc => {
                    const data = doc.data();
                    const div = document.createElement('div');
                    div.style = "background:white; padding:15px; border:1px solid #e2e8f0; border-radius:10px; margin-bottom:10px;";
                    div.innerHTML = `<strong>${data.day}</strong> <span style="color:#64748b">(${new Date(data.created_at.seconds*1000).toLocaleString('th-TH')})</span><br>
                    ${data.records.map(r => `<span style="font-size:0.9rem">‚Ä¢ ${r.sub} ‡πÅ‡∏ó‡∏ô ${r.absent} (‡∏Ñ‡∏≤‡∏ö ${r.period})</span>`).join('<br>')}`;
                    list.appendChild(div);
                });
            });
        }
    </script>
</body>
</html>
