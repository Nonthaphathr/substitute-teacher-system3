<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏π - Teacher Management System</title>
    
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap');

        :root { 
            --primary: #2563eb; 
            --primary-dark: #1e40af;
            --secondary: #64748b;
            --success: #059669;
            --warning: #f59e0b;
            --danger: #ef4444;
            --bg: #f8fafc; 
        }

        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; }
        body { font-family: 'Sarabun', sans-serif; background: var(--bg); color: #1e293b; padding-bottom: 50px; }

        /* --- Header --- */
        .navbar {
            background: white;
            padding: 15px 30px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .brand { display: flex; align-items: center; gap: 15px; }
        .brand h1 { font-size: 1.5rem; color: var(--primary-dark); font-weight: 700; }
        .brand span { font-size: 0.9rem; color: var(--secondary); }
        
        .nav-actions { display: flex; gap: 10px; align-items: center; }
        .back-btn { text-decoration: none; color: var(--secondary); font-weight: 600; display: flex; align-items: center; gap: 8px; padding: 8px 15px; border-radius: 8px; transition: all 0.2s; }
        .back-btn:hover { background: #e2e8f0; color: var(--primary); }
        
        .admin-btn {
            background: linear-gradient(135deg, #7c3aed, #6d28d9);
            color: white;
            padding: 8px 15px;
            border-radius: 8px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            transition: all 0.3s;
            border: none;
            box-shadow: 0 4px 15px rgba(124, 58, 237, 0.3);
        }
        .admin-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(124, 58, 237, 0.4);
        }

        /* --- Container --- */
        .container { max-width: 1300px; margin: 30px auto; padding: 0 20px; }

        /* --- Lock Banner --- */
        .lock-banner {
            background: linear-gradient(135deg, #fee2e2, #fecaca);
            border: 2px solid var(--danger);
            border-radius: 12px;
            padding: 15px 20px;
            margin-bottom: 20px;
            display: none;
            align-items: center;
            gap: 15px;
            animation: pulse 2s ease-in-out infinite;
        }
        .lock-banner.active { display: flex; }
        .lock-banner i { font-size: 1.5rem; color: var(--danger); }
        .lock-banner .text h4 { color: var(--danger); font-weight: 700; margin-bottom: 3px; }
        .lock-banner .text p { color: #991b1b; font-size: 0.9rem; }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }

        /* --- Toolbar --- */
        .toolbar {
            background: white; padding: 20px; border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.03); margin-bottom: 30px;
            display: flex; flex-wrap: wrap; gap: 20px; align-items: center;
        }
        .search-box { flex-grow: 1; position: relative; }
        .search-box i { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: #94a3b8; }
        .search-input { width: 100%; padding: 12px 15px 12px 45px; border: 2px solid #e2e8f0; border-radius: 10px; font-family: 'Sarabun'; font-size: 1rem; transition: all 0.3s; }
        .search-input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); }

        .action-group { display: flex; gap: 10px; align-items: center; }
        
        button { border: none; cursor: pointer; font-family: 'Sarabun'; border-radius: 8px; transition: transform 0.2s, box-shadow 0.2s; }
        button:active { transform: scale(0.95); }
        button:disabled { opacity: 0.5; cursor: not-allowed; }

        .btn-add { background: linear-gradient(135deg, #2563eb, #1d4ed8); color: white; padding: 10px 20px; font-size: 1rem; font-weight: 600; display: flex; align-items: center; gap: 8px; box-shadow: 0 4px 15px rgba(37, 99, 235, 0.3); }
        .btn-add:hover:not(:disabled) { box-shadow: 0 6px 20px rgba(37, 99, 235, 0.4); transform: translateY(-2px); }
        .btn-icon { padding: 10px; background: #f1f5f9; color: #475569; border: 1px solid #e2e8f0; }
        .btn-icon:hover:not(:disabled) { background: #e2e8f0; color: var(--primary); }

        /* Animated Semester Input */
        .semester-wrapper { position: relative; display: inline-block; }
        .semester-input { 
            padding: 10px 15px; 
            border-radius: 8px; 
            border: 3px solid transparent;
            font-family: 'Sarabun'; 
            width: 180px; 
            text-align: center; 
            font-weight: bold; 
            color: var(--primary-dark);
            background: linear-gradient(white, white) padding-box,
                        linear-gradient(135deg, #3b82f6, #8b5cf6, #ec4899) border-box;
            animation: borderGlow 3s ease-in-out infinite;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
            font-size: 1.1rem;
        }
        .semester-input:focus { 
            outline: none;
            animation: borderGlow 1s ease-in-out infinite;
            box-shadow: 0 6px 25px rgba(59, 130, 246, 0.5);
        }
        
        @keyframes borderGlow {
            0%, 100% { 
                border-color: #3b82f6;
                box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3), 0 0 20px rgba(59, 130, 246, 0.2);
            }
            33% { 
                border-color: #8b5cf6;
                box-shadow: 0 4px 15px rgba(139, 92, 246, 0.3), 0 0 20px rgba(139, 92, 246, 0.2);
            }
            66% { 
                border-color: #ec4899;
                box-shadow: 0 4px 15px rgba(236, 72, 153, 0.3), 0 0 20px rgba(236, 72, 153, 0.2);
            }
        }
        
        .semester-badge {
            position: absolute;
            top: -10px;
            right: -10px;
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.7rem;
            font-weight: 700;
            box-shadow: 0 2px 8px rgba(245, 158, 11, 0.4);
            animation: bounce 2s ease-in-out infinite;
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }

        /* --- Grid Layout --- */
        .teacher-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px; }
        .t-card { background: white; border-radius: 15px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.03); border: 1px solid #f1f5f9; transition: all 0.3s ease; position: relative; overflow: hidden; animation: fadeIn 0.5s ease forwards; }
        .t-card:hover { transform: translateY(-5px); box-shadow: 0 10px 25px rgba(0,0,0,0.08); border-color: var(--primary); }
        .t-card::before { content: ''; position: absolute; top: 0; left: 0; width: 6px; height: 100%; background: var(--primary); opacity: 0.5; }
        
        .t-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px; }
        .t-info h3 { font-size: 1.1rem; color: #1e293b; margin-bottom: 5px; font-weight: 700; }
        .t-info p { color: #64748b; font-size: 0.9rem; }
        .t-dept-badge { background: #eff6ff; color: var(--primary); padding: 4px 10px; border-radius: 20px; font-size: 0.8rem; font-weight: 600; display: inline-block; margin-top: 5px; }

        .t-actions { display: flex; gap: 8px; }
        .btn-edit { background: #f3f4f6; color: var(--primary); padding: 8px; border-radius: 50%; width: 35px; height: 35px; }
        .btn-del { background: #fef2f2; color: #ef4444; padding: 8px; border-radius: 50%; width: 35px; height: 35px; }

        /* Schedule Display */
        .schedule-mini { 
            display: grid; 
            grid-template-columns: repeat(5, 1fr); 
            gap: 8px; 
            margin-top: 15px; 
            border-top: 1px dashed #e2e8f0; 
            padding-top: 15px; 
        }
        .day-col { 
            flex: 1; 
            text-align: center; 
            background: #f8fafc;
            padding: 8px 4px;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            transition: all 0.2s;
        }
        .day-col:hover {
            background: #eff6ff;
            border-color: var(--primary);
            transform: translateY(-2px);
        }
        .day-label { 
            font-size: 0.75rem; 
            color: #64748b; 
            margin-bottom: 4px;
            font-weight: 600;
        }
        .period-count {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 3px;
        }
        .period-count.empty {
            color: #cbd5e1;
        }
        .period-count i {
            font-size: 0.8rem;
        }

        /* --- Modal --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); z-index: 1000; display: none; justify-content: center; align-items: center; opacity: 0; transition: opacity 0.3s; }
        .modal-overlay.show { display: flex; opacity: 1; }
        .modal-box { background: white; width: 1200px; max-width: 98%; max-height: 95vh; border-radius: 20px; padding: 30px; box-shadow: 0 20px 50px rgba(0,0,0,0.2); transform: scale(0.8); transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); overflow-y: auto; display: flex; flex-direction: column; }
        .modal-overlay.show .modal-box { transform: scale(1); }

        /* Admin Modal */
        .modal-box.admin-modal { width: 500px; }
        .modal-box.admin-panel { width: 600px; }

        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #e2e8f0; padding-bottom: 15px; }
        .modal-title { font-size: 1.4rem; color: var(--primary-dark); font-weight: 700; }
        .btn-close { background: none; font-size: 1.5rem; color: #94a3b8; padding: 0; }
        .btn-close:hover { color: #ef4444; transform: rotate(90deg); }

        /* Admin Login */
        .pin-input-group {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin: 30px 0;
        }
        .pin-digit {
            width: 60px;
            height: 70px;
            font-size: 2rem;
            text-align: center;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-weight: bold;
            transition: all 0.2s;
        }
        .pin-digit:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        /* Admin Panel Settings */
        .admin-settings { display: flex; flex-direction: column; gap: 25px; }
        .setting-item {
            background: #f8fafc;
            padding: 20px;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
        }
        .setting-item h4 {
            color: var(--primary-dark);
            margin-bottom: 10px;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .setting-item p {
            color: var(--secondary);
            font-size: 0.9rem;
            margin-bottom: 15px;
        }

        /* Toggle Switch */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 30px;
        }
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #cbd5e1;
            transition: .4s;
            border-radius: 30px;
        }
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .toggle-slider {
            background-color: var(--danger);
        }
        input:checked + .toggle-slider:before {
            transform: translateX(30px);
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        .status-badge.locked {
            background: #fee2e2;
            color: var(--danger);
        }
        .status-badge.unlocked {
            background: #d1fae5;
            color: var(--success);
        }

        .form-grid { display: grid; grid-template-columns: 1fr 2fr 2fr; gap: 15px; margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 6px; font-weight: 600; font-size: 0.9rem; color: #475569; }
        .form-control { width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 8px; font-family: 'Sarabun'; }
        .form-control:focus { border-color: var(--primary); outline: 3px solid rgba(37, 99, 235, 0.1); }

        .schedule-editor { background: #f8fafc; padding: 20px; border-radius: 12px; border: 1px solid #e2e8f0; overflow-x: auto; }
        .sch-table { width: 100%; border-collapse: separate; border-spacing: 8px; }
        .sch-table th { padding: 10px 8px; color: #64748b; font-weight: 600; font-size: 0.95rem; border-bottom: none; background: white; position: sticky; top: 0; z-index: 10; border-radius: 8px; text-align: center;}
        .sch-table td { padding: 5px; text-align: center; border-bottom: none; vertical-align: top; }
        
        .sch-cell { 
            min-width: 110px; 
            height: 110px; 
            background: white; 
            border: 2px solid #e2e8f0; 
            border-radius: 10px; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: flex-start; 
            padding: 8px; 
            transition: all 0.2s; 
            position: relative;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        .sch-cell:hover { 
            border-color: #cbd5e1; 
            box-shadow: 0 3px 8px rgba(0,0,0,0.1); 
            transform: translateY(-2px);
        }
        .sch-cell.active { 
            border-color: var(--primary); 
            background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%); 
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.2);
        }

        .lunch-col { 
            background: linear-gradient(135deg, #fef3c7, #fde68a); 
            writing-mode: vertical-rl; 
            text-orientation: mixed; 
            font-size: 0.9rem; 
            color: #92400e; 
            font-weight: 700; 
            border-radius: 8px; 
            padding: 0 12px; 
            height: 100%; 
            display: flex; 
            align-items: center; 
            justify-content: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .cb-input { width: 22px; height: 22px; margin-bottom: 6px; cursor: pointer; accent-color: var(--primary); }
        .details-inputs { display: none; flex-direction: column; gap: 5px; width: 100%; animation: slideDown 0.2s; }
        .sch-cell.active .details-inputs { display: flex; }
        
        .mini-input { 
            width: 100%; 
            padding: 6px; 
            border: 1px solid #cbd5e1; 
            border-radius: 6px; 
            font-size: 0.85rem; 
            text-align: center;
            font-weight: 500;
            transition: all 0.2s;
        }
        .mini-input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.1);
        }
        .mini-select { 
            width: 100%; 
            padding: 6px; 
            border: 1px solid #cbd5e1; 
            border-radius: 6px; 
            font-size: 0.85rem; 
            background: white;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        .mini-select:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.1);
        }

        .modal-footer { margin-top: 20px; display: flex; justify-content: flex-end; gap: 15px; }
        .btn-save { background: var(--success); color: white; padding: 10px 30px; font-size: 1.1rem; }
        .btn-save:hover { background: #047857; box-shadow: 0 4px 15px rgba(5, 150, 105, 0.3); }

        .btn-primary {
            background: var(--primary);
            color: white;
            padding: 10px 30px;
            font-size: 1rem;
            font-weight: 600;
        }
        .btn-primary:hover {
            background: var(--primary-dark);
            box-shadow: 0 4px 15px rgba(37, 99, 235, 0.3);
        }

        /* Loading */
        .loading-state { text-align: center; padding: 50px; color: #94a3b8; display: none; }
        .spinner { width: 40px; height: 40px; border: 4px solid #e2e8f0; border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 15px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Announcement Textarea */
        .announcement-textarea {
            width: 100%;
            min-height: 150px;
            padding: 12px;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            font-family: 'Sarabun';
            font-size: 0.95rem;
            resize: vertical;
            transition: all 0.2s;
        }
        .announcement-textarea:focus {
            border-color: var(--primary);
            outline: 3px solid rgba(37, 99, 235, 0.1);
        }

        /* Announcement Modal */
        .announcement-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.75);
            backdrop-filter: blur(5px);
            z-index: 2000;
            display: none;
            justify-content: center;
            align-items: center;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .announcement-modal.show {
            display: flex;
            opacity: 1;
        }
        
        .announcement-box {
            background: white;
            width: 600px;
            max-width: 90%;
            border-radius: 20px;
            padding: 0;
            box-shadow: 0 25px 60px rgba(0, 0, 0, 0.3);
            transform: scale(0.7) translateY(-50px);
            transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            overflow: hidden;
            animation: shake 0.5s ease-in-out;
        }
        .announcement-modal.show .announcement-box {
            transform: scale(1) translateY(0);
        }

        @keyframes shake {
            0%, 100% { transform: scale(0.7) translateY(-50px) rotate(0deg); }
            25% { transform: scale(0.75) translateY(-40px) rotate(-2deg); }
            50% { transform: scale(0.8) translateY(-30px) rotate(2deg); }
            75% { transform: scale(0.9) translateY(-20px) rotate(-1deg); }
        }

        .announcement-header {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            padding: 25px 30px;
            color: white;
            position: relative;
            overflow: hidden;
        }
        .announcement-header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            animation: pulse-bg 3s ease-in-out infinite;
        }
        @keyframes pulse-bg {
            0%, 100% { transform: scale(1); opacity: 0.5; }
            50% { transform: scale(1.1); opacity: 0.8; }
        }
        
        .announcement-icon {
            font-size: 3rem;
            text-align: center;
            margin-bottom: 10px;
            animation: bell-ring 1s ease-in-out infinite;
            position: relative;
            z-index: 1;
        }
        @keyframes bell-ring {
            0%, 100% { transform: rotate(0deg); }
            10%, 30% { transform: rotate(-10deg); }
            20%, 40% { transform: rotate(10deg); }
        }
        
        .announcement-title {
            font-size: 1.5rem;
            font-weight: 700;
            text-align: center;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            position: relative;
            z-index: 1;
        }

        .announcement-body {
            padding: 30px;
            background: white;
        }
        .announcement-content {
            font-size: 1.05rem;
            line-height: 1.8;
            color: #1e293b;
            text-align: center;
            white-space: pre-wrap;
            margin-bottom: 25px;
        }
        
        .announcement-footer {
            display: flex;
            gap: 10px;
            justify-content: center;
            padding-top: 20px;
            border-top: 1px solid #e2e8f0;
        }
        
        .btn-understand {
            background: linear-gradient(135deg, #2563eb, #1d4ed8);
            color: white;
            padding: 12px 40px;
            border-radius: 10px;
            font-weight: 600;
            font-size: 1rem;
            border: none;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(37, 99, 235, 0.3);
        }
        .btn-understand:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(37, 99, 235, 0.4);
        }

        /* Checkbox styling */
        .dont-show-again {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #64748b;
            font-size: 0.9rem;
            cursor: pointer;
            user-select: none;
        }
        .dont-show-again input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: var(--primary);
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .modal-box { width: 95%; padding: 20px; }
            .sch-table { border-spacing: 4px; }
            .sch-cell { min-width: 85px; height: 95px; padding: 5px; }
            .schedule-mini { grid-template-columns: repeat(5, 1fr); gap: 5px; }
            .day-col { padding: 6px 2px; }
            .period-count { font-size: 1rem; }
            .semester-input { width: 150px; font-size: 1rem; }
            .announcement-box { width: 95%; }
            .announcement-header { padding: 20px; }
            .announcement-title { font-size: 1.2rem; }
            .announcement-body { padding: 20px; }
        }

    </style>
</head>
<body>

    <nav class="navbar">
        <div class="brand">
            <img src="https://nonthaphathr.github.io/uploadimg/logosonthan.png" alt="Logo" width="45" style="border-radius: 8px;">
            <div>
                <h1>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏π</h1>
                <span>‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏π‡πÅ‡∏•‡∏∞‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏≠‡∏ô</span>
            </div>
        </div>
        <div class="nav-actions">
            <button class="admin-btn" onclick="showAdminLogin()">
                <i class="fas fa-shield-alt"></i> Admin
            </button>
            <a href="index.html" class="back-btn">
                <i class="fas fa-home"></i> ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å
            </a>
        </div>
    </nav>

    <div class="container">
        <!-- Lock Banner -->
        <div class="lock-banner" id="lockBanner">
            <i class="fas fa-lock"></i>
            <div class="text">
                <h4>üîí ‡∏£‡∏∞‡∏ö‡∏ö‡∏ñ‡∏π‡∏Å‡∏•‡πá‡∏≠‡∏Å - ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ</h4>
                <p>‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</p>
            </div>
        </div>

        <div class="toolbar">
            <div class="search-box">
                <i class="fas fa-search"></i>
                <input type="text" id="searchInput" class="search-input" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏£‡∏π, ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏≤‡∏£‡∏∞..." onkeyup="filterTeachers()">
            </div>
            
            <div class="action-group">
                <label style="font-size:0.9rem; font-weight:600; margin-right:5px;">‡∏†‡∏≤‡∏Ñ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô:</label>
                <div class="semester-wrapper">
                    <input type="text" id="semesterInput" class="semester-input" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏†‡∏≤‡∏Ñ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô" readonly>
                    <div class="semester-badge">‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</div>
                </div>

                <button class="btn-icon" id="btnImport" onclick="document.getElementById('importFile').click()" title="‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ CSV">
                    <i class="fas fa-file-import"></i>
                </button>
                <input type="file" id="importFile" accept=".csv" style="display: none;" onchange="importTeachers(event)">

                <button class="btn-icon" id="btnExport" onclick="exportTeachers()" title="‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å CSV">
                    <i class="fas fa-file-export"></i>
                </button>

                <button class="btn-add" id="btnAddTeacher" onclick="openModal()">
                    <i class="fas fa-plus-circle"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏£‡∏π‡πÉ‡∏´‡∏°‡πà
                </button>
            </div>
        </div>

        <div id="loadingState" class="loading-state">
            <div class="spinner"></div>
            <p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
        </div>

        <div id="teacherGrid" class="teacher-grid"></div>
    </div>

    <!-- Announcement Modal -->
    <div id="announcementModal" class="announcement-modal">
        <div class="announcement-box">
            <div class="announcement-header">
                <div class="announcement-icon">üîî</div>
                <div class="announcement-title" id="announcementModalTitle">‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç</div>
            </div>
            <div class="announcement-body">
                <div class="announcement-content" id="announcementModalContent">
                    ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà...
                </div>
                <div class="announcement-footer">
                    <label class="dont-show-again">
                        <input type="checkbox" id="dontShowToday">
                        <span>‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡∏µ‡πâ‡∏≠‡∏µ‡∏Å‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</span>
                    </label>
                </div>
                <div class="announcement-footer">
                    <button class="btn-understand" onclick="closeAnnouncement()">
                        <i class="fas fa-check-circle"></i> ‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡πÅ‡∏•‡πâ‡∏ß
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Login Modal -->
    <div id="adminLoginModal" class="modal-overlay">
        <div class="modal-box admin-modal">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-shield-alt"></i> ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö Admin
                </div>
                <button class="btn-close" onclick="closeAdminLogin()"><i class="fas fa-times"></i></button>
            </div>
            
            <div style="text-align: center; margin-bottom: 20px;">
                <p style="color: var(--secondary);">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™ PIN 4 ‡∏´‡∏•‡∏±‡∏Å</p>
            </div>

            <div class="pin-input-group">
                <input type="password" maxlength="1" class="pin-digit" id="pin1" onkeyup="moveToNext(this, 'pin2')" onpaste="handlePaste(event)">
                <input type="password" maxlength="1" class="pin-digit" id="pin2" onkeyup="moveToNext(this, 'pin3')">
                <input type="password" maxlength="1" class="pin-digit" id="pin3" onkeyup="moveToNext(this, 'pin4')">
                <input type="password" maxlength="1" class="pin-digit" id="pin4" onkeyup="checkPin()">
            </div>

            <div class="modal-footer">
                <button class="btn-icon" style="background: #f1f5f9;" onclick="closeAdminLogin()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button class="btn-primary" onclick="verifyPin()">
                    <i class="fas fa-sign-in-alt"></i> ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö
                </button>
            </div>
        </div>
    </div>

    <!-- Admin Panel Modal -->
    <div id="adminPanelModal" class="modal-overlay">
        <div class="modal-box admin-panel">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-cog"></i> ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö (Admin)
                </div>
                <button class="btn-close" onclick="closeAdminPanel()"><i class="fas fa-times"></i></button>
            </div>

            <div class="admin-settings">
                <!-- Lock/Unlock System -->
                <div class="setting-item">
                    <h4>
                        <i class="fas fa-lock"></i> ‡∏•‡πá‡∏≠‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
                    </h4>
                    <p>‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô ‡∏Ñ‡∏£‡∏π‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏° ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ‡∏´‡∏£‡∏∑‡∏≠‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ</p>
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <label class="toggle-switch">
                            <input type="checkbox" id="systemLockToggle" onchange="updateSystemLock()">
                            <span class="toggle-slider"></span>
                        </label>
                        <span class="status-badge unlocked" id="lockStatus">
                            <i class="fas fa-unlock"></i> ‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å
                        </span>
                    </div>
                </div>

                <!-- Default Semester -->
                <div class="setting-item">
                    <h4>
                        <i class="fas fa-calendar-check"></i> ‡∏†‡∏≤‡∏Ñ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
                    </h4>
                    <p>‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏†‡∏≤‡∏Ñ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡∏∞‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏£‡∏π‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</p>
                    <div class="form-group">
                        <label>‡∏†‡∏≤‡∏Ñ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô/‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤</label>
                        <input type="text" id="defaultSemesterInput" class="form-control" placeholder="‡πÄ‡∏ä‡πà‡∏ô 2/2568" value="">
                    </div>
                    <button class="btn-primary" style="margin-top: 10px;" onclick="updateDefaultSemester()">
                        <i class="fas fa-save"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤
                    </button>
                </div>

                <!-- Announcement System -->
                <div class="setting-item">
                    <h4>
                        <i class="fas fa-bullhorn"></i> ‡∏£‡∏∞‡∏ö‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç
                    </h4>
                    <p>‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏£‡∏π‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</p>
                    
                    <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 20px;">
                        <label class="toggle-switch">
                            <input type="checkbox" id="announcementToggle" onchange="updateAnnouncementStatus()">
                            <span class="toggle-slider" style="background-color: #059669;"></span>
                        </label>
                        <span class="status-badge unlocked" id="announcementStatus" style="background: #d1fae5; color: #059669;">
                            <i class="fas fa-bell-slash"></i> ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á
                        </span>
                    </div>

                    <div class="form-group" style="margin-bottom: 15px;">
                        <label>‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®</label>
                        <input type="text" id="announcementTitle" class="form-control" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô: ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏≠‡∏ô">
                    </div>

                    <div class="form-group" style="margin-bottom: 15px;">
                        <label>‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®</label>
                        <textarea id="announcementContent" class="announcement-textarea" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏Ñ‡∏£‡∏π...&#10;&#10;‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ç‡∏∂‡πâ‡∏ô‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£"></textarea>
                    </div>

                    <div style="display: flex; gap: 10px;">
                        <button class="btn-primary" onclick="saveAnnouncement()">
                            <i class="fas fa-save"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®
                        </button>
                        <button class="btn-icon" onclick="previewAnnouncement()" style="background: #f59e0b; color: white; padding: 10px 20px;">
                            <i class="fas fa-eye"></i> ‡∏î‡∏π‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á
                        </button>
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <button class="btn-icon" style="background: #f1f5f9;" onclick="closeAdminPanel()">‡∏õ‡∏¥‡∏î</button>
            </div>
        </div>
    </div>

    <!-- Teacher Form Modal -->
    <div id="teacherModal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-header">
                <div class="modal-title" id="modalTitle">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏£‡∏π‡πÉ‡∏´‡∏°‡πà</div>
                <button class="btn-close" onclick="closeModal()"><i class="fas fa-times"></i></button>
            </div>
            
            <input type="hidden" id="editId">
            
            <div class="form-grid">
                <div class="form-group">
                    <label>‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤</label>
                    <select id="tPrefix" class="form-control">
                        <option value="‡∏ô‡∏≤‡∏¢">‡∏ô‡∏≤‡∏¢</option>
                        <option value="‡∏ô‡∏≤‡∏á">‡∏ô‡∏≤‡∏á</option>
                        <option value="‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß">‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß</option>
                        <option value="‡∏ß‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏£‡πâ‡∏≠‡∏¢‡∏ï‡∏£‡∏µ">‡∏ß‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏£‡πâ‡∏≠‡∏¢‡∏ï‡∏£‡∏µ</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label>
                    <input type="text" id="tName" class="form-control" placeholder="‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏™‡πà‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤">
                </div>
                <div class="form-group">
                    <label>‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏≤‡∏£‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ</label>
                    <input type="text" id="tDept" class="form-control" list="deptList" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏≤‡∏£‡∏∞">
                    <datalist id="deptList">
                        <option value="‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢">
                        <option value="‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå">
                        <option value="‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡∏Ø">
                        <option value="‡∏™‡∏±‡∏á‡∏Ñ‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏Ø">
                        <option value="‡∏™‡∏∏‡∏Ç‡∏®‡∏∂‡∏Å‡∏©‡∏≤ ‡∏û‡∏•‡∏®‡∏∂‡∏Å‡∏©‡∏≤">
                        <option value="‡∏®‡∏¥‡∏•‡∏õ‡∏®‡∏∂‡∏Å‡∏©‡∏≤">
                        <option value="‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô‡∏≠‡∏≤‡∏ä‡∏µ‡∏û">
                        <option value="‡∏†‡∏≤‡∏©‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®">
                    </datalist>
                </div>
            </div>

            <div class="schedule-editor">
                <h4 style="margin-bottom: 10px; color: var(--primary);"><i class="fas fa-calendar-alt"></i> ‡∏•‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏≠‡∏ô‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ß‡∏¥‡∏ä‡∏≤</h4>
                <table class="sch-table">
                    <thead>
                        <tr>
                            <th>‡∏ß‡∏±‡∏ô / ‡∏Ñ‡∏≤‡∏ö</th>
                            <th>1</th><th>2</th><th>3</th><th>4</th>
                            <th style="background:#f1f5f9; color:#64748b;">‡∏û‡∏±‡∏Å</th>
                            <th>5</th><th>6</th><th>7</th>
                        </tr>
                    </thead>
                    <tbody id="scheduleBody"></tbody>
                </table>
            </div>

            <div class="modal-footer">
                <button class="btn-icon" style="background: #f1f5f9;" onclick="closeModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button class="btn-save" onclick="saveTeacher()"><i class="fas fa-save"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
            </div>
        </div>
    </div>

    <script>
        // --- 1. CONFIG & INIT ---
        const firebaseConfig = {
            apiKey: "AIzaSyCF7qDDxp6NXk3y7wLiySasqoviGyCKNNw",
            authDomain: "sornthan-fc0f1.firebaseapp.com",
            projectId: "sornthan-fc0f1",
            storageBucket: "sornthan-fc0f1.firebasestorage.app",
            messagingSenderId: "915683105444",
            appId: "1:915683105444:web:c1add040ea1afb344ae431"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let teachersData = [];
        const days = ['‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå', '‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£', '‡∏û‡∏∏‡∏ò', '‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ', '‡∏®‡∏∏‡∏Å‡∏£‡πå'];
        const ADMIN_PIN = '0000';
        let isSystemLocked = false;

        window.onload = function() {
            loadAdminSettings();
            renderScheduleTable();
            loadTeachers();
        }

        // --- 2. ADMIN FUNCTIONS ---

        async function loadAdminSettings() {
            try {
                // Load from Firebase
                const settingsDoc = await db.collection("system_settings").doc("config").get();
                
                if(settingsDoc.exists) {
                    const settings = settingsDoc.data();
                    isSystemLocked = settings.isLocked || false;
                    const defaultSemester = settings.defaultSemester || '2/2568';
                    
                    document.getElementById('semesterInput').value = defaultSemester;
                    updateUILockState();

                    // Check and show announcement
                    checkAndShowAnnouncement(settings);
                } else {
                    // Initialize with defaults
                    const defaultSemester = '2/2568';
                    document.getElementById('semesterInput').value = defaultSemester;
                    await db.collection("system_settings").doc("config").set({
                        isLocked: false,
                        defaultSemester: defaultSemester,
                        announcementEnabled: false,
                        announcementTitle: '',
                        announcementContent: '',
                        updated_at: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }
            } catch(e) {
                console.error("Error loading admin settings:", e);
                // Fallback to default
                document.getElementById('semesterInput').value = '2/2568';
            }
        }

        function updateUILockState() {
            const lockBanner = document.getElementById('lockBanner');
            const btnAddTeacher = document.getElementById('btnAddTeacher');
            const btnImport = document.getElementById('btnImport');
            const btnExport = document.getElementById('btnExport');
            
            if(isSystemLocked) {
                lockBanner.classList.add('active');
                btnAddTeacher.disabled = true;
                btnImport.disabled = true;
                // Keep export enabled
            } else {
                lockBanner.classList.remove('active');
                btnAddTeacher.disabled = false;
                btnImport.disabled = false;
            }

            // Update all edit/delete buttons
            document.querySelectorAll('.btn-edit, .btn-del').forEach(btn => {
                btn.disabled = isSystemLocked;
            });
        }

        function showAdminLogin() {
            document.getElementById('adminLoginModal').classList.add('show');
            setTimeout(() => document.getElementById('pin1').focus(), 100);
        }

        function closeAdminLogin() {
            document.getElementById('adminLoginModal').classList.remove('show');
            // Clear PIN
            ['pin1', 'pin2', 'pin3', 'pin4'].forEach(id => {
                document.getElementById(id).value = '';
            });
        }

        function moveToNext(current, nextId) {
            if(current.value.length === 1) {
                if(nextId) {
                    document.getElementById(nextId).focus();
                } else {
                    checkPin();
                }
            }
        }

        function handlePaste(e) {
            e.preventDefault();
            const paste = (e.clipboardData || window.clipboardData).getData('text');
            if(paste.length === 4 && /^\d{4}$/.test(paste)) {
                document.getElementById('pin1').value = paste[0];
                document.getElementById('pin2').value = paste[1];
                document.getElementById('pin3').value = paste[2];
                document.getElementById('pin4').value = paste[3];
                checkPin();
            }
        }

        function checkPin() {
            const pin = ['pin1', 'pin2', 'pin3', 'pin4']
                .map(id => document.getElementById(id).value)
                .join('');
            
            if(pin.length === 4) {
                verifyPin();
            }
        }

        async function verifyPin() {
            const pin = ['pin1', 'pin2', 'pin3', 'pin4']
                .map(id => document.getElementById(id).value)
                .join('');

            if(pin === ADMIN_PIN) {
                closeAdminLogin();
                await showAdminPanel();
            } else {
                Swal.fire({
                    icon: 'error',
                    title: '‡∏£‡∏´‡∏±‡∏™ PIN ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á',
                    text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á',
                    confirmButtonColor: '#ef4444'
                });
                // Clear PIN
                ['pin1', 'pin2', 'pin3', 'pin4'].forEach(id => {
                    document.getElementById(id).value = '';
                });
                document.getElementById('pin1').focus();
            }
        }

        async function showAdminPanel() {
            try {
                // Load current settings
                const settingsDoc = await db.collection("system_settings").doc("config").get();
                
                if(settingsDoc.exists) {
                    const settings = settingsDoc.data();
                    
                    // Lock settings
                    document.getElementById('systemLockToggle').checked = settings.isLocked || false;
                    updateLockStatusBadge();
                    
                    // Semester settings
                    document.getElementById('defaultSemesterInput').value = settings.defaultSemester || '2/2568';
                    
                    // Announcement settings
                    document.getElementById('announcementToggle').checked = settings.announcementEnabled || false;
                    document.getElementById('announcementTitle').value = settings.announcementTitle || '';
                    document.getElementById('announcementContent').value = settings.announcementContent || '';
                    updateAnnouncementStatus();
                }

                document.getElementById('adminPanelModal').classList.add('show');
            } catch(e) {
                console.error("Error loading admin panel:", e);
                Swal.fire('Error', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÑ‡∏î‡πâ', 'error');
            }
        }

        function closeAdminPanel() {
            document.getElementById('adminPanelModal').classList.remove('show');
        }

        async function updateSystemLock() {
            const isLocked = document.getElementById('systemLockToggle').checked;
            
            try {
                await db.collection("system_settings").doc("config").update({
                    isLocked: isLocked,
                    updated_at: firebase.firestore.FieldValue.serverTimestamp()
                });

                isSystemLocked = isLocked;
                updateLockStatusBadge();
                updateUILockState();

                Swal.fire({
                    icon: 'success',
                    title: isLocked ? '‡∏•‡πá‡∏≠‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß' : '‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß',
                    text: isLocked ? '‡∏Ñ‡∏£‡∏π‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ' : '‡∏Ñ‡∏£‡∏π‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ‡∏ï‡∏≤‡∏°‡∏õ‡∏Å‡∏ï‡∏¥',
                    timer: 2000,
                    showConfirmButton: false
                });
            } catch(e) {
                console.error("Error updating lock status:", e);
                Swal.fire('Error', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÑ‡∏î‡πâ', 'error');
            }
        }

        function updateLockStatusBadge() {
            const isLocked = document.getElementById('systemLockToggle').checked;
            const badge = document.getElementById('lockStatus');
            
            if(isLocked) {
                badge.className = 'status-badge locked';
                badge.innerHTML = '<i class="fas fa-lock"></i> ‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¢‡∏π‡πà';
            } else {
                badge.className = 'status-badge unlocked';
                badge.innerHTML = '<i class="fas fa-unlock"></i> ‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å';
            }
        }

        async function updateDefaultSemester() {
            const semester = document.getElementById('defaultSemesterInput').value.trim();
            
            if(!semester) {
                return Swal.fire('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏†‡∏≤‡∏Ñ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô', 'warning');
            }

            try {
                await db.collection("system_settings").doc("config").update({
                    defaultSemester: semester,
                    updated_at: firebase.firestore.FieldValue.serverTimestamp()
                });

                document.getElementById('semesterInput').value = semester;

                Swal.fire({
                    icon: 'success',
                    title: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
                    text: `‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏†‡∏≤‡∏Ñ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÄ‡∏õ‡πá‡∏ô ${semester} ‡πÅ‡∏•‡πâ‡∏ß`,
                    timer: 2000,
                    showConfirmButton: false
                });

                // Reload teachers with new semester
                loadTeachers();
            } catch(e) {
                console.error("Error updating default semester:", e);
                Swal.fire('Error', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÑ‡∏î‡πâ', 'error');
            }
        }

        // --- ANNOUNCEMENT FUNCTIONS ---

        function checkAndShowAnnouncement(settings) {
            const announcementEnabled = settings.announcementEnabled || false;
            const announcementTitle = settings.announcementTitle || '';
            const announcementContent = settings.announcementContent || '';

            if(!announcementEnabled || !announcementContent.trim()) {
                return; // Don't show if disabled or empty
            }

            // Check if user clicked "don't show today"
            const today = new Date().toDateString();
            const dontShowDate = localStorage.getItem('announcement_hidden_date');
            
            if(dontShowDate === today) {
                return; // Don't show if user opted out today
            }

            // Show announcement
            document.getElementById('announcementModalTitle').textContent = announcementTitle || '‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç';
            document.getElementById('announcementModalContent').textContent = announcementContent;
            
            setTimeout(() => {
                document.getElementById('announcementModal').classList.add('show');
            }, 500); // Delay 0.5s after page load
        }

        function closeAnnouncement() {
            const dontShow = document.getElementById('dontShowToday').checked;
            
            if(dontShow) {
                const today = new Date().toDateString();
                localStorage.setItem('announcement_hidden_date', today);
            }

            document.getElementById('announcementModal').classList.remove('show');
        }

        function updateAnnouncementStatus() {
            const isEnabled = document.getElementById('announcementToggle').checked;
            const badge = document.getElementById('announcementStatus');
            
            if(isEnabled) {
                badge.style.background = '#dbeafe';
                badge.style.color = '#2563eb';
                badge.innerHTML = '<i class="fas fa-bell"></i> ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á';
            } else {
                badge.style.background = '#d1fae5';
                badge.style.color = '#059669';
                badge.innerHTML = '<i class="fas fa-bell-slash"></i> ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á';
            }
        }

        async function saveAnnouncement() {
            const enabled = document.getElementById('announcementToggle').checked;
            const title = document.getElementById('announcementTitle').value.trim();
            const content = document.getElementById('announcementContent').value.trim();

            if(enabled && !content) {
                return Swal.fire('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®', 'warning');
            }

            try {
                await db.collection("system_settings").doc("config").update({
                    announcementEnabled: enabled,
                    announcementTitle: title,
                    announcementContent: content,
                    updated_at: firebase.firestore.FieldValue.serverTimestamp()
                });

                Swal.fire({
                    icon: 'success',
                    title: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
                    text: enabled ? '‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏£‡∏π‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö' : '‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡πÅ‡∏•‡πâ‡∏ß',
                    timer: 2000,
                    showConfirmButton: false
                });
            } catch(e) {
                console.error("Error saving announcement:", e);
                Swal.fire('Error', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡πÑ‡∏î‡πâ', 'error');
            }
        }

        function previewAnnouncement() {
            const title = document.getElementById('announcementTitle').value.trim() || '‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç';
            const content = document.getElementById('announcementContent').value.trim() || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®';

            document.getElementById('announcementModalTitle').textContent = title;
            document.getElementById('announcementModalContent').textContent = content;
            document.getElementById('dontShowToday').checked = false;
            
            document.getElementById('announcementModal').classList.add('show');
        }

        async function updateDefaultSemester() {
            const semester = document.getElementById('defaultSemesterInput').value.trim();
            
            if(!semester) {
                return Swal.fire('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏†‡∏≤‡∏Ñ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô', 'warning');
            }

            try {
                await db.collection("system_settings").doc("config").update({
                    defaultSemester: semester,
                    updated_at: firebase.firestore.FieldValue.serverTimestamp()
                });

                document.getElementById('semesterInput').value = semester;

                Swal.fire({
                    icon: 'success',
                    title: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
                    text: `‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏†‡∏≤‡∏Ñ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÄ‡∏õ‡πá‡∏ô ${semester} ‡πÅ‡∏•‡πâ‡∏ß`,
                    timer: 2000,
                    showConfirmButton: false
                });

                // Reload teachers with new semester
                loadTeachers();
            } catch(e) {
                console.error("Error updating default semester:", e);
                Swal.fire('Error', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÑ‡∏î‡πâ', 'error');
            }
        }

        // --- 3. MAIN FUNCTIONS ---
        
        async function loadTeachers() {
            const semester = document.getElementById('semesterInput').value.trim();
            const grid = document.getElementById('teacherGrid');
            const loader = document.getElementById('loadingState');
            
            grid.innerHTML = '';
            loader.style.display = 'block';

            try {
                const snap = await db.collection("teachers")
                    .where("semester", "==", semester)
                    .where("active", "==", true)
                    .get();

                teachersData = [];
                snap.forEach(doc => {
                    const data = doc.data();
                    data.id = doc.id;
                    teachersData.push(data);
                });

                teachersData.sort((a, b) => a.name.localeCompare(b.name, 'th'));

                loader.style.display = 'none';
                renderGrid(teachersData);

            } catch (error) {
                console.error("Error:", error);
                loader.style.display = 'none';
                grid.innerHTML = `<div style="grid-column: 1/-1; text-align: center; color: red;">
                    <h3>‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h3>
                    <p>${error.message}</p>
                </div>`;
            }
        }

        function renderGrid(data) {
            const grid = document.getElementById('teacherGrid');
            grid.innerHTML = '';

            if(data.length === 0) {
                grid.innerHTML = `<div style="grid-column: 1/-1; text-align: center; padding: 50px; color: #94a3b8;">
                    <i class="fas fa-user-slash" style="font-size: 3rem; margin-bottom: 10px;"></i>
                    <p>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏π‡πÉ‡∏ô‡∏†‡∏≤‡∏Ñ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ô‡∏µ‡πâ</p>
                </div>`;
                return;
            }

            data.forEach(t => {
                const card = document.createElement('div');
                card.className = 't-card';
                
                let scheduleHTML = '';
                const dayShortNames = ['‡∏à.', '‡∏≠.', '‡∏û.', '‡∏û‡∏§.', '‡∏®.'];
                days.forEach((day, index) => {
                    const periods = t.schedule[day] || [];
                    const count = periods.length;
                    const isEmpty = count === 0;
                    
                    scheduleHTML += `
                        <div class="day-col" title="${day}: ${isEmpty ? '‡∏ß‡πà‡∏≤‡∏á' : '‡∏™‡∏≠‡∏ô ' + count + ' ‡∏Ñ‡∏≤‡∏ö (‡∏Ñ‡∏≤‡∏ö ' + periods.join(', ') + ')'}">
                            <div class="day-label">${dayShortNames[index]}</div>
                            <div class="period-count ${isEmpty ? 'empty' : ''}">
                                ${isEmpty ? '<i class="fas fa-minus"></i>' : '<i class="fas fa-chalkboard-teacher"></i>'}
                                ${isEmpty ? '0' : count}
                            </div>
                        </div>
                    `;
                });

                const totalLoad = Object.values(t.schedule).flat().length;
                const disabled = isSystemLocked ? 'disabled' : '';

                card.innerHTML = `
                    <div class="t-header">
                        <div class="t-info">
                            <h3>${t.name}</h3>
                            <span class="t-dept-badge">${t.department}</span>
                            <p style="margin-top: 5px; font-size: 0.85rem;">
                                <i class="fas fa-clock"></i> ‡∏†‡∏≤‡∏£‡∏∞‡∏á‡∏≤‡∏ô: ${totalLoad} ‡∏Ñ‡∏≤‡∏ö/‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå
                            </p>
                        </div>
                        <div class="t-actions">
                            <button class="btn-edit" onclick="editTeacher('${t.id}')" ${disabled}><i class="fas fa-pencil-alt"></i></button>
                            <button class="btn-del" onclick="deleteTeacher('${t.id}', '${t.name}')" ${disabled}><i class="fas fa-trash-alt"></i></button>
                        </div>
                    </div>
                    <div class="schedule-mini">
                        ${scheduleHTML}
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        function filterTeachers() {
            const text = document.getElementById('searchInput').value.toLowerCase();
            const filtered = teachersData.filter(t => 
                t.name.toLowerCase().includes(text) || 
                t.department.toLowerCase().includes(text)
            );
            renderGrid(filtered);
        }

        // --- 4. MODAL & FORM LOGIC ---

        function renderScheduleTable() {
            const tbody = document.getElementById('scheduleBody');
            const gradeOptions = `
                <option value="">‡∏ä‡∏±‡πâ‡∏ô</option>
                <option value="‡∏°.1">‡∏°.1</option>
                <option value="‡∏°.2">‡∏°.2</option>
                <option value="‡∏°.3">‡∏°.3</option>
                <option value="‡∏°.4">‡∏°.4</option>
                <option value="‡∏°.5">‡∏°.5</option>
                <option value="‡∏°.6">‡∏°.6</option>
                <option value="‡∏°.1-6">‡∏°.1-6</option>
            `;

            tbody.innerHTML = days.map(day => {
                let cells = '';
                for(let p=1; p<=7; p++) {
                    cells += `
                        <td>
                            <div class="sch-cell" id="cell_${day}_${p}">
                                <input type="checkbox" class="cb-input" data-day="${day}" data-period="${p}" onchange="toggleCell(this)">
                                <div class="details-inputs">
                                    <input type="text" class="mini-input code-input" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ß‡∏¥‡∏ä‡∏≤">
                                    <select class="mini-select grade-input">
                                        ${gradeOptions}
                                    </select>
                                </div>
                            </div>
                        </td>
                    `;
                    if(p === 4) {
                        cells += `<td rowspan="1" style="padding:0;"><div class="lunch-col">‡∏û‡∏±‡∏Å‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏á</div></td>`;
                    }
                }
                return `<tr>
                    <td style="text-align:left; font-weight:bold; color:var(--primary);">${day}</td>
                    ${cells}
                </tr>`;
            }).join('');
        }

        function toggleCell(checkbox) {
            const cell = checkbox.closest('.sch-cell');
            if(checkbox.checked) {
                cell.classList.add('active');
            } else {
                cell.classList.remove('active');
                cell.querySelector('.code-input').value = '';
                cell.querySelector('.grade-input').value = '';
            }
        }

        function openModal() {
            if(isSystemLocked) {
                return Swal.fire('‡∏£‡∏∞‡∏ö‡∏ö‡∏ñ‡∏π‡∏Å‡∏•‡πá‡∏≠‡∏Å', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ‡πÉ‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ', 'warning');
            }

            document.getElementById('modalTitle').innerText = '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏£‡∏π‡πÉ‡∏´‡∏°‡πà';
            document.getElementById('editId').value = '';
            document.getElementById('tName').value = '';
            document.getElementById('tDept').value = '';
            document.getElementById('tPrefix').value = '‡∏ô‡∏≤‡∏¢';
            
            document.querySelectorAll('.cb-input').forEach(cb => {
                cb.checked = false;
                toggleCell(cb);
            });
            
            document.getElementById('teacherModal').classList.add('show');
        }

        function closeModal() {
            document.getElementById('teacherModal').classList.remove('show');
        }

        function editTeacher(id) {
            if(isSystemLocked) {
                return Swal.fire('‡∏£‡∏∞‡∏ö‡∏ö‡∏ñ‡∏π‡∏Å‡∏•‡πá‡∏≠‡∏Å', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ‡πÉ‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ', 'warning');
            }

            const t = teachersData.find(x => x.id === id);
            if(!t) return;

            document.getElementById('modalTitle').innerText = '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏π';
            document.getElementById('editId').value = id;
            
            const prefixes = ['‡∏ô‡∏≤‡∏¢', '‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß', '‡∏ô‡∏≤‡∏á', '‡∏ß‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏£‡πâ‡∏≠‡∏¢‡∏ï‡∏£‡∏µ'];
            let prefix = '‡∏ô‡∏≤‡∏¢';
            let name = t.name;
            for(let p of prefixes) {
                if(t.name.startsWith(p)) {
                    prefix = p;
                    name = t.name.substring(p.length).trim();
                    break;
                }
            }
            document.getElementById('tPrefix').value = prefix;
            document.getElementById('tName').value = name;
            document.getElementById('tDept').value = t.department;

            document.querySelectorAll('.cb-input').forEach(cb => {
                cb.checked = false;
                toggleCell(cb);
            });

            if(t.schedule) {
                Object.entries(t.schedule).forEach(([day, periods]) => {
                    periods.forEach(p => {
                        const cb = document.querySelector(`.cb-input[data-day="${day}"][data-period="${p}"]`);
                        if(cb) {
                            cb.checked = true;
                            toggleCell(cb);
                        }
                    });
                });
            }

            if(t.teachingDetails) {
                Object.entries(t.teachingDetails).forEach(([key, detail]) => {
                    const [day, p] = key.split('_');
                    const cell = document.getElementById(`cell_${day}_${p}`);
                    if(cell) {
                        cell.querySelector('.code-input').value = detail.code || '';
                        cell.querySelector('.grade-input').value = detail.grade || '';
                    }
                });
            }

            document.getElementById('teacherModal').classList.add('show');
        }

        async function saveTeacher() {
            if(isSystemLocked) {
                return Swal.fire('‡∏£‡∏∞‡∏ö‡∏ö‡∏ñ‡∏π‡∏Å‡∏•‡πá‡∏≠‡∏Å', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ‡πÉ‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ', 'warning');
            }

            const id = document.getElementById('editId').value;
            const prefix = document.getElementById('tPrefix').value;
            const nameRaw = document.getElementById('tName').value.trim();
            const dept = document.getElementById('tDept').value.trim();
            const semester = document.getElementById('semesterInput').value.trim();

            if(!nameRaw || !dept || !semester) {
                return Swal.fire('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠, ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏≤‡∏£‡∏∞ ‡πÅ‡∏•‡∏∞‡∏†‡∏≤‡∏Ñ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô', 'warning');
            }

            const fullName = prefix + nameRaw;
            
            const schedule = { "‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå": [], "‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£": [], "‡∏û‡∏∏‡∏ò": [], "‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ": [], "‡∏®‡∏∏‡∏Å‡∏£‡πå": [] };
            const teachingDetails = {};

            document.querySelectorAll('.cb-input:checked').forEach(cb => {
                const day = cb.dataset.day;
                const p = parseInt(cb.dataset.period);
                
                schedule[day].push(p);

                const cell = cb.closest('.sch-cell');
                const code = cell.querySelector('.code-input').value.trim();
                const grade = cell.querySelector('.grade-input').value;

                teachingDetails[`${day}_${p}`] = {
                    code: code,
                    grade: grade
                };
            });

            Object.keys(schedule).forEach(k => schedule[k].sort((a,b)=>a-b));

            const payload = {
                name: fullName,
                department: dept,
                schedule: schedule,
                teachingDetails: teachingDetails,
                semester: semester,
                active: true,
                updated_at: firebase.firestore.FieldValue.serverTimestamp()
            };

            try {
                if(id) {
                    await db.collection("teachers").doc(id).update(payload);
                    Swal.fire('‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
                } else {
                    payload.created_at = firebase.firestore.FieldValue.serverTimestamp();
                    await db.collection("teachers").add(payload);
                    Swal.fire('‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
                }
                closeModal();
                loadTeachers();
            } catch(e) {
                console.error(e);
                Swal.fire('Error', '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + e.message, 'error');
            }
        }

        async function deleteTeacher(id, name) {
            if(isSystemLocked) {
                return Swal.fire('‡∏£‡∏∞‡∏ö‡∏ö‡∏ñ‡∏π‡∏Å‡∏•‡πá‡∏≠‡∏Å', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ‡πÉ‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ', 'warning');
            }

            const result = await Swal.fire({
                title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö?',
                text: `‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ${name} ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#ef4444',
                confirmButtonText: '‡πÉ‡∏ä‡πà, ‡∏•‡∏ö‡πÄ‡∏•‡∏¢',
                cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
            });

            if(result.isConfirmed) {
                try {
                    await db.collection("teachers").doc(id).update({ active: false });
                    Swal.fire('‡∏•‡∏ö‡πÅ‡∏•‡πâ‡∏ß', '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success');
                    loadTeachers();
                } catch(e) {
                    Swal.fire('Error', '‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'error');
                }
            }
        }

        // --- 5. EXPORT / IMPORT ---
        function exportTeachers() {
            if(teachersData.length === 0) return Swal.fire('‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤', '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ Export', 'info');
            
            let csv = '\uFEFF‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤,‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•,‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏≤‡∏£‡∏∞,‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå,‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£,‡∏û‡∏∏‡∏ò,‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ,‡∏®‡∏∏‡∏Å‡∏£‡πå\n';
            teachersData.forEach(t => {
                const prefixes = ['‡∏ô‡∏≤‡∏¢', '‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß', '‡∏ô‡∏≤‡∏á', '‡∏ß‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏£‡πâ‡∏≠‡∏¢‡∏ï‡∏£‡∏µ'];
                let p = '', n = t.name;
                for(let pf of prefixes) if(t.name.startsWith(pf)) { p = pf; n = t.name.substring(pf.length).trim(); break; }
                
                const formatDay = (day) => {
                    const periods = t.schedule[day] || [];
                    const details = t.teachingDetails || {};
                    return periods.map(p => {
                        const d = details[`${day}_${p}`];
                        if(d && (d.code || d.grade)) {
                            return `${p}(${d.code || ''}-${d.grade || ''})`;
                        }
                        return p;
                    }).join(';');
                };

                csv += `${p},"${n}","${t.department}","${formatDay('‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå')}","${formatDay('‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£')}","${formatDay('‡∏û‡∏∏‡∏ò')}","${formatDay('‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ')}","${formatDay('‡∏®‡∏∏‡∏Å‡∏£‡πå')}"\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `teachers_${document.getElementById('semesterInput').value}.csv`;
            link.click();
        }

        function importTeachers(event) {
            if(isSystemLocked) {
                event.target.value = '';
                return Swal.fire('‡∏£‡∏∞‡∏ö‡∏ö‡∏ñ‡∏π‡∏Å‡∏•‡πá‡∏≠‡∏Å', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ‡πÉ‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ', 'warning');
            }

            const file = event.target.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = async (e) => {
                const lines = e.target.result.split('\n').filter(l => l.trim());
                if(lines.length < 2) return Swal.fire('Error', '‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', 'error');

                const semester = document.getElementById('semesterInput').value;
                let count = 0;

                for(let i=1; i<lines.length; i++) {
                    const cols = lines[i].split(',').map(c => c.replace(/^"|"$/g, '').trim());
                    if(cols.length < 3) continue;
                    
                    const [pf, nm, dp, d1, d2, d3, d4, d5] = cols;
                    
                    const parseSch = (str) => {
                        if(!str) return [];
                        return str.split(';').map(x => parseInt(x)).filter(x => !isNaN(x));
                    };

                    const sch = {
                        "‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå": parseSch(d1), "‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£": parseSch(d2), "‡∏û‡∏∏‡∏ò": parseSch(d3),
                        "‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ": parseSch(d4), "‡∏®‡∏∏‡∏Å‡∏£‡πå": parseSch(d5)
                    };
                    
                    try {
                        await db.collection("teachers").add({
                            name: pf+nm, department: dp, schedule: sch, semester: semester, active: true,
                            created_at: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        count++;
                    } catch(err) { console.error(err); }
                }
                Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', `‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ${count} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`, 'success');
                loadTeachers();
            };
            reader.readAsText(file);
            event.target.value = ''; 
        }

    </script>
</body>
</html>
