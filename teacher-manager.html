<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบจัดการข้อมูลครู - Teacher Management System</title>
    
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap');

        :root { 
            --primary: #2563eb; 
            --primary-dark: #1e40af;
            --secondary: #64748b;
            --success: #059669;
            --bg: #f8fafc; 
        }

        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; }
        body { font-family: 'Sarabun', sans-serif; background: var(--bg); color: #1e293b; padding-bottom: 50px; }

        /* --- Header --- */
        .navbar {
            background: white;
            padding: 15px 30px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .brand { display: flex; align-items: center; gap: 15px; }
        .brand h1 { font-size: 1.5rem; color: var(--primary-dark); font-weight: 700; }
        .brand span { font-size: 0.9rem; color: var(--secondary); }
        .back-btn { text-decoration: none; color: var(--secondary); font-weight: 600; display: flex; align-items: center; gap: 8px; padding: 8px 15px; border-radius: 8px; transition: all 0.2s; }
        .back-btn:hover { background: #e2e8f0; color: var(--primary); }

        /* --- Container --- */
        .container { max-width: 1300px; margin: 30px auto; padding: 0 20px; }

        /* --- Toolbar --- */
        .toolbar {
            background: white; padding: 20px; border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.03); margin-bottom: 30px;
            display: flex; flex-wrap: wrap; gap: 20px; align-items: center;
        }
        .search-box { flex-grow: 1; position: relative; }
        .search-box i { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: #94a3b8; }
        .search-input { width: 100%; padding: 12px 15px 12px 45px; border: 2px solid #e2e8f0; border-radius: 10px; font-family: 'Sarabun'; font-size: 1rem; transition: all 0.3s; }
        .search-input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); }

        .action-group { display: flex; gap: 10px; align-items: center; }
        
        button { border: none; cursor: pointer; font-family: 'Sarabun'; border-radius: 8px; transition: transform 0.2s, box-shadow 0.2s; }
        button:active { transform: scale(0.95); }

        .btn-add { background: linear-gradient(135deg, #2563eb, #1d4ed8); color: white; padding: 10px 20px; font-size: 1rem; font-weight: 600; display: flex; align-items: center; gap: 8px; box-shadow: 0 4px 15px rgba(37, 99, 235, 0.3); }
        .btn-add:hover { box-shadow: 0 6px 20px rgba(37, 99, 235, 0.4); transform: translateY(-2px); }
        .btn-icon { padding: 10px; background: #f1f5f9; color: #475569; border: 1px solid #e2e8f0; }
        .btn-icon:hover { background: #e2e8f0; color: var(--primary); }

        .semester-input { padding: 10px 15px; border-radius: 8px; border: 2px solid #e2e8f0; font-family: 'Sarabun'; width: 180px; text-align: center; font-weight: bold; color: var(--primary-dark); }
        .semester-input:focus { border-color: var(--primary); }

        /* --- Grid Layout --- */
        .teacher-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px; }
        .t-card { background: white; border-radius: 15px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.03); border: 1px solid #f1f5f9; transition: all 0.3s ease; position: relative; overflow: hidden; animation: fadeIn 0.5s ease forwards; }
        .t-card:hover { transform: translateY(-5px); box-shadow: 0 10px 25px rgba(0,0,0,0.08); border-color: var(--primary); }
        .t-card::before { content: ''; position: absolute; top: 0; left: 0; width: 6px; height: 100%; background: var(--primary); opacity: 0.5; }
        
        .t-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px; }
        .t-info h3 { font-size: 1.1rem; color: #1e293b; margin-bottom: 5px; font-weight: 700; }
        .t-info p { color: #64748b; font-size: 0.9rem; }
        .t-dept-badge { background: #eff6ff; color: var(--primary); padding: 4px 10px; border-radius: 20px; font-size: 0.8rem; font-weight: 600; display: inline-block; margin-top: 5px; }

        .t-actions { display: flex; gap: 8px; }
        .btn-edit { background: #f3f4f6; color: var(--primary); padding: 8px; border-radius: 50%; width: 35px; height: 35px; }
        .btn-del { background: #fef2f2; color: #ef4444; padding: 8px; border-radius: 50%; width: 35px; height: 35px; }

        .schedule-mini { display: flex; gap: 3px; margin-top: 15px; border-top: 1px dashed #e2e8f0; padding-top: 15px; }
        .day-col { flex: 1; text-align: center; }
        .day-label { font-size: 0.7rem; color: #94a3b8; margin-bottom: 4px; }
        .dot-container { display: flex; flex-direction: column; gap: 2px; align-items: center; height: 60px; justify-content: flex-end;}
        .dot { width: 6px; height: 6px; border-radius: 50%; background: #e2e8f0; }
        .dot.active { background: var(--success); }

        /* --- Modal --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); z-index: 1000; display: none; justify-content: center; align-items: center; opacity: 0; transition: opacity 0.3s; }
        .modal-overlay.show { display: flex; opacity: 1; }
        .modal-box { background: white; width: 950px; max-width: 98%; max-height: 95vh; border-radius: 20px; padding: 25px; box-shadow: 0 20px 50px rgba(0,0,0,0.2); transform: scale(0.8); transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); overflow-y: auto; display: flex; flex-direction: column; }
        .modal-overlay.show .modal-box { transform: scale(1); }

        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #e2e8f0; padding-bottom: 15px; }
        .modal-title { font-size: 1.4rem; color: var(--primary-dark); font-weight: 700; }
        .btn-close { background: none; font-size: 1.5rem; color: #94a3b8; padding: 0; }
        .btn-close:hover { color: #ef4444; transform: rotate(90deg); }

        .form-grid { display: grid; grid-template-columns: 1fr 2fr 2fr; gap: 15px; margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 6px; font-weight: 600; font-size: 0.9rem; color: #475569; }
        .form-control { width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 8px; font-family: 'Sarabun'; }
        .form-control:focus { border-color: var(--primary); outline: 3px solid rgba(37, 99, 235, 0.1); }

        .schedule-editor { background: #f8fafc; padding: 15px; border-radius: 12px; border: 1px solid #e2e8f0; overflow-x: auto; }
        .sch-table { width: 100%; border-collapse: separate; border-spacing: 0; }
        .sch-table th { padding: 8px; color: #64748b; font-weight: 600; font-size: 0.9rem; border-bottom: 2px solid #e2e8f0; background: white; position: sticky; top: 0; z-index: 10;}
        .sch-table td { padding: 8px; text-align: center; border-bottom: 1px solid #e2e8f0; vertical-align: top; }
        .sch-table tr:last-child td { border-bottom: none; }
        
        /* Cell Design */
        .sch-cell { min-width: 90px; height: 100px; background: white; border: 1px solid #e2e8f0; border-radius: 8px; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; padding: 5px; transition: all 0.2s; position: relative; }
        .sch-cell:hover { border-color: #cbd5e1; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .sch-cell.active { border-color: var(--primary); background: #eff6ff; }

        .lunch-col { background: #f1f5f9; writing-mode: vertical-rl; text-orientation: mixed; font-size: 0.85rem; color: #94a3b8; font-weight: 600; border-radius: 4px; padding: 0 10px; height: 100%; display: flex; align-items: center; justify-content: center; }

        /* Checkbox & Inputs */
        .cb-input { width: 20px; height: 20px; margin-bottom: 5px; cursor: pointer; accent-color: var(--primary); }
        .details-inputs { display: none; flex-direction: column; gap: 4px; width: 100%; animation: slideDown 0.2s; }
        .sch-cell.active .details-inputs { display: flex; }
        
        .mini-input { width: 100%; padding: 4px; border: 1px solid #cbd5e1; border-radius: 4px; font-size: 0.8rem; text-align: center; }
        .mini-select { width: 100%; padding: 4px; border: 1px solid #cbd5e1; border-radius: 4px; font-size: 0.8rem; background: white; }

        .modal-footer { margin-top: 20px; display: flex; justify-content: flex-end; gap: 15px; }
        .btn-save { background: var(--success); color: white; padding: 10px 30px; font-size: 1.1rem; }
        .btn-save:hover { background: #047857; box-shadow: 0 4px 15px rgba(5, 150, 105, 0.3); }

        /* Loading */
        .loading-state { text-align: center; padding: 50px; color: #94a3b8; display: none; }
        .spinner { width: 40px; height: 40px; border: 4px solid #e2e8f0; border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 15px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    </style>
</head>
<body>

    <nav class="navbar">
        <div class="brand">
            <img src="https://nonthaphathr.github.io/uploadimg/logosonthan.png" alt="Logo" width="45" style="border-radius: 8px;">
            <div>
                <h1>จัดการข้อมูลครู</h1>
                <span>ระบบบริหารจัดการข้อมูลครูและตารางสอน</span>
            </div>
        </div>
        <a href="index.html" class="back-btn">
            <i class="fas fa-home"></i> กลับหน้าหลัก
        </a>
    </nav>

    <div class="container">
        <div class="toolbar">
            <div class="search-box">
                <i class="fas fa-search"></i>
                <input type="text" id="searchInput" class="search-input" placeholder="ค้นหาชื่อครู, กลุ่มสาระ..." onkeyup="filterTeachers()">
            </div>
            
            <div class="action-group">
                <label style="font-size:0.9rem; font-weight:600; margin-right:5px;">ภาคเรียน:</label>
                <input type="text" id="semesterInput" class="semester-input" placeholder="ระบุภาคเรียน" onchange="saveSemesterPreference(); loadTeachers();">

                <button class="btn-icon" onclick="document.getElementById('importFile').click()" title="นำเข้า CSV">
                    <i class="fas fa-file-import"></i>
                </button>
                <input type="file" id="importFile" accept=".csv" style="display: none;" onchange="importTeachers(event)">

                <button class="btn-icon" onclick="exportTeachers()" title="ส่งออก CSV">
                    <i class="fas fa-file-export"></i>
                </button>

                <button class="btn-add" onclick="openModal()">
                    <i class="fas fa-plus-circle"></i> เพิ่มครูใหม่
                </button>
            </div>
        </div>

        <div id="loadingState" class="loading-state">
            <div class="spinner"></div>
            <p>กำลังโหลดข้อมูล...</p>
        </div>

        <div id="teacherGrid" class="teacher-grid">
            </div>
    </div>

    <div id="teacherModal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-header">
                <div class="modal-title" id="modalTitle">เพิ่มครูใหม่</div>
                <button class="btn-close" onclick="closeModal()"><i class="fas fa-times"></i></button>
            </div>
            
            <input type="hidden" id="editId">
            
            <div class="form-grid">
                <div class="form-group">
                    <label>คำนำหน้า</label>
                    <select id="tPrefix" class="form-control">
                        <option value="นาย">นาย</option>
                        <option value="นาง">นาง</option>
                        <option value="นางสาว">นางสาว</option>
                        <option value="ว่าที่ร้อยตรี">ว่าที่ร้อยตรี</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>ชื่อ-นามสกุล</label>
                    <input type="text" id="tName" class="form-control" placeholder="ไม่ต้องใส่คำนำหน้า">
                </div>
                <div class="form-group">
                    <label>กลุ่มสาระการเรียนรู้</label>
                    <input type="text" id="tDept" class="form-control" list="deptList" placeholder="ระบุกลุ่มสาระ">
                    <datalist id="deptList">
                        <option value="ภาษาไทย">
                        <option value="คณิตศาสตร์">
                        <option value="วิทยาศาสตร์ฯ">
                        <option value="สังคมศึกษาฯ">
                        <option value="สุขศึกษา พลศึกษา">
                        <option value="ศิลปศึกษา">
                        <option value="การงานอาชีพ">
                        <option value="ภาษาต่างประเทศ">
                    </datalist>
                </div>
            </div>

            <div class="schedule-editor">
                <h4 style="margin-bottom: 10px; color: var(--primary);"><i class="fas fa-calendar-alt"></i> ลงตารางสอนและรายละเอียดวิชา</h4>
                <table class="sch-table">
                    <thead>
                        <tr>
                            <th>วัน / คาบ</th>
                            <th>1</th><th>2</th><th>3</th><th>4</th>
                            <th style="background:#f1f5f9; color:#64748b;">พัก</th>
                            <th>5</th><th>6</th><th>7</th>
                        </tr>
                    </thead>
                    <tbody id="scheduleBody">
                        </tbody>
                </table>
            </div>

            <div class="modal-footer">
                <button class="btn-icon" style="background: #f1f5f9;" onclick="closeModal()">ยกเลิก</button>
                <button class="btn-save" onclick="saveTeacher()"><i class="fas fa-save"></i> บันทึกข้อมูล</button>
            </div>
        </div>
    </div>

    <script>
        // --- 1. CONFIG & INIT ---
        const firebaseConfig = {
            apiKey: "AIzaSyCF7qDDxp6NXk3y7wLiySasqoviGyCKNNw",
            authDomain: "sornthan-fc0f1.firebaseapp.com",
            projectId: "sornthan-fc0f1",
            storageBucket: "sornthan-fc0f1.firebasestorage.app",
            messagingSenderId: "915683105444",
            appId: "1:915683105444:web:c1add040ea1afb344ae431"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let teachersData = [];
        const days = ['จันทร์', 'อังคาร', 'พุธ', 'พฤหัสบดี', 'ศุกร์'];

        window.onload = function() {
            // Load saved semester or default
            const savedSemester = localStorage.getItem('currentSemester') || '1/2567';
            document.getElementById('semesterInput').value = savedSemester;

            renderScheduleTable();
            loadTeachers();
        }

        function saveSemesterPreference() {
            const val = document.getElementById('semesterInput').value;
            localStorage.setItem('currentSemester', val);
        }

        // --- 2. MAIN FUNCTIONS ---
        
        async function loadTeachers() {
            const semester = document.getElementById('semesterInput').value.trim();
            const grid = document.getElementById('teacherGrid');
            const loader = document.getElementById('loadingState');
            
            grid.innerHTML = '';
            loader.style.display = 'block';

            try {
                // Remove orderBy to prevent index error on initial load
                const snap = await db.collection("teachers")
                    .where("semester", "==", semester)
                    .where("active", "==", true)
                    .get();

                teachersData = [];
                snap.forEach(doc => {
                    const data = doc.data();
                    data.id = doc.id;
                    teachersData.push(data);
                });

                // Sort using JS instead
                teachersData.sort((a, b) => a.name.localeCompare(b.name, 'th'));

                loader.style.display = 'none';
                renderGrid(teachersData);

            } catch (error) {
                console.error("Error:", error);
                loader.style.display = 'none';
                grid.innerHTML = `<div style="grid-column: 1/-1; text-align: center; color: red;">
                    <h3>เกิดข้อผิดพลาดในการโหลดข้อมูล</h3>
                    <p>${error.message}</p>
                </div>`;
            }
        }

        function renderGrid(data) {
            const grid = document.getElementById('teacherGrid');
            grid.innerHTML = '';

            if(data.length === 0) {
                grid.innerHTML = `<div style="grid-column: 1/-1; text-align: center; padding: 50px; color: #94a3b8;">
                    <i class="fas fa-user-slash" style="font-size: 3rem; margin-bottom: 10px;"></i>
                    <p>ไม่พบข้อมูลครูในภาคเรียนนี้</p>
                </div>`;
                return;
            }

            data.forEach(t => {
                const card = document.createElement('div');
                card.className = 't-card';
                
                // Visual Schedule Dots
                let scheduleHTML = '';
                days.forEach(day => {
                    const periods = t.schedule[day] || []; // Array of periods e.g. [1, 2]
                    let dotHtml = '';
                    // Create 7 dots placeholder
                    // Simple logic: if array includes period, show active dot
                    const activeCount = periods.length;
                    
                    scheduleHTML += `
                        <div class="day-col">
                            <div class="dot-container">
                                ${Array.from({length: activeCount}).map(() => `<div class="dot active"></div>`).join('')}
                                ${Array.from({length: Math.max(0, 5-activeCount)}).map(() => `<div class="dot"></div>`).join('')}
                            </div>
                            <div class="day-label">${day}</div>
                        </div>
                    `;
                });

                const totalLoad = Object.values(t.schedule).flat().length;

                card.innerHTML = `
                    <div class="t-header">
                        <div class="t-info">
                            <h3>${t.name}</h3>
                            <span class="t-dept-badge">${t.department}</span>
                            <p style="margin-top: 5px; font-size: 0.85rem;">
                                <i class="fas fa-clock"></i> ภาระงาน: ${totalLoad} คาบ/สัปดาห์
                            </p>
                        </div>
                        <div class="t-actions">
                            <button class="btn-edit" onclick="editTeacher('${t.id}')"><i class="fas fa-pencil-alt"></i></button>
                            <button class="btn-del" onclick="deleteTeacher('${t.id}', '${t.name}')"><i class="fas fa-trash-alt"></i></button>
                        </div>
                    </div>
                    <div class="schedule-mini">
                        ${scheduleHTML}
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        function filterTeachers() {
            const text = document.getElementById('searchInput').value.toLowerCase();
            const filtered = teachersData.filter(t => 
                t.name.toLowerCase().includes(text) || 
                t.department.toLowerCase().includes(text)
            );
            renderGrid(filtered);
        }

        // --- 3. MODAL & FORM LOGIC ---

        function renderScheduleTable() {
            const tbody = document.getElementById('scheduleBody');
            const gradeOptions = `
                <option value="">ชั้น</option>
                <option value="ม.1">ม.1</option>
                <option value="ม.2">ม.2</option>
                <option value="ม.3">ม.3</option>
                <option value="ม.4">ม.4</option>
                <option value="ม.5">ม.5</option>
                <option value="ม.6">ม.6</option>
                <option value="ม.1-6">ม.1-6</option>
            `;

            tbody.innerHTML = days.map(day => {
                let cells = '';
                for(let p=1; p<=7; p++) {
                    cells += `
                        <td>
                            <div class="sch-cell" id="cell_${day}_${p}">
                                <input type="checkbox" class="cb-input" data-day="${day}" data-period="${p}" onchange="toggleCell(this)">
                                <div class="details-inputs">
                                    <input type="text" class="mini-input code-input" placeholder="รหัสวิชา">
                                    <select class="mini-select grade-input">
                                        ${gradeOptions}
                                    </select>
                                </div>
                            </div>
                        </td>
                    `;
                    // Insert Lunch break after period 4
                    if(p === 4) {
                        cells += `<td rowspan="1" style="padding:0;"><div class="lunch-col">พักเที่ยง</div></td>`;
                    }
                }
                return `<tr>
                    <td style="text-align:left; font-weight:bold; color:var(--primary);">${day}</td>
                    ${cells}
                </tr>`;
            }).join('');
        }

        function toggleCell(checkbox) {
            const cell = checkbox.closest('.sch-cell');
            if(checkbox.checked) {
                cell.classList.add('active');
            } else {
                cell.classList.remove('active');
                // Clear inputs
                cell.querySelector('.code-input').value = '';
                cell.querySelector('.grade-input').value = '';
            }
        }

        function openModal() {
            document.getElementById('modalTitle').innerText = 'เพิ่มครูใหม่';
            document.getElementById('editId').value = '';
            document.getElementById('tName').value = '';
            document.getElementById('tDept').value = '';
            document.getElementById('tPrefix').value = 'นาย';
            
            // Clear inputs
            document.querySelectorAll('.cb-input').forEach(cb => {
                cb.checked = false;
                toggleCell(cb);
            });
            
            const modal = document.getElementById('teacherModal');
            modal.classList.add('show');
        }

        function closeModal() {
            document.getElementById('teacherModal').classList.remove('show');
        }

        function editTeacher(id) {
            const t = teachersData.find(x => x.id === id);
            if(!t) return;

            document.getElementById('modalTitle').innerText = 'แก้ไขข้อมูลครู';
            document.getElementById('editId').value = id;
            
            // Parse Name
            const prefixes = ['นาย', 'นางสาว', 'นาง', 'ว่าที่ร้อยตรี'];
            let prefix = 'นาย';
            let name = t.name;
            for(let p of prefixes) {
                if(t.name.startsWith(p)) {
                    prefix = p;
                    name = t.name.substring(p.length).trim();
                    break;
                }
            }
            document.getElementById('tPrefix').value = prefix;
            document.getElementById('tName').value = name;
            document.getElementById('tDept').value = t.department;

            // Clear first
            document.querySelectorAll('.cb-input').forEach(cb => {
                cb.checked = false;
                toggleCell(cb);
            });

            // Set Data
            // t.schedule is object: {"จันทร์": [1,2]} (Backward compatible)
            // t.teachingDetails is object: {"จันทร์_1": {code: "xxx", grade: "yyy"}}
            
            // Loop checkbox to set busy periods
            if(t.schedule) {
                Object.entries(t.schedule).forEach(([day, periods]) => {
                    periods.forEach(p => {
                        const cb = document.querySelector(`.cb-input[data-day="${day}"][data-period="${p}"]`);
                        if(cb) {
                            cb.checked = true;
                            toggleCell(cb);
                        }
                    });
                });
            }

            // Loop details to set inputs
            if(t.teachingDetails) {
                Object.entries(t.teachingDetails).forEach(([key, detail]) => {
                    // key is "Day_Period" e.g. "จันทร์_1"
                    const [day, p] = key.split('_');
                    const cell = document.getElementById(`cell_${day}_${p}`);
                    if(cell) {
                        cell.querySelector('.code-input').value = detail.code || '';
                        cell.querySelector('.grade-input').value = detail.grade || '';
                    }
                });
            }

            document.getElementById('teacherModal').classList.add('show');
        }

        async function saveTeacher() {
            const id = document.getElementById('editId').value;
            const prefix = document.getElementById('tPrefix').value;
            const nameRaw = document.getElementById('tName').value.trim();
            const dept = document.getElementById('tDept').value.trim();
            const semester = document.getElementById('semesterInput').value.trim();

            if(!nameRaw || !dept || !semester) {
                return Swal.fire('ข้อมูลไม่ครบ', 'กรุณากรอกชื่อ, กลุ่มสาระ และภาคเรียน', 'warning');
            }

            const fullName = prefix + nameRaw;
            
            // Prepare Data Structure
            // 1. schedule: For existing system compatibility (Array of periods)
            // 2. teachingDetails: For new features (Code & Grade)
            const schedule = { "จันทร์": [], "อังคาร": [], "พุธ": [], "พฤหัสบดี": [], "ศุกร์": [] };
            const teachingDetails = {};

            document.querySelectorAll('.cb-input:checked').forEach(cb => {
                const day = cb.dataset.day;
                const p = parseInt(cb.dataset.period);
                
                // Add to schedule array
                schedule[day].push(p);

                // Get Details
                const cell = cb.closest('.sch-cell');
                const code = cell.querySelector('.code-input').value.trim();
                const grade = cell.querySelector('.grade-input').value;

                // Add to details object
                teachingDetails[`${day}_${p}`] = {
                    code: code,
                    grade: grade
                };
            });

            // Sort schedule arrays
            Object.keys(schedule).forEach(k => schedule[k].sort((a,b)=>a-b));

            const payload = {
                name: fullName,
                department: dept,
                schedule: schedule,
                teachingDetails: teachingDetails, // New Field
                semester: semester,
                active: true,
                updated_at: firebase.firestore.FieldValue.serverTimestamp()
            };

            try {
                if(id) {
                    await db.collection("teachers").doc(id).update(payload);
                    Swal.fire('เรียบร้อย', 'แก้ไขข้อมูลสำเร็จ', 'success');
                } else {
                    payload.created_at = firebase.firestore.FieldValue.serverTimestamp();
                    await db.collection("teachers").add(payload);
                    Swal.fire('เรียบร้อย', 'เพิ่มข้อมูลสำเร็จ', 'success');
                }
                closeModal();
                loadTeachers();
            } catch(e) {
                console.error(e);
                Swal.fire('Error', 'บันทึกข้อมูลไม่สำเร็จ: ' + e.message, 'error');
            }
        }

        async function deleteTeacher(id, name) {
            const result = await Swal.fire({
                title: 'ยืนยันการลบ?',
                text: `ต้องการลบข้อมูล ${name} ใช่หรือไม่?`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#ef4444',
                confirmButtonText: 'ใช่, ลบเลย',
                cancelButtonText: 'ยกเลิก'
            });

            if(result.isConfirmed) {
                try {
                    await db.collection("teachers").doc(id).update({ active: false });
                    Swal.fire('ลบแล้ว', 'ข้อมูลถูกลบเรียบร้อย', 'success');
                    loadTeachers();
                } catch(e) {
                    Swal.fire('Error', 'ลบข้อมูลไม่สำเร็จ', 'error');
                }
            }
        }

        // --- 4. EXPORT / IMPORT ---
        function exportTeachers() {
            if(teachersData.length === 0) return Swal.fire('ว่างเปล่า', 'ไม่มีข้อมูลให้ Export', 'info');
            
            let csv = '\uFEFFคำนำหน้า,ชื่อ-นามสกุล,กลุ่มสาระ,จันทร์,อังคาร,พุธ,พฤหัสบดี,ศุกร์\n';
            teachersData.forEach(t => {
                const prefixes = ['นาย', 'นางสาว', 'นาง', 'ว่าที่ร้อยตรี'];
                let p = '', n = t.name;
                for(let pf of prefixes) if(t.name.startsWith(pf)) { p = pf; n = t.name.substring(pf.length).trim(); break; }
                
                // Helper to format day schedule
                const formatDay = (day) => {
                    const periods = t.schedule[day] || [];
                    const details = t.teachingDetails || {};
                    return periods.map(p => {
                        const d = details[`${day}_${p}`];
                        if(d && (d.code || d.grade)) {
                            return `${p}(${d.code || ''}-${d.grade || ''})`;
                        }
                        return p;
                    }).join(';');
                };

                csv += `${p},"${n}","${t.department}","${formatDay('จันทร์')}","${formatDay('อังคาร')}","${formatDay('พุธ')}","${formatDay('พฤหัสบดี')}","${formatDay('ศุกร์')}"\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `teachers_${document.getElementById('semesterInput').value}.csv`;
            link.click();
        }

        function importTeachers(event) {
            const file = event.target.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = async (e) => {
                const lines = e.target.result.split('\n').filter(l => l.trim());
                if(lines.length < 2) return Swal.fire('Error', 'ไฟล์ไม่ถูกต้อง', 'error');

                const semester = document.getElementById('semesterInput').value;
                let count = 0;

                for(let i=1; i<lines.length; i++) {
                    const cols = lines[i].split(',').map(c => c.replace(/^"|"$/g, '').trim());
                    if(cols.length < 3) continue;
                    
                    const [pf, nm, dp, d1, d2, d3, d4, d5] = cols;
                    
                    // Simple Parsing (Only periods) - Advanced parsing for code/grade from CSV requires complex regex
                    // For now, importing restores basic schedule structure
                    const parseSch = (str) => {
                        if(!str) return [];
                        // Supports "1;2;3" or "1(TH101-M.1);2" format
                        return str.split(';').map(x => parseInt(x)).filter(x => !isNaN(x));
                    };

                    const sch = {
                        "จันทร์": parseSch(d1), "อังคาร": parseSch(d2), "พุธ": parseSch(d3),
                        "พฤหัสบดี": parseSch(d4), "ศุกร์": parseSch(d5)
                    };
                    
                    try {
                        await db.collection("teachers").add({
                            name: pf+nm, department: dp, schedule: sch, semester: semester, active: true,
                            created_at: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        count++;
                    } catch(err) { console.error(err); }
                }
                Swal.fire('สำเร็จ', `นำเข้าข้อมูล ${count} รายการ`, 'success');
                loadTeachers();
            };
            reader.readAsText(file);
            event.target.value = ''; 
        }

    </script>
</body>
</html>
